<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mill Roll Quotation Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Serif+4:wght@300;400;600;700&family=Barlow+Condensed:wght@400;600;700&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#1a1212;
  --accent:#8b0000;
  --accent2:#c0392b;
  --steel:#1a3a5c;
  --gold:#b8860b;
  --warm:#faf8f5;
  --lgray:#e8e4de;
  --mgray:#d0cbc3;
  --dgray:#888;
  --panel:#0f0f0f;
  --panel2:#181818;
  --panel3:#232323;
  --amber:#d4802a;
  --silver:#c0c8d0;

  /* Table header colors */
  --th-main-bg: #1a1212;
  --th-main-fg: #faf8f5;
  --th-main-fs: 10px;
  --tb-fg: #1a1212;
  --tb-border: #d0cbc3;
  --tb-accent: #8b0000;

  /* Font settings ‚Äî adjustable */
  --fs-base: 13px;
  --fs-sm: 11px;
  --fs-xs: 10px;
  --fs-sum: 14px;
  --fw-body: 400;
  --fw-label: 600;
  --fw-head: 700;
  --lh: 1.55;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:#b0aba3;color:var(--ink);min-height:100vh;padding:12px;-webkit-text-size-adjust:100%;font-size:var(--fs-base);line-height:var(--lh);}

/* ‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê */
#SP{max-width:1100px;margin:0 auto 14px;border-radius:4px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,.55);}
.stbar{background:#000;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;}
.stbar h2{font-family:'Barlow Condensed',sans-serif;letter-spacing:3px;font-size:.82rem;color:var(--amber);text-transform:uppercase;}
.sbadge{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:2px;padding:2px 8px;font-size:.55rem;letter-spacing:2px;color:#444;text-transform:uppercase;}
.sarr{color:var(--amber);font-size:.8rem;transition:transform .3s;}
.sarr.closed{transform:rotate(180deg);}
.stabs{background:#0a0a0a;display:flex;border-bottom:1px solid #1e1e1e;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.stab{padding:8px 14px;font-family:'Barlow Condensed',sans-serif;font-size:.65rem;letter-spacing:2px;text-transform:uppercase;color:#444;cursor:pointer;border-bottom:2px solid transparent;transition:.2s;white-space:nowrap;flex-shrink:0;}
.stab.active{color:var(--amber);border-bottom-color:var(--amber);}
.stab:hover{color:#aaa;}
.sbody{background:#111;padding:14px 16px 18px;}
.sbody.hide{display:none;}
.spane{display:none;}.spane.active{display:block;}
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;}
.sg{background:#1c1c1c;border:1px solid #2a2a2a;border-radius:3px;padding:10px;}
.sgt{font-family:'Barlow Condensed',sans-serif;font-size:.58rem;letter-spacing:3px;text-transform:uppercase;color:var(--amber);margin-bottom:7px;border-bottom:1px solid #2a2a2a;padding-bottom:3px;}
.sf{display:flex;flex-direction:column;gap:2px;margin-bottom:6px;}.sf:last-child{margin-bottom:0;}
.sf label{font-size:.53rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--silver);}
.sf input,.sf textarea,.sf select{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.78rem;padding:4px 7px;outline:none;width:100%;}
.sf textarea{resize:vertical;min-height:55px;line-height:1.5;}
.sf input:focus,.sf textarea:focus{border-color:var(--accent);}
.lbtn{background:var(--accent);color:#fff;border:none;padding:5px 0;font-family:'Barlow Condensed',sans-serif;font-size:.72rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border-radius:2px;width:100%;margin-top:2px;}
.lbtn:hover{background:#6b0000;}
.lbtn.rem{background:#2a2a2a;color:#666;margin-top:4px;}.lbtn.rem:hover{background:#333;color:#aaa;}
.swide{grid-column:1/-1;}
.abar{display:flex;gap:7px;flex-wrap:wrap;padding-top:8px;}
.btn{padding:7px 15px;font-family:'Barlow Condensed',sans-serif;font-size:.78rem;letter-spacing:2px;text-transform:uppercase;border:none;cursor:pointer;border-radius:2px;font-weight:600;}
.btn-pdf{background:var(--accent);color:#fff;}.btn-pdf:hover{background:#6b0000;}
.btn-print{background:var(--steel);color:#fff;}.btn-print:hover{background:#122a45;}
.btn-rf{background:#2a2a2a;color:#666;}.btn-rf:hover{background:#333;color:#aaa;}
.btn-rs{background:#1a1a1a;color:#333;border:1px solid #2a2a2a;}.btn-rs:hover{background:#222;color:#aaa;}
.btn-share{background:#1e3a2a;color:#4caf50;border:1px solid #2a5c3a;}.btn-share:hover{background:#244d33;}
.btn-link{background:#1a2a3a;color:#4a9fd4;border:1px solid #2a4a6a;}.btn-link:hover{background:#1e3348;}
.btn-link.copied{background:#2a3a1a;color:#8bc34a;border-color:#4a6a2a;}
.sdot{width:6px;height:6px;border-radius:50%;background:#4caf50;display:inline-block;margin-left:6px;opacity:0;transition:opacity .3s;}
.sdot.show{opacity:1;}
/* toggles */
.tsw{position:relative;width:30px;height:16px;flex-shrink:0;}
.tsw input{opacity:0;width:0;height:0;}
.tsl{position:absolute;inset:0;background:#333;border-radius:16px;cursor:pointer;transition:.22s;}
.tsl:before{content:'';position:absolute;width:10px;height:10px;left:3px;top:3px;background:#666;border-radius:50%;transition:.22s;}
.tsw input:checked+.tsl{background:var(--steel);}
.tsw input:checked+.tsl:before{transform:translateX(14px);background:#fff;}
/* col manager */
.clist{display:flex;flex-direction:column;gap:4px;margin-top:4px;}
.citem{display:flex;align-items:center;gap:6px;background:#242424;border:1px solid #2e2e2e;border-radius:2px;padding:5px 8px;cursor:grab;user-select:none;transition:background .12s;}
.citem:active{cursor:grabbing;}
.citem.dragging{opacity:.3;}.citem.drag-over{border-color:var(--amber);}
.cdh{color:#333;font-size:.8rem;flex-shrink:0;}
.cname{flex:1;font-size:.63rem;letter-spacing:1.5px;text-transform:uppercase;color:#aaa;}
.cbadge{font-size:.52rem;color:#444;margin-right:3px;}
/* width grid */
.wgrid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.wf{display:flex;flex-direction:column;gap:1px;}
.wf label{font-size:.52rem;letter-spacing:1.5px;text-transform:uppercase;color:#555;}
.wf input{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.73rem;padding:3px 6px;outline:none;width:100%;}
.wf input:focus{border-color:var(--accent);}
/* totals manager */
.trows-mgr{display:flex;flex-direction:column;gap:4px;margin-top:4px;}
.trow-item{display:flex;align-items:center;gap:6px;background:#242424;border:1px solid #2e2e2e;border-radius:2px;padding:6px 9px;cursor:grab;user-select:none;}
.trow-item:active{cursor:grabbing;}
.trow-item.drag-over{border-color:var(--amber);}
.trow-item input.trow-label-inp{flex:1;background:#1a1a1a;border:1px solid #2e2e2e;border-radius:2px;color:#bbb;font-family:'Barlow',sans-serif;font-size:.76rem;padding:3px 5px;outline:none;}
.trow-item input.trow-label-inp:focus{border-color:var(--accent);}
.trow-del{background:none;border:none;color:#333;cursor:pointer;font-size:.78rem;}.trow-del:hover{color:var(--accent);}
/* custom col manager */
.custom-col-list{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;}
.cc-item{display:flex;align-items:center;gap:6px;background:#242424;border:1px solid #2e2e2e;border-radius:2px;padding:6px 9px;}
.cc-item input{background:#1a1a1a;border:1px solid #2e2e2e;border-radius:2px;color:#bbb;font-family:'Barlow',sans-serif;font-size:.75rem;padding:3px 5px;outline:none;}
.cc-item input:focus{border-color:var(--accent);}
.cc-del{background:none;border:none;color:#333;cursor:pointer;font-size:.85rem;}.cc-del:hover{color:var(--accent);}
.add-cc-btn,.add-tr-btn{background:#1e1e1e;border:1px dashed #3a3a3a;color:#666;border-radius:2px;padding:5px 12px;font-family:'Barlow Condensed',sans-serif;font-size:.68rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;margin-top:5px;}
.add-cc-btn:hover,.add-tr-btn:hover{background:#272727;color:#aaa;}
/* font panel */
.font-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.font-grid .sg{padding:10px;}
.fslider{display:flex;align-items:center;gap:7px;}
.fslider input[type=range]{flex:1;accent-color:var(--amber);}
.fslider span{font-size:.68rem;color:#aaa;min-width:30px;text-align:right;}
/* terms manager */
.terms-list{display:flex;flex-direction:column;gap:5px;margin-bottom:8px;}
.ti-item{display:flex;align-items:center;gap:6px;background:#1e1e1e;border:1px solid #2e2e2e;border-radius:2px;padding:5px 8px;}
.ti-item input{flex:1;background:#141414;border:1px solid #2e2e2e;border-radius:2px;color:#ccc;font-family:'Barlow',sans-serif;font-size:.75rem;padding:3px 5px;outline:none;}
.ti-item input:focus{border-color:var(--accent);}
.ti-del{background:none;border:none;color:#333;cursor:pointer;font-size:.82rem;}.ti-del:hover{color:var(--accent);}
.add-ti-btn{background:#1e1e1e;border:1px dashed #3a3a3a;color:#666;border-radius:2px;padding:5px 12px;font-family:'Barlow Condensed',sans-serif;font-size:.67rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;margin-top:4px;}
.add-ti-btn:hover{background:#272727;color:#aaa;}
/* section toggle row in settings */
.sec-toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.sec-toggle-row label:first-child{font-size:.53rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--silver);}
/* hidden doc section */
.sec-hidden{display:none!important;}
/* color picker row */
.cprow{display:flex;flex-direction:column;gap:2px;margin-bottom:7px;}
.cprow:last-child{margin-bottom:0;}
.cprow label{font-size:.52rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--silver);}
.cprow-inner{display:flex;align-items:center;gap:7px;}
.cprow-inner input[type=color]{width:34px;height:26px;border:1px solid #363636;border-radius:2px;background:#232323;cursor:pointer;padding:1px 2px;}
.cprow-inner span{font-size:.72rem;color:#aaa;font-family:'Barlow Condensed',sans-serif;}

/* ‚ïê‚ïê‚ïê DOCUMENT ‚ïê‚ïê‚ïê */
#QD{background:var(--warm);max-width:1100px;margin:0 auto;box-shadow:0 6px 36px rgba(0,0,0,.28);overflow:hidden;font-size:var(--fs-base);}

/* HEADER */
.doc-header{padding:16px 22px 12px;border-bottom:2px solid var(--ink);}
.header-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;}
.company-block{flex:1;}
.company-name-wrap{display:flex;align-items:baseline;gap:8px;margin-bottom:2px;}
#dc-big{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--ink);line-height:1;letter-spacing:-0.5px;}
#dc-big span{color:var(--accent);}
#dc-tag{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:5px;}
.addr-block{font-size:.72rem;color:#444;line-height:1.65;margin-top:4px;}
.addr-block .lbl{font-weight:600;color:#222;display:inline-block;min-width:52px;}
.cert-block{display:flex;flex-direction:column;align-items:center;text-align:center;gap:6px;min-width:140px;}
.cert-badges{display:flex;gap:6px;justify-content:center;}
.cert-badge{border:2px solid var(--ink);border-radius:2px;padding:3px 7px;font-family:'Barlow Condensed',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--ink);background:transparent;}
.logo-area{display:flex;justify-content:center;align-items:center;margin-top:4px;}
#logo-display{max-width:88px;max-height:72px;object-fit:contain;display:none;}
#logo-ph{width:72px;height:72px;background:var(--ink);border-radius:50%;display:flex;align-items:center;justify-content:center;}
#logo-ph svg{opacity:.4;}
.pioneer-text{font-family:'Barlow Condensed',sans-serif;font-size:.55rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--ink);text-align:center;border-top:1px solid var(--ink);padding-top:4px;margin-top:2px;}

.doc-meta{background:var(--ink);display:grid;grid-template-columns:repeat(4,1fr);}
.mc{padding:7px 14px;border-right:1px solid rgba(255,255,255,.08);}
.mc:last-child{border-right:none;}
.mc label{display:block;font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:2px;}
.mc input{background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,.18);color:#fff;font-family:'Barlow',sans-serif;font-size:.8rem;width:100%;outline:none;padding:2px 0;}
.mc input::placeholder{color:rgba(255,255,255,.22);}

/* DOC BODY */
.dbody{padding:18px 22px;}

.doc-date-line{font-size:var(--fs-sm);margin-bottom:10px;}
.doc-date-line input{border:none;border-bottom:1px solid #ccc;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);outline:none;color:var(--ink);padding:1px 0;width:120px;}

.customer-block{margin-bottom:12px;}
.customer-block .cust-field{font-size:var(--fs-base);font-weight:var(--fw-label);color:var(--ink);}
.customer-block input.cust-in{border:none;border-bottom:1px solid #bbb;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-base);font-weight:var(--fw-label);outline:none;color:var(--ink);padding:1px 0;width:260px;}
.customer-block .org-in{font-size:var(--fs-base);font-weight:400;}

.doc-subject{text-align:center;margin-bottom:14px;}
.doc-subject input{border:none;border-bottom:2px solid var(--ink);background:transparent;font-family:'Source Serif 4',serif;font-size:.98rem;font-weight:700;text-align:center;outline:none;color:var(--ink);padding:2px 4px;width:340px;letter-spacing:.3px;}
.doc-subject .underline-label{font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:2px;display:block;}

.dear-block{font-size:var(--fs-sm);color:#333;margin-bottom:12px;line-height:1.6;}
.dear-block textarea{width:100%;border:none;border-bottom:1px solid #ddd;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);outline:none;color:var(--ink);padding:2px 0;resize:none;line-height:1.6;}

/* TABLE */
.twrap{overflow-x:auto;margin-bottom:10px;}
table.it{width:100%;border-collapse:collapse;font-size:var(--fs-sm);}
table.it thead tr.thm{background:var(--th-main-bg);color:var(--th-main-fg);}
table.it th{padding:7px 8px;text-align:left;font-family:'Barlow Condensed',sans-serif;font-size:var(--th-main-fs);letter-spacing:1.5px;text-transform:uppercase;font-weight:600;white-space:nowrap;border:1px solid #555;}
table.it th.rgt{text-align:right;}table.it th.ctr{text-align:center;}
table.it tbody tr{border-bottom:1px solid var(--mgray);}
table.it tbody tr:nth-child(even){background:rgba(0,0,0,.018);}
table.it td{padding:5px 8px;vertical-align:middle;border:1px solid var(--tb-border);color:var(--tb-fg);}
table.it td input,table.it td select{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);color:var(--tb-fg);outline:none;padding:1px 0;width:100%;}
table.it td input[type="number"]{text-align:right;}
.tc{text-align:right;font-weight:var(--fw-label);color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-size:.84rem;white-space:nowrap;}
.del-btn{background:none;border:none;cursor:pointer;color:#ccc;font-size:.78rem;padding:0 2px;}
.del-btn:hover{color:var(--accent);}
.sno-td{color:#888;text-align:center;font-size:var(--fs-xs);width:28px;}

/* amount highlight */
.amt-td{text-align:right;font-weight:700;color:var(--tb-accent);font-family:'Barlow Condensed',sans-serif;font-size:.88rem;white-space:nowrap;}
.amt-td .rate-note{font-size:.58rem;color:#888;font-weight:400;display:block;}

/* foot totals */
.totals-row-bar{background:#f0ece5;border-top:2px solid var(--steel);}
.totals-row-bar td{padding:5px 8px;font-family:'Barlow Condensed',sans-serif;font-size:var(--fs-sum);font-weight:700;color:var(--steel);text-align:right;border:1px solid var(--mgray);}
.totals-row-bar td.tot-label{text-align:left;font-size:calc(var(--fs-sum) * 0.85);letter-spacing:1.5px;text-transform:uppercase;color:#888;}

.add-btn{margin-top:6px;background:none;border:2px dashed var(--steel);color:var(--steel);font-family:'Barlow Condensed',sans-serif;font-size:.68rem;letter-spacing:2px;text-transform:uppercase;padding:5px 12px;cursor:pointer;border-radius:2px;transition:all .2s;}
.add-btn:hover{background:var(--steel);color:#fff;}

/* TOTALS BOX */
.sum-wrap{display:flex;justify-content:flex-end;margin-top:12px;}
.sumbox{background:#f0ece5;border:1px solid var(--lgray);min-width:280px;}
.srow{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;border-bottom:1px solid var(--lgray);font-size:var(--fs-sum);}
.srow.disabled{opacity:.3;pointer-events:none;}
.srow label{color:#555;display:flex;align-items:center;gap:5px;}
.srow .sv{font-weight:var(--fw-label);font-family:'Barlow Condensed',sans-serif;white-space:nowrap;}
.srow input[type="number"]{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sum);font-weight:600;width:56px;text-align:right;outline:none;color:var(--ink);}
.srow input[type="text"]{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sum);width:115px;outline:none;color:#555;}
.srow.grand{background:var(--ink);color:#fff;padding:10px 12px;}
.srow.grand label{color:#aaa;letter-spacing:2px;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;font-size:calc(var(--fs-sum) * 0.85);}
.srow.grand .sv{font-family:'Barlow Condensed',sans-serif;font-size:calc(var(--fs-sum) * 1.6);color:var(--amber);letter-spacing:1.5px;font-weight:700;}
.cur{margin-right:2px;color:#777;font-size:calc(var(--fs-sum) * 0.9);}.srow.grand .cur{color:#aaa;}
.sumbox .tot-foot{padding:5px 12px;font-family:'Barlow Condensed',sans-serif;font-size:calc(var(--fs-sum) * 0.9);color:#888;border-top:1px solid var(--lgray);text-align:right;}

/* TERMS */
.terms-section{margin-top:16px;}
.terms-section h4{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--ink);margin-bottom:7px;text-decoration:underline;text-underline-offset:3px;}
.terms-list-view{margin-bottom:14px;}
.terms-list-view ol{list-style:lower-roman;margin-left:22px;}
.terms-list-view li{font-size:var(--fs-sm);color:#333;line-height:1.7;padding-left:4px;}
.terms-list-view li .highlight{color:var(--accent);font-weight:700;}
.payment-block{margin-bottom:12px;}
.payment-block .pb-label{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink);margin-bottom:2px;text-decoration:underline;text-underline-offset:2px;}
.payment-block textarea,.warranty-block textarea{width:100%;border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);color:#333;outline:none;resize:none;line-height:1.6;padding:0;}
.warranty-block{margin-bottom:12px;}
.warranty-block .wb-label{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink);margin-bottom:2px;text-decoration:underline;text-underline-offset:2px;}
.thank-block textarea{width:100%;border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);color:#333;outline:none;resize:none;line-height:1.6;padding:0;}

/* SIG */
.sigrow{margin-top:20px;}
.sig-inner{display:inline-block;min-width:220px;}
.sig-line{border-bottom:1.5px solid var(--ink);height:42px;margin-bottom:4px;}
.sig-name{font-family:'Barlow Condensed',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:1px;color:var(--ink);}
.sig-name input{border:none;background:transparent;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;font-weight:700;color:var(--ink);outline:none;width:180px;}

/* FOOTER */
.doc-footer-strip{background:var(--ink);padding:8px 22px;display:flex;justify-content:space-between;align-items:center;gap:12px;}
.footer-manufactures{font-family:'Barlow Condensed',sans-serif;font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:#777;flex:1;}
.footer-manufactures strong{color:#999;}
.footer-contact{text-align:right;}
.footer-contact div{font-family:'Barlow Condensed',sans-serif;letter-spacing:1.5px;color:var(--amber);font-size:.75rem;}
#dcc-main{font-size:.88rem;font-weight:700;}
.doc-foot-bar{background:var(--accent);height:4px;}

/* size cell */
.size-td-wrap{display:flex;align-items:center;gap:2px;}
.size-td-wrap input{flex:1;min-width:28px;text-align:center;font-size:var(--fs-xs);}
.utog{display:flex;border:1px solid #ccc;border-radius:2px;overflow:hidden;flex-shrink:0;}
.utog button{padding:2px 4px;border:none;background:#f0ece5;color:#888;font-family:'Barlow Condensed',sans-serif;font-size:.5rem;cursor:pointer;line-height:1.2;transition:background .12s,color .12s;}
.utog button.active{background:var(--steel);color:#fff;}
.utog button:first-child{border-right:1px solid #ccc;}
.ulbl{font-size:.58rem;color:#999;font-family:'Barlow Condensed',sans-serif;flex-shrink:0;display:none;}

/* ref box */
.ref-box{background:#f0ece5;border:1px solid var(--mgray);padding:6px 12px;margin-bottom:12px;display:flex;gap:18px;flex-wrap:wrap;align-items:center;}
.ref-field{display:flex;align-items:center;gap:6px;}
.ref-field label{font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:#888;white-space:nowrap;}
.ref-field input{border:none;border-bottom:1px solid var(--mgray);background:transparent;font-family:'Barlow',sans-serif;font-size:.8rem;outline:none;color:var(--ink);padding:1px 0;width:130px;}

/* ‚ïê‚ïê‚ïê MOBILE CARD TABLE ‚ïê‚ïê‚ïê */
.mob-card{display:none;}
.mob-card-row{background:var(--warm);border:1px solid var(--mgray);border-left:4px solid var(--accent);border-radius:4px;padding:12px 12px 10px;margin-bottom:10px;position:relative;box-shadow:0 1px 4px rgba(0,0,0,.07);}
.mob-card-row:nth-child(even){background:#f5f1ec;}
.mob-card-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 14px;}
.mob-card-field{display:flex;flex-direction:column;gap:3px;}
.mob-card-field.full{grid-column:1/-1;}
.mob-card-lbl{font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase;color:#888;font-family:'Barlow Condensed',sans-serif;font-weight:600;}
.mob-card-field input,.mob-card-field select{border:none;border-bottom:1.5px solid var(--mgray);background:transparent;font-family:'Barlow',sans-serif;font-size:1rem;color:var(--ink);outline:none;padding:5px 0;width:100%;min-height:36px;-webkit-appearance:none;}
.mob-card-field input:focus,.mob-card-field select:focus{border-bottom-color:var(--accent);}
.mob-card-field input[type=number]{text-align:right;}
.mob-card-amt-row{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--lgray);margin-top:4px;padding-top:8px;}
.mob-card-amt-lbl{font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase;color:#888;font-family:'Barlow Condensed',sans-serif;}
.mob-card-amt{font-family:'Barlow Condensed',sans-serif;font-size:1.15rem;font-weight:700;color:var(--accent);}
.mob-card-rate-note{font-size:.65rem;color:#aaa;font-family:'Barlow',sans-serif;}
.mob-card-del{position:absolute;top:10px;right:10px;background:rgba(139,0,0,.08);border:none;color:var(--accent);font-size:1rem;cursor:pointer;padding:4px 8px;line-height:1;border-radius:3px;}
.mob-card-del:active{background:var(--accent);color:#fff;}
.mob-card-hdr{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--lgray);}
.mob-card-sno{background:var(--ink);color:var(--warm);font-family:'Barlow Condensed',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:1px;padding:2px 7px;border-radius:2px;}
.mob-card-stitle{font-size:.65rem;color:#888;font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;text-transform:uppercase;}
.mob-add-btn{width:100%;padding:13px;background:none;border:2px dashed var(--steel);color:var(--steel);font-family:'Barlow Condensed',sans-serif;font-size:.82rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border-radius:3px;margin-top:6px;display:none;}
.mob-add-btn:active{background:var(--steel);color:#fff;}

/* touch drag ‚Äî visual feedback */
.citem,.trow-item{touch-action:manipulation;cursor:grab;}
.citem.touch-drag,.trow-item.touch-drag{opacity:.45;box-shadow:0 4px 16px rgba(0,0,0,.4);transform:scale(.98);z-index:99;position:relative;}
.citem.touch-over{border-color:var(--amber)!important;background:#1e1e0a!important;}
.trow-item.touch-over{border-color:var(--amber)!important;background:#1a1a0a!important;}
.drag-ghost{position:fixed;pointer-events:none;z-index:999;opacity:.85;border-radius:3px;box-shadow:0 6px 24px rgba(0,0,0,.5);background:#2a2a2a;padding:10px 14px;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;color:var(--amber);letter-spacing:2px;text-transform:uppercase;max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

@media(max-width:680px){
  body{padding:4px;font-size:15px;} /* slightly bigger base for mobile readability */

  /* ‚îÄ‚îÄ Settings panel ‚îÄ‚îÄ */
  .stbar{padding:12px 14px;}
  .stbar h2{font-size:.78rem;letter-spacing:1.5px;}
  .sbadge{display:none;}
  .sbody{padding:12px 12px 16px;}
  .stabs{gap:0;-webkit-overflow-scrolling:touch;}
  .stab{padding:12px 12px;font-size:.65rem;letter-spacing:1px;min-width:60px;text-align:center;}
  .sgrid{grid-template-columns:1fr;}
  .sg{padding:12px;}
  .sf input,.sf textarea,.sf select{font-size:.9rem;padding:6px 8px;min-height:38px;}
  .abar{gap:8px;}
  .abar .btn{flex:1 1 calc(50% - 4px);padding:12px 8px;font-size:.75rem;min-height:44px;}
  .font-grid{grid-template-columns:1fr;}
  .fslider input[type=range]{height:40px;-webkit-appearance:none;appearance:none;}

  /* Terms pane: stack to single column */
  #pane-terms > div{grid-template-columns:1fr !important;}

  /* col/trow manager ‚Äî bigger touch targets for drag */
  .citem{padding:13px 12px;min-height:50px;border-radius:3px;}
  .cname{font-size:.75rem;}
  .cdh{font-size:1.1rem;padding-right:4px;color:#666;}
  .trow-item{padding:13px 12px;min-height:50px;}
  .trow-item input.trow-label-inp{font-size:.88rem;padding:6px 8px;min-height:38px;}

  /* tsw toggle ‚Äî bigger */
  .tsw{width:42px;height:22px;}
  .tsl:before{width:15px;height:15px;left:3px;top:3px;}
  .tsw input:checked+.tsl:before{transform:translateX(20px);}

  /* ‚îÄ‚îÄ Document ‚îÄ‚îÄ */
  .header-top{flex-direction:column;gap:10px;}
  .cert-block{flex-direction:row;flex-wrap:wrap;justify-content:flex-start;align-items:center;min-width:0;gap:6px;}
  #dc-big{font-size:1.55rem;}
  #dc-tag{font-size:.72rem;}
  .addr-block{font-size:.78rem;line-height:1.8;}
  .doc-meta{grid-template-columns:1fr 1fr;}
  .mc{border-right:none;border-bottom:1px solid rgba(255,255,255,.08);padding:9px 11px;}
  .mc:nth-child(odd){border-right:1px solid rgba(255,255,255,.08);}
  .mc label{font-size:.58rem;}
  .mc input{font-size:.9rem;min-height:34px;}
  .dbody{padding:12px 12px;}

  /* Customer / ref inputs */
  .customer-block input.cust-in{font-size:1.05rem;min-height:40px;}
  .ref-box{flex-direction:column;gap:8px;align-items:flex-start;}
  .ref-field input{font-size:.95rem;min-height:34px;width:100%;}

  /* Dear block textarea */
  .dear-block textarea{font-size:.92rem;min-height:58px;line-height:1.7;}

  /* ‚îÄ‚îÄ TABLE: hide desktop table, show mobile cards ‚îÄ‚îÄ */
  .twrap{display:none !important;}
  .add-btn{display:none !important;}
  .mob-card{display:block;}
  .mob-add-btn{display:block !important;}

  /* Terms section */
  .terms-list-view li{font-size:.88rem;line-height:1.8;}
  .payment-block textarea,.warranty-block textarea,.thank-block textarea{font-size:.9rem;}

  /* ‚îÄ‚îÄ Totals ‚îÄ‚îÄ */
  .sum-wrap{justify-content:stretch;}
  .sumbox{width:100%;min-width:0;}
  .srow{padding:10px 14px;font-size:calc(var(--fs-sum) * 1.05);}
  .srow.grand{padding:13px 14px;}

  /* ‚îÄ‚îÄ Signatures ‚îÄ‚îÄ */
  .sig-name input{font-size:.95rem;}

  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  .doc-footer-strip{flex-direction:column;gap:4px;text-align:center;padding:8px 10px;}
  .footer-contact{text-align:center;}
  .footer-manufactures{font-size:.58rem;}
}

@media(max-width:420px){
  .abar .btn{flex:1 1 100%;}
  .doc-meta{grid-template-columns:1fr;}
  .mc:nth-child(odd){border-right:none;}
  .mc{border-bottom:1px solid rgba(255,255,255,.08);}
  .mc:last-child{border-bottom:none;}
  #dc-big{font-size:1.25rem;}
  .mob-card-grid{grid-template-columns:1fr;}
  .mob-card-field.full{grid-column:1/-1;}
}
@media print{
  body{background:#fff;padding:0;}
  #SP{display:none!important;}
  #QD{box-shadow:none;max-width:100%;}
  .add-btn,.del-btn,.utog{display:none!important;}
  .ulbl{display:inline!important;}
  input,select,textarea{border-color:transparent!important;background:transparent!important;}
  .mc input{border-bottom-color:rgba(255,255,255,.18)!important;}
  .srow.disabled{display:none;}
  #pdf-modal{display:none!important;}
  @page{margin:0;size:A4;}
}

/* ‚ïê‚ïê‚ïê PDF PREVIEW MODAL ‚ïê‚ïê‚ïê */
#pdf-modal{
  display:none;position:fixed;inset:0;z-index:9999;
  background:rgba(0,0,0,.82);
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:0;
  overflow:hidden;
}
#pdf-modal.open{display:flex;}
.pdf-modal-bar{
  width:100%;background:#111;
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;gap:10px;flex-shrink:0;
  border-bottom:2px solid var(--accent);
  flex-wrap:wrap;
}
.pdf-modal-bar h3{
  font-family:'Barlow Condensed',sans-serif;
  font-size:.82rem;letter-spacing:3px;text-transform:uppercase;
  color:var(--amber);flex:1;
}
.pdf-modal-actions{display:flex;gap:8px;flex-wrap:wrap;}
.pdf-modal-actions button{
  padding:8px 16px;font-family:'Barlow Condensed',sans-serif;
  font-size:.75rem;letter-spacing:2px;text-transform:uppercase;
  border:none;cursor:pointer;border-radius:2px;font-weight:600;
}
.btn-pdf-dl{background:var(--accent);color:#fff;}
.btn-pdf-dl:hover{background:#6b0000;}
.btn-pdf-cl{background:#2a2a2a;color:#888;border:1px solid #3a3a3a;}
.btn-pdf-cl:hover{background:#333;color:#ccc;}
.pdf-modal-scroll{
  flex:1;width:100%;overflow:auto;
  display:flex;align-items:flex-start;justify-content:center;
  padding:16px;
  -webkit-overflow-scrolling:touch;
}
.pdf-modal-pages{display:flex;flex-direction:column;gap:12px;align-items:center;}
.pdf-page-img{
  display:block;
  box-shadow:0 4px 24px rgba(0,0,0,.5);
  max-width:min(860px,calc(100vw - 32px));
  width:100%;
  height:auto;
  background:#fff;
}
.pdf-modal-loading{
  color:#aaa;font-family:'Barlow Condensed',sans-serif;
  font-size:.85rem;letter-spacing:2px;text-transform:uppercase;
  padding:40px;text-align:center;
}
.pdf-modal-loading::after{
  content:'';display:block;width:32px;height:32px;
  border:3px solid #333;border-top-color:var(--amber);
  border-radius:50%;margin:16px auto 0;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
@media(max-width:680px){
  .pdf-modal-bar{padding:8px 10px;}
  .pdf-modal-bar h3{font-size:.7rem;width:100%;}
  .pdf-modal-actions{width:100%;}
  .pdf-modal-actions button{flex:1;padding:10px 8px;font-size:.7rem;}
  .pdf-modal-scroll{padding:8px;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="SP">
  <div class="stbar" onclick="toggleSP()">
    <h2>‚öô Settings &amp; Customization <span class="sdot" id="sdot"></span></h2>
    <span class="sbadge">üîí Hidden in PDF ¬∑ Auto-saved</span>
    <span class="sarr" id="sarr">‚ñ≤</span>
  </div>
  <div class="sbody" id="sbody">
    <div class="stabs">
      <div class="stab active"  onclick="stab('company')">üè≠ Company</div>
      <div class="stab"         onclick="stab('columns')">üìã Columns</div>
      <div class="stab"         onclick="stab('widths')">‚Üî Widths</div>
      <div class="stab"         onclick="stab('totals')">üí∞ Totals</div>
      <div class="stab"         onclick="stab('terms')">üìù Terms</div>
      <div class="stab"         onclick="stab('font')">üî§ Font</div>
      <div class="stab"         onclick="stab('table')">üé® Table</div>
    </div>

    <!-- Company -->
    <div class="spane active" id="pane-company">
      <div class="sgrid" style="margin-top:11px">
        <div class="sg">
          <div class="sgt">Logo</div>
          <div class="sf"><label>Upload</label>
            <button class="lbtn" onclick="document.getElementById('li').click()">üìé Upload Logo</button>
            <input type="file" id="li" accept="image/*" style="display:none" onchange="uploadLogo(event)">
          </div>
          <button class="lbtn rem" onclick="removeLogo()">‚úï Remove Logo</button>
        </div>
        <div class="sg">
          <div class="sgt">Company</div>
          <div class="sf"><label>Name</label><input id="sc" value="Mill Roll Specialists" oninput="syncCompany();save()"></div>
          <div class="sf"><label>Tagline</label><input id="st" value="ISO-9001:2008 Certified" oninput="sync('t');save()"></div>
          <div class="sf"><label>Pioneer Text</label><input id="spio" value="Pioneers of Excellence in Roll Casting Metallurgy" oninput="document.getElementById('pioneer-text').textContent=this.value;save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Address</div>
          <div class="sf"><label>Phone (Off)</label><input id="sph1" value="92-042-6631228 (Off)" oninput="renderAddr();save()"></div>
          <div class="sf"><label>Phone (Works)</label><input id="sph2" value="92-042-6543076 (Works)" oninput="renderAddr();save()"></div>
          <div class="sf"><label>Mobile</label><input id="smob" value="0333-4256862, 0300-4265109" oninput="renderAddr();save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Certifications</div>
          <div class="sf"><label>Badge 1</label><input id="scert1" value="JAS-ANZ" oninput="renderCerts();save()"></div>
          <div class="sf"><label>Badge 2</label><input id="scert2" value="QMS" oninput="renderCerts();save()"></div>
          <div class="sf"><label>Badge 3</label><input id="scert3" value="ISO 9001" oninput="renderCerts();save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Footer</div>
          <div class="sf"><label>Manufactures</label><input id="sfmfg" value="Chilled Rolls, S.G. Iron Rolls, Grain Iron Rolls" oninput="document.getElementById('foot-mfg').innerHTML='<strong>MANUFACTURES:</strong> '+this.value;save()"></div>
          <div class="sf"><label>Footer Tag</label><input id="sffor" value="For: Steel Re-Rolling Mills, Non Ferrous Rolling Mills, Flour Mills, Textile Mills, Paper Mills, Plastic and Paints Industry" oninput="document.getElementById('foot-for').innerHTML='<strong>FOR:</strong> '+this.value;save()"></div>
          <div class="sf"><label>Footer Contact</label><input id="sfc" value="03334256862" oninput="document.getElementById('dcc-main').textContent=this.value;save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Currency &amp; Tax</div>
          <div class="sf"><label>Currency</label><input id="scur" value="PKR" oninput="updateCur();save()"></div>
          <div class="sf"><label>Default GST %</label><input type="number" id="stax" value="18" min="0" oninput="save()"></div>
          <div class="sf"><label>Default Discount %</label><input type="number" id="sdisc" value="0" min="0" oninput="save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Signature</div>
          <div class="sf"><label>Signatory Name</label><input id="ssign" value="Engr. Mian Khurram Akram" oninput="document.getElementById('sig-name-inp').value=this.value;save()"></div>
        </div>
        <div class="abar swide">
          <button class="btn btn-pdf" onclick="openPDFPreview()">üëÅ Preview &amp; Download PDF</button>
          <button class="btn btn-print" onclick="window.print()">üñ® Print</button>
          <button class="btn btn-rf" onclick="resetForm()">‚Ü∫ Reset Form</button>
          <button class="btn btn-rs" onclick="resetAll()">‚ö† Reset All</button>
        </div>
        <div class="abar swide" style="border-top:1px solid #1e1e1e;margin-top:6px;padding-top:10px;">
          <span style="font-size:.55rem;letter-spacing:2px;text-transform:uppercase;color:#444;align-self:center;">üì≤ Sync:</span>
          <button class="btn btn-share" onclick="exportSettings()">‚¨á Export</button>
          <button class="btn btn-share" onclick="document.getElementById('import-file').click()">‚¨Ü Import</button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="importSettings(event)">
          <button class="btn btn-link" id="share-btn" onclick="copyShareLink()">üîó Copy Share Link</button>
        </div>
      </div>
    </div>

    <!-- Columns -->
    <div class="spane" id="pane-columns">
      <div style="padding:10px 0 3px">
        <p style="font-size:.63rem;color:#444;letter-spacing:1px;margin-bottom:8px;">‚ò∞ Drag to reorder ¬∑ Toggle show/hide ¬∑ Auto-saved</p>
        <div class="clist" id="clist"></div>
        <div style="margin-top:12px;border-top:1px solid #222;padding-top:10px">
          <p style="font-size:.62rem;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px">‚ûï Custom Columns</p>
          <div class="custom-col-list" id="cc-list"></div>
          <button class="add-cc-btn" onclick="addCustomCol()">+ Add Custom Column</button>
        </div>
      </div>
    </div>

    <!-- Widths -->
    <div class="spane" id="pane-widths">
      <div style="padding:10px 0 3px">
        <p style="font-size:.63rem;color:#444;letter-spacing:1px;margin-bottom:8px;">Enter px number or <code style="color:#888">auto</code></p>
        <div class="wgrid" id="wgrid"></div>
      </div>
    </div>

    <!-- Totals -->
    <div class="spane" id="pane-totals">
      <div style="padding:10px 0 3px">
        <p style="font-size:.63rem;color:#444;letter-spacing:1px;margin-bottom:8px;">‚ò∞ Drag to reorder ¬∑ Toggle ¬∑ Edit label ¬∑ Delete</p>
        <div class="trows-mgr" id="trows-mgr"></div>
        <button class="add-tr-btn" onclick="addTotalRow()">+ Add Custom Total Row</button>
      </div>
    </div>

    <!-- Terms Manager -->
    <div class="spane" id="pane-terms">
      <div style="padding:10px 0 3px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <p style="font-size:.62rem;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px">Terms &amp; Conditions</p>
          <div class="terms-list" id="tc-list"></div>
          <button class="add-ti-btn" onclick="addTermItem()">+ Add Term</button>
        </div>
        <div>
          <div class="sf" style="margin-bottom:8px">
            <div class="sec-toggle-row">
              <label>Payment Text</label>
              <label class="tsw" title="Show/Hide in document">
                <input type="checkbox" id="tog-payment" checked onchange="toggleSection('payment',this.checked)">
                <span class="tsl"></span>
              </label>
            </div>
            <textarea id="s-pay" style="min-height:60px" oninput="document.getElementById('doc-payment').value=this.value;save()">1,000,000/- advance, balance at the time of delivery after final inspection.</textarea>
          </div>
          <div class="sf" style="margin-bottom:8px">
            <div class="sec-toggle-row">
              <label>Warranty Text</label>
              <label class="tsw" title="Show/Hide in document">
                <input type="checkbox" id="tog-warranty" checked onchange="toggleSection('warranty',this.checked)">
                <span class="tsl"></span>
              </label>
            </div>
            <textarea id="s-warranty" style="min-height:70px" oninput="document.getElementById('doc-warranty').value=this.value;save()">Mill Roll Specialists offers guarantee for free replacement in case of Roll breakage in normal operation, without mill accident up to first dressing.</textarea>
          </div>
          <div class="sf" style="margin-bottom:8px">
            <div class="sec-toggle-row">
              <label>Closing / Thanks</label>
              <label class="tsw" title="Show/Hide in document">
                <input type="checkbox" id="tog-thanks" checked onchange="toggleSection('thanks',this.checked)">
                <span class="tsl"></span>
              </label>
            </div>
            <textarea id="s-thanks" style="min-height:50px" oninput="document.getElementById('doc-thanks').value=this.value;save()">Thanking you and assuring you best of our services.</textarea>
          </div>
          <div class="sf" style="margin-top:6px">
            <div class="sec-toggle-row">
              <label>Notes / Remarks</label>
              <label class="tsw" title="Show/Hide in document">
                <input type="checkbox" id="tog-notes" onchange="toggleSection('notes',this.checked)">
                <span class="tsl"></span>
              </label>
            </div>
            <textarea id="sn" style="min-height:50px" oninput="syncNotes()"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Font -->
    <div class="spane" id="pane-font">
      <div style="padding:10px 0 3px">
        <div class="font-grid">
          <div class="sg">
            <div class="sgt">Totals Box Font</div>
            <div class="fslider">
              <input type="range" id="fs-sum-r" min="10" max="22" value="14" oninput="updateFonts()">
              <span id="fs-sum-v">14px</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Base Font Size</div>
            <div class="fslider">
              <input type="range" id="fs-base-r" min="10" max="18" value="13" oninput="updateFonts()">
              <span id="fs-base-v">13px</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Small Font Size</div>
            <div class="fslider">
              <input type="range" id="fs-sm-r" min="8" max="16" value="11" oninput="updateFonts()">
              <span id="fs-sm-v">11px</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Body Weight</div>
            <div class="fslider">
              <input type="range" id="fw-body-r" min="300" max="600" step="100" value="400" oninput="updateFonts()">
              <span id="fw-body-v">400</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Label Weight</div>
            <div class="fslider">
              <input type="range" id="fw-label-r" min="400" max="700" step="100" value="600" oninput="updateFonts()">
              <span id="fw-label-v">600</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Line Height</div>
            <div class="fslider">
              <input type="range" id="lh-r" min="1.2" max="2.2" step="0.05" value="1.55" oninput="updateFonts()">
              <span id="lh-v">1.55</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Preview</div>
            <p id="font-preview" style="font-size:.75rem;color:#aaa;line-height:1.5">Roll Description: √ò330√ó280√ó117mm<br>Ni-Cr-Mn-Mo-Cu Chilled Cast Iron<br>Approx Wt: 165 Kg/Sleeve</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Styling -->
    <div class="spane" id="pane-table">
      <div style="padding:12px 0 4px">
        <p style="font-size:.63rem;color:#444;letter-spacing:1px;margin-bottom:12px;">Customize table header colors, fonts &amp; sub-row appearance</p>
        <div class="sgrid">

          <!-- GROUP HEADER ROW -->
          <div class="sg">
            <div class="sgt">üìå Group Header Row</div>
            <p style="font-size:.58rem;color:#666;margin-bottom:8px;line-height:1.4">"SIZE (IN/MM PER FIELD)" ‚Äî the top spanning header</p>
            <div class="cprow">
              <label>Background Color</label>
              <div class="cprow-inner">
                <input type="color" id="sh-bg" value="#1a1212" oninput="renderHeaders();save()">
                <span id="sh-bg-v">#1a1212</span>
              </div>
            </div>
            <div class="cprow">
              <label>Text Color</label>
              <div class="cprow-inner">
                <input type="color" id="sh-fg" value="#ffffff" oninput="renderHeaders();save()">
                <span id="sh-fg-v">#ffffff</span>
              </div>
            </div>
            <div class="cprow">
              <label>Font Size</label>
              <div class="fslider" style="margin-top:2px">
                <input type="range" id="sh-fs" min="7" max="18" value="10" oninput="renderHeaders();save()">
                <span id="sh-fs-v">10px</span>
              </div>
            </div>
          </div>

          <!-- SUB-HEADER ROW -->
          <div class="sg">
            <div class="sgt">üìê Sub-Row (DIA / LENGTH / BORE)</div>
            <p style="font-size:.58rem;color:#666;margin-bottom:8px;line-height:1.4">The second row showing individual size column labels</p>
            <div class="cprow">
              <label>Background Color</label>
              <div class="cprow-inner">
                <input type="color" id="sh-sub-bg" value="#273d4d" oninput="renderHeaders();save()">
                <span id="sh-sub-bg-v">#273d4d</span>
              </div>
            </div>
            <div class="cprow">
              <label>Text Color</label>
              <div class="cprow-inner">
                <input type="color" id="sh-sub-fg" value="#8aabb8" oninput="renderHeaders();save()">
                <span id="sh-sub-fg-v">#8aabb8</span>
              </div>
            </div>
            <div class="cprow">
              <label>Font Size</label>
              <div class="fslider" style="margin-top:2px">
                <input type="range" id="sh-sub-fs" min="7" max="16" value="9" oninput="renderHeaders();save()">
                <span id="sh-sub-fs-v">9px</span>
              </div>
            </div>
          </div>

          <!-- MAIN HEADER ROW -->
          <div class="sg">
            <div class="sgt">üóÇ Main Header Row</div>
            <p style="font-size:.58rem;color:#666;margin-bottom:8px;line-height:1.4">All other column headers (Roll Description, Qty, Amount‚Ä¶)</p>
            <div class="cprow">
              <label>Background Color</label>
              <div class="cprow-inner">
                <input type="color" id="th-main-bg" value="#1a1212" oninput="updateTableColors();save()">
                <span id="th-main-bg-v">#1a1212</span>
              </div>
            </div>
            <div class="cprow">
              <label>Text Color</label>
              <div class="cprow-inner">
                <input type="color" id="th-main-fg" value="#faf8f5" oninput="updateTableColors();save()">
                <span id="th-main-fg-v">#faf8f5</span>
              </div>
            </div>
            <div class="cprow">
              <label>Font Size</label>
              <div class="fslider" style="margin-top:2px">
                <input type="range" id="th-main-fs" min="7" max="16" value="10" oninput="updateTableColors();save()">
                <span id="th-main-fs-v">10px</span>
              </div>
            </div>
          </div>

          <!-- TABLE BODY -->
          <div class="sg">
            <div class="sgt">üìÑ Table Body Rows</div>
            <p style="font-size:.58rem;color:#666;margin-bottom:8px;line-height:1.4">Data rows, borders and alternating row tint</p>
            <div class="cprow">
              <label>Row Text Color</label>
              <div class="cprow-inner">
                <input type="color" id="tb-fg" value="#1a1212" oninput="updateTableColors();save()">
                <span id="tb-fg-v">#1a1212</span>
              </div>
            </div>
            <div class="cprow">
              <label>Border Color</label>
              <div class="cprow-inner">
                <input type="color" id="tb-border" value="#d0cbc3" oninput="updateTableColors();save()">
                <span id="tb-border-v">#d0cbc3</span>
              </div>
            </div>
            <div class="cprow">
              <label>Amount / Accent Color</label>
              <div class="cprow-inner">
                <input type="color" id="tb-accent" value="#8b0000" oninput="updateTableColors();save()">
                <span id="tb-accent-v">#8b0000</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCUMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="QD">

  <!-- HEADER -->
  <div class="doc-header">
    <div class="header-top">
      <div class="company-block">
        <div class="company-name-wrap">
          <div id="dc-big"><span>Mill Roll</span> Specialists</div>
        </div>
        <div id="dc-tag">ISO-9001:2008 Certified</div>
        <div class="addr-block" id="da">
          <div><span class="lbl">Phone No:</span> 92-042-6631228 (Off) &nbsp; 92-042-6543076 (Works)</div>
          <div><span class="lbl">Mobile No:</span> 0333-4256862 &nbsp; 0300-4265109</div>
        </div>
      </div>
      <div class="cert-block">
        <div class="logo-area">
          <img id="logo-display" src="" alt="Logo">
          <div id="logo-ph">
            <svg width="48" height="48" viewBox="0 0 60 60" fill="none">
              <polygon points="30,4 56,18 56,42 30,56 4,42 4,18" stroke="#c0c8d0" stroke-width="2" fill="none"/>
              <polygon points="30,14 46,23 46,37 30,46 14,37 14,23" stroke="#8b0000" stroke-width="1.5" fill="none"/>
              <circle cx="30" cy="30" r="5" fill="#c0c8d0"/>
            </svg>
          </div>
        </div>
        <div class="cert-badges" id="cert-badges">
          <div class="cert-badge">JAS-ANZ</div>
          <div class="cert-badge">QMS</div>
          <div class="cert-badge" style="font-size:.5rem">ISO 9001</div>
        </div>
        <div class="pioneer-text" id="pioneer-text">Pioneers of Excellence in Roll Casting Metallurgy</div>
      </div>
    </div>
  </div>

  <!-- META BAR -->
  <div class="doc-meta">
    <div class="mc"><label>Issue Date</label><input type="date" id="mdate"></div>
    <div class="mc"><label>Valid Until</label><input type="date" id="mvalid"></div>
    <div class="mc"><label>Delivery Lead Time</label><input type="text" placeholder="e.g. 6‚Äì8 weeks after PO"></div>
    <div class="mc"><label>Payment Terms</label><input type="text" placeholder="50% Advance / 50% Delivery"></div>
  </div>

  <!-- BODY -->
  <div class="dbody">

    <!-- Date line -->
    <div class="doc-date-line">
      <input type="text" id="doc-date-text" placeholder="January 08, 2025" style="width:150px">
    </div>

    <!-- Customer -->
    <div class="customer-block" style="margin-top:8px">
      <div style="margin-bottom:3px">Mr./Ms./Dr. <input class="cust-in" type="text" id="cust" placeholder="Customer Name‚Ä¶"></div>
      <div><input class="cust-in org-in" type="text" id="cust-org" placeholder="Company / Organization‚Ä¶" style="font-size:var(--fs-base);font-weight:400;"></div>
    </div>

    <!-- Reference box -->
    <div class="ref-box">
      <div class="ref-field"><label>Quote No.</label><input type="text" id="qref" value="MRS-2025-001"></div>
      <div class="ref-field"><label>Ref / Subject</label><input type="text" id="qsubj" value="Quotation of Rolls for Finishing Stand" style="width:240px"></div>
    </div>

    <!-- Dear line -->
    <div class="dear-block">
      <textarea id="doc-dear" rows="2" style="width:100%;border:none;border-bottom:1px solid #ddd;background:transparent;font-family:Barlow,sans-serif;font-size:var(--fs-sm);outline:none;color:#333;resize:none;line-height:1.65;">Dear Sir,
Please refer to the telephonic talk and your visit to the Office; we are pleased to quote the rock bottom price of the desired rolls as under.</textarea>
    </div>

    <!-- ITEMS TABLE -->
    <div style="margin-top:12px">
      <div class="twrap">
        <table class="it" id="itable">
          <thead>
            <tr class="thm" id="thm"></tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr class="totals-row-bar" id="tfoot-row"></tr>
          </tfoot>
        </table>
      </div>
      <button class="add-btn" onclick="addRow()">+ Add Item</button>
    </div>

    <!-- MOBILE CARD VIEW (shown on mobile instead of table) -->
    <div class="mob-card" id="mob-card-container"></div>
    <button class="mob-add-btn" onclick="addRow()">+ Add Item</button>

    <!-- TOTALS BOX -->
    <div class="sum-wrap">
      <div class="sumbox" id="sumbox"></div>
    </div>

    <!-- TERMS & CONDITIONS -->
    <div class="terms-section">
      <h4>Terms &amp; Conditions.</h4>
      <div class="terms-list-view">
        <ol id="terms-view-list"></ol>
      </div>

      <div class="payment-block" id="sec-payment">
        <div class="pb-label">Payment:</div>
        <textarea id="doc-payment" rows="1">1,000,000/- advance, balance at the time of delivery after final inspection.</textarea>
      </div>

      <div class="warranty-block" id="sec-warranty">
        <div class="wb-label">Warranty / Guarantee:</div>
        <textarea id="doc-warranty" rows="3">Mill Roll Specialists offers guarantee for free replacement in case of Roll breakage in normal operation, without mill accident up to first dressing.</textarea>
      </div>

      <div class="thank-block" id="sec-thanks" style="margin-bottom:14px">
        <textarea id="doc-thanks" rows="1">Thanking you and assuring you best of our services.</textarea>
      </div>

      <div id="sec-notes" style="margin-bottom:14px;display:none">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink);margin-bottom:2px;">Notes / Remarks:</div>
        <textarea id="doc-notes" rows="2" style="width:100%;border:none;background:transparent;font-family:Barlow,sans-serif;font-size:var(--fs-sm);color:#333;outline:none;resize:none;line-height:1.6;padding:0;"></textarea>
      </div>
    </div>

    <!-- SIGNATURE -->
    <div class="sigrow">
      <div class="sig-inner">
        <div class="sig-line"></div>
        <div class="sig-name"><input id="sig-name-inp" value="Engr. Mian Khurram Akram" style="width:100%"></div>
      </div>
    </div>

  </div>

  <!-- FOOTER -->
  <div class="doc-footer-strip">
    <div class="footer-manufactures">
      <div id="foot-mfg"><strong>MANUFACTURES:</strong> Chilled Rolls, S.G. Iron Rolls, Grain Iron Rolls</div>
      <div id="foot-for" style="margin-top:2px;"><strong>FOR:</strong> Steel Re-Rolling Mills, Non Ferrous Rolling Mills, Flour Mills, Textile Mills, Paper Mills, Plastic and Paints Industry</div>
    </div>
    <div class="footer-contact">
      <div id="dcc-main">03334256862</div>
    </div>
  </div>
  <div class="doc-foot-bar"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLUMN DEFINITIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const COL_DEFS = [
  {key:'desc',    label:'Roll Description',  vis:true,  w:'auto', fixed:true,              showTotal:false},
  {key:'sno',     label:'S.No',              vis:true,  w:'40',   fixed:false,             showTotal:false},
  {key:'stand',   label:'Stand #',           vis:true,  w:'65',   numeric:false,           showTotal:false},
  {key:'casting', label:'Casting Process',   vis:true,  w:'100',                           showTotal:false},
  {key:'hardness',label:'Hardness',          vis:true,  w:'85',                            showTotal:false},
  {key:'dia',     label:'Dia',               vis:false, w:'auto', size:true,               showTotal:false},
  {key:'len',     label:'Length',            vis:false, w:'auto', size:true,               showTotal:false},
  {key:'bore',    label:'Bore',              vis:false, w:'auto', size:true,               showTotal:false},
  {key:'weight',  label:'Weight (kg)',        vis:false, w:'70',   numeric:true,            showTotal:true},
  {key:'qty',     label:'Quantity',           vis:true,  w:'70',   numeric:true, isQty:true,showTotal:true},
  {key:'unit',    label:'Unit',              vis:false, w:'55',                            showTotal:false},
  {key:'rate',    label:'Rate / kg',         vis:false, w:'80',   numeric:true,            showTotal:false},
  {key:'amount',  label:'Amount',            vis:true,  w:'110',  numeric:true, isAmt:true,showTotal:true},
];

const TROW_DEFS = [
  {id:'subtotal', label:'Subtotal',   type:'subtotal', vis:true,  fixed:true},
  {id:'discount', label:'Discount',  type:'discount', vis:false, fixed:false},
  {id:'tax',      label:'GST / Tax', type:'tax',      vis:true,  fixed:false},
  {id:'aftertax', label:'After Tax', type:'aftertax', vis:false, fixed:false},
  {id:'grand',    label:'Grand Total',type:'grand',   vis:true,  fixed:true},
];

const TERM_DEFS = [
  'Prices Ex- Works Lahore.',
  'Prices are exclusive of 18% G.S.T which will be charged and invoice will be provided.',
  'Rolls will be rough machined with minor machining allowance.',
  'Mill Test Certificate will be provided with each Roll.',
  'Delivery of rolls will start in 6 to 8 weeks of receiving confirm P.O and advance.',
  'Validity of quotation is for 10 days only.',
  'Approximate Weight of Order 2840 Kg',
];

let COLS = [], TROWS = [], CUSTOM_COLS = [], TERM_ITEMS = [];
let rc = 0;
const LS = 'mrspk_qt_v1', LS_LOGO = 'mrspk_logo';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function defState(){
  return {
    c:'Mill Roll Specialists', t:'ISO-9001:2008 Certified',
    pio:'Pioneers of Excellence in Roll Casting Metallurgy',
    off:'61-B Guldasht Town, Zarar Shaheed Road, Lahore Cantt.',
    wrk:'Bismillah Street, Industrial Area, Momenpora, G.T. Road, Daroghawala, Lahore',
    ph1:'92-042-6631228 (Off)', ph2:'92-042-6543076 (Works)',
    fax:'92-042-6633908', mob:'0333-4256862, 0300-4265109',
    eml:'info@mrspk.com  www.mrspk.com',
    cert1:'JAS-ANZ', cert2:'QMS', cert3:'ISO 9001',
    fmfg:'Chilled Rolls, S.G. Iron Rolls, Grain Iron Rolls',
    ffor:'For: Steel Re-Rolling Mills, Non Ferrous Rolling Mills, Flour Mills, Textile Mills, Paper Mills, Plastic and Paints Industry',
    fc:'03334256862',
    sign:'Engr. Mian Khurram Akram',
    cur:'PKR', tax:'18', disc:'0',
    pay:'1,000,000/- advance, balance at the time of delivery after final inspection.',
    warranty:'Mill Roll Specialists offers guarantee for free replacement in case of Roll breakage in normal operation, without mill accident up to first dressing.',
    thanks:'Thanking you and assuring you best of our services.',
    notes:'',
    cols: JSON.parse(JSON.stringify(COL_DEFS)),
    trows: JSON.parse(JSON.stringify(TROW_DEFS)),
    customCols: [],
    termItems: TERM_DEFS.slice(),
    panelOpen: true,
    fsBase:13, fsSm:11, fwBody:400, fwLabel:600, lh:1.55,
  };
}

function loadState(){
  try{
    const r=localStorage.getItem(LS);
    if(r){
      const s=JSON.parse(r);
      if(!s.cols||!Array.isArray(s.cols))   s.cols=JSON.parse(JSON.stringify(COL_DEFS));
      if(!s.trows||!Array.isArray(s.trows)) s.trows=JSON.parse(JSON.stringify(TROW_DEFS));
      if(!s.customCols)                      s.customCols=[];
      if(!s.termItems)                       s.termItems=TERM_DEFS.slice();
      s.cols.forEach(c=>{if(c.fixed)c.vis=true;});
      return s;
    }
  }catch(e){}
  return defState();
}

let _saveTimer=null;
function save(){
  const s={
    c:V('sc'),t:V('st'),pio:V('spio'),
    off:V('soff'),wrk:V('swrk'),ph1:V('sph1'),ph2:V('sph2'),
    fax:V('sfax'),mob:V('smob'),eml:V('seml'),
    cert1:V('scert1'),cert2:V('scert2'),cert3:V('scert3'),
    fmfg:V('sfmfg'),ffor:V('sffor'),fc:V('sfc'),
    sign:V('ssign'),
    cur:V('scur'),tax:V('stax'),disc:V('sdisc'),
    pay:V('s-pay'),warranty:V('s-warranty'),thanks:V('s-thanks'),notes:V('sn'),
    cols:JSON.parse(JSON.stringify(COLS.filter(c=>!c.custom))),
    customCols:JSON.parse(JSON.stringify(CUSTOM_COLS)),
    trows:JSON.parse(JSON.stringify(TROWS)),
    termItems:TERM_ITEMS.slice(),
    secVis:{
      payment: document.getElementById('tog-payment')?.checked !== false,
      warranty: document.getElementById('tog-warranty')?.checked !== false,
      thanks: document.getElementById('tog-thanks')?.checked !== false,
      notes: document.getElementById('tog-notes')?.checked === true,
    },
    sizeHdr:{
      bg:    document.getElementById('sh-bg')?.value    || '#1a1212',
      fg:    document.getElementById('sh-fg')?.value    || '#ffffff',
      fs:    document.getElementById('sh-fs')?.value    || '10',
      subBg: document.getElementById('sh-sub-bg')?.value|| '#273d4d',
      subFg: document.getElementById('sh-sub-fg')?.value|| '#8aabb8',
      subFs: document.getElementById('sh-sub-fs')?.value|| '9',
    },
    tableColors:{
      mainBg: document.getElementById('th-main-bg')?.value || '#1a1212',
      mainFg: document.getElementById('th-main-fg')?.value || '#faf8f5',
      mainFs: document.getElementById('th-main-fs')?.value || '10',
      tbFg:   document.getElementById('tb-fg')?.value     || '#1a1212',
      tbBord: document.getElementById('tb-border')?.value  || '#d0cbc3',
      tbAcc:  document.getElementById('tb-accent')?.value  || '#8b0000',
    },
    panelOpen:!document.getElementById('sbody').classList.contains('hide'),
    fsBase:parseFloat(document.getElementById('fs-base-r').value),
    fsSm:parseFloat(document.getElementById('fs-sm-r').value),
    fsSum:parseFloat(document.getElementById('fs-sum-r').value),
    fwBody:parseInt(document.getElementById('fw-body-r').value),
    fwLabel:parseInt(document.getElementById('fw-label-r').value),
    lh:parseFloat(document.getElementById('lh-r').value),
  };
  localStorage.setItem(LS,JSON.stringify(s));
  clearTimeout(_saveTimer);
  const d=document.getElementById('sdot'); d.classList.add('show');
  _saveTimer=setTimeout(()=>d.classList.remove('show'),1400);
}

function V(id){return document.getElementById(id)?.value||'';}
function setV(id,val){const el=document.getElementById(id);if(el)el.value=val;}
function fmtD(d){return d.toISOString().split('T')[0];}

function resetAll(){if(!confirm('Reset ALL to defaults?'))return;localStorage.removeItem(LS);localStorage.removeItem(LS_LOGO);location.reload();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function init(){
  const s=loadState();
  COLS        = mergeCustomCols(s.cols||JSON.parse(JSON.stringify(COL_DEFS)), s.customCols||[]);
  TROWS       = s.trows||JSON.parse(JSON.stringify(TROW_DEFS));
  CUSTOM_COLS = s.customCols||[];
  TERM_ITEMS  = s.termItems||TERM_DEFS.slice();

  setV('sc',s.c);setV('st',s.t);setV('spio',s.pio||'');
  setV('soff',s.off);setV('swrk',s.wrk);setV('sph1',s.ph1);setV('sph2',s.ph2);
  setV('sfax',s.fax);setV('smob',s.mob);setV('seml',s.eml);
  setV('scert1',s.cert1);setV('scert2',s.cert2);setV('scert3',s.cert3);
  setV('sfmfg',s.fmfg);setV('sffor',s.ffor);setV('sfc',s.fc);
  setV('ssign',s.sign);
  setV('scur',s.cur);setV('stax',s.tax);setV('sdisc',s.disc);
  setV('s-pay',s.pay||'');setV('s-warranty',s.warranty||'');setV('s-thanks',s.thanks||'');setV('sn',s.notes||'');

  // font sliders
  document.getElementById('fs-base-r').value=s.fsBase||13;
  document.getElementById('fs-sm-r').value=s.fsSm||11;
  document.getElementById('fs-sum-r').value=s.fsSum||14;
  document.getElementById('fw-body-r').value=s.fwBody||400;
  document.getElementById('fw-label-r').value=s.fwLabel||600;
  document.getElementById('lh-r').value=s.lh||1.55;
  // restore size header settings
  if(s.sizeHdr){
    const sh=s.sizeHdr;
    const sv=(id,v)=>{const el=document.getElementById(id);if(el)el.value=v;};
    sv('sh-bg',sh.bg||'#1a1212'); sv('sh-fg',sh.fg||'#ffffff'); sv('sh-fs',sh.fs||'10');
    sv('sh-sub-bg',sh.subBg||'#273d4d'); sv('sh-sub-fg',sh.subFg||'#8aabb8'); sv('sh-sub-fs',sh.subFs||'9');
  }
  // restore table colors
  if(s.tableColors){
    const tc=s.tableColors;
    const sv=(id,v)=>{const el=document.getElementById(id);if(el)el.value=v;};
    sv('th-main-bg',tc.mainBg||'#1a1212'); sv('th-main-fg',tc.mainFg||'#faf8f5'); sv('th-main-fs',tc.mainFs||'10');
    sv('tb-fg',tc.tbFg||'#1a1212'); sv('tb-border',tc.tbBord||'#d0cbc3'); sv('tb-accent',tc.tbAcc||'#8b0000');
  }
  updateFonts(true);
  updateTableColors(true);

  applyToDom(s);
  loadLogo();

  if(!s.panelOpen){
    document.getElementById('sbody').classList.add('hide');
    const a=document.getElementById('sarr'); a.textContent='‚ñº'; a.classList.add('closed');
  }

  const td=new Date();
  document.getElementById('mdate').value=fmtD(td);
  const vd=new Date(td); vd.setDate(vd.getDate()+30);
  document.getElementById('mvalid').value=fmtD(vd);
  document.getElementById('doc-date-text').value=td.toLocaleDateString('en-US',{month:'long',day:'2-digit',year:'numeric'}).replace(',','');

  // Restore section visibility from saved state
  const sv = s.secVis || {};
  ['payment','warranty','thanks','notes'].forEach(k => {
    const on = sv[k] !== undefined ? sv[k] : (k !== 'notes'); // notes off by default
    const chk = document.getElementById('tog-' + k);
    if(chk) chk.checked = on;
    toggleSection(k, on, true); // silent = no save on init
  });

  buildColManager(); buildWidthManager(); buildTrowsManager(); buildCustomColManager(); buildTermManager();
  renderHeaders(); addRow(); addRow(); addRow();
  renderSumBox(); renderTermsView();
  if(isMobile()) setTimeout(renderMobCards, 50);
}

function mergeCustomCols(cols,customCols){
  const filtered=cols.filter(c=>!c.custom);
  customCols.forEach(cc=>{
    filtered.push({key:cc.key,label:cc.label,vis:cc.vis!==false,w:cc.w||'auto',custom:true,showTotal:false});
  });
  return filtered;
}

function applyToDom(s){
  syncCompany();
  document.getElementById('dc-tag').textContent=s.t||'';
  document.getElementById('pioneer-text').textContent=s.pio||'';
  renderAddr();
  renderCerts();
  document.getElementById('dcc-main').textContent=s.fc||'';
  document.getElementById('sig-name-inp').value=s.sign||'';
  document.getElementById('doc-payment').value=s.pay||'';
  document.getElementById('doc-warranty').value=s.warranty||'';
  document.getElementById('doc-thanks').value=s.thanks||'';
  document.getElementById('doc-notes').value=s.notes||'';
  document.getElementById('doc-notes-wrap').style.display=(s.notes||'').trim()?'block':'none';
  document.getElementById('foot-mfg').innerHTML='<strong>MANUFACTURES:</strong> '+(s.fmfg||'');
  document.getElementById('foot-for').innerHTML='<strong>FOR:</strong> '+(s.ffor||'');
  updateCur(s.cur);
}

function syncCompany(){
  const v=V('sc');
  const parts=v.split(' ');
  const last=parts.pop()||'';
  const first=parts.join(' ');
  document.getElementById('dc-big').innerHTML=`<span>${first}</span> ${last}`;
}
function sync(k){
  if(k==='t') document.getElementById('dc-tag').textContent=V('st');
}
function renderAddr(){
  const el=document.getElementById('da');
  el.innerHTML=`
    <div><span class="lbl">Phone No:</span> ${V('sph1')} &nbsp; ${V('sph2')}</div>
    <div><span class="lbl">Mobile No:</span> ${V('smob')}</div>
  `;
}
function renderCerts(){
  const badges=document.getElementById('cert-badges'); badges.innerHTML='';
  [V('scert1'),V('scert2'),V('scert3')].filter(Boolean).forEach(b=>{
    const d=document.createElement('div'); d.className='cert-badge'; d.textContent=b; badges.appendChild(d);
  });
}
function updateCur(v){
  const c=v||V('scur')||'PKR';
  document.querySelectorAll('.cur').forEach(el=>el.textContent=c+' ');
}
function updateFonts(silent){
  const fsBase=document.getElementById('fs-base-r').value;
  const fsSm=document.getElementById('fs-sm-r').value;
  const fsSum=document.getElementById('fs-sum-r').value;
  const fwBody=document.getElementById('fw-body-r').value;
  const fwLabel=document.getElementById('fw-label-r').value;
  const lh=document.getElementById('lh-r').value;
  document.getElementById('fs-base-v').textContent=fsBase+'px';
  document.getElementById('fs-sm-v').textContent=fsSm+'px';
  document.getElementById('fs-sum-v').textContent=fsSum+'px';
  document.getElementById('fw-body-v').textContent=fwBody;
  document.getElementById('fw-label-v').textContent=fwLabel;
  document.getElementById('lh-v').textContent=lh;
  const root=document.documentElement;
  root.style.setProperty('--fs-base',fsBase+'px');
  root.style.setProperty('--fs-sm',fsSm+'px');
  root.style.setProperty('--fs-sum',fsSum+'px');
  root.style.setProperty('--fw-body',fwBody);
  root.style.setProperty('--fw-label',fwLabel);
  root.style.setProperty('--lh',lh);
  document.getElementById('font-preview').style.fontWeight=fwBody;
  if(!silent) save();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateTableColors(silent){
  const root=document.documentElement;
  const gv=(id,fb)=>{const el=document.getElementById(id);return el?el.value:fb;};
  const sv=(vid,val)=>{const el=document.getElementById(vid);if(el)el.textContent=val;};

  const mainBg=gv('th-main-bg','#1a1212');
  const mainFg=gv('th-main-fg','#faf8f5');
  const mainFs=gv('th-main-fs','10');
  const tbFg  =gv('tb-fg','#1a1212');
  const tbBord=gv('tb-border','#d0cbc3');
  const tbAcc =gv('tb-accent','#8b0000');

  root.style.setProperty('--th-main-bg', mainBg);
  root.style.setProperty('--th-main-fg', mainFg);
  root.style.setProperty('--th-main-fs', mainFs+'px');
  root.style.setProperty('--tb-fg',      tbFg);
  root.style.setProperty('--tb-border',  tbBord);
  root.style.setProperty('--tb-accent',  tbAcc);

  sv('th-main-bg-v',mainBg); sv('th-main-fg-v',mainFg);
  sv('th-main-fs-v',mainFs+'px');
  sv('tb-fg-v',tbFg); sv('tb-border-v',tbBord); sv('tb-acc-v',tbAcc);
  sv('tb-accent-v',tbAcc);

  // Re-render to pick up new main header colors
  renderHeaders();
  if(!silent) save();
}

/* section visibility toggle */
function toggleSection(key, visible, silent){
  const sec = document.getElementById('sec-' + key);
  if(sec) sec.style.display = visible ? '' : 'none';
  if(!silent) save();
}

function syncNotes(){
  const val = document.getElementById('sn').value;
  document.getElementById('doc-notes').value = val;
  const chk = document.getElementById('tog-notes');
  if(chk && !chk.checked && val.trim()){
    chk.checked = true;
    toggleSection('notes', true, true);
  }
  save();
}

function uploadLogo(e){
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader(); r.onload=ev=>{
    const i=document.getElementById('logo-display'); i.src=ev.target.result; i.style.display='block';
    document.getElementById('logo-ph').style.display='none';
    try{localStorage.setItem(LS_LOGO,ev.target.result);}catch(e){}
  }; r.readAsDataURL(f);
}
function removeLogo(){
  const i=document.getElementById('logo-display'); i.src=''; i.style.display='none';
  document.getElementById('logo-ph').style.display='flex';
  document.getElementById('li').value='';
  try{localStorage.removeItem(LS_LOGO);}catch(e){}
}
function loadLogo(){
  try{const src=localStorage.getItem(LS_LOGO);if(src){
    const i=document.getElementById('logo-display'); i.src=src; i.style.display='block';
    document.getElementById('logo-ph').style.display='none';
  }}catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleSP(){
  const b=document.getElementById('sbody'),a=document.getElementById('sarr');
  const h=b.classList.toggle('hide');
  a.classList.toggle('closed',h); a.textContent=h?'‚ñº':'‚ñ≤'; save();
}
function stab(name){
  const tabs=['company','columns','widths','totals','terms','font','table'];
  document.querySelectorAll('.stab').forEach((t,i)=>t.classList.toggle('active',tabs[i]===name));
  document.querySelectorAll('.spane').forEach(p=>p.classList.remove('active'));
  document.getElementById('pane-'+name).classList.add('active');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TERMS MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildTermManager(){
  const list=document.getElementById('tc-list'); list.innerHTML='';
  TERM_ITEMS.forEach((txt,i)=>{
    const item=document.createElement('div'); item.className='ti-item';
    item.innerHTML=`<input value="${txt.replace(/"/g,'&quot;')}" oninput="TERM_ITEMS[${i}]=this.value;renderTermsView();save()">
    <button class="ti-del" onclick="removeTermItem(${i})">‚úï</button>`;
    list.appendChild(item);
  });
}
function addTermItem(){
  TERM_ITEMS.push('New term');
  buildTermManager(); renderTermsView(); save();
}
function removeTermItem(i){
  TERM_ITEMS.splice(i,1);
  buildTermManager(); renderTermsView(); save();
}
function renderTermsView(){
  const ol=document.getElementById('terms-view-list'); ol.innerHTML='';
  TERM_ITEMS.forEach(txt=>{
    const li=document.createElement('li');
    // highlight numbers like 2840 Kg or 18% in accent color
    li.innerHTML=txt.replace(/(\d[\d,.]*\s*(Kg|kg|%|days|weeks))/g,'<span class="highlight">$1</span>');
    ol.appendChild(li);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLUMN MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildColManager(){
  const list=document.getElementById('clist'); list.innerHTML=''; list._tdBound=false;
  COLS.forEach(col=>{
    const item=document.createElement('div'); item.className='citem'; item.draggable=true; item.dataset.key=col.key;
    item.innerHTML=`<span class="cdh">‚ò∞</span>
      <span class="cname">${col.label}${col.custom?' <span style="color:#444;font-size:.53rem">[custom]</span>':''}</span>
      ${col.fixed?'<span class="cbadge">always on</span>':`<label class="tsw"><input type="checkbox" ${col.vis?'checked':''} onchange="colVis('${col.key}',this.checked)"><span class="tsl"></span></label>`}`;
    item.addEventListener('dragstart',e=>{_dragKey=col.key;item.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
    item.addEventListener('dragend',()=>{item.classList.remove('dragging');document.querySelectorAll('.citem').forEach(i=>i.classList.remove('drag-over'));});
    item.addEventListener('dragover',e=>{e.preventDefault();item.classList.add('drag-over');});
    item.addEventListener('dragleave',()=>item.classList.remove('drag-over'));
    item.addEventListener('drop',e=>{e.preventDefault();item.classList.remove('drag-over');colReorder(_dragKey,col.key);});
    list.appendChild(item);
  });
  setTimeout(()=>addTouchDrag('clist',(f,t)=>colReorder(f,t)),0);
}
let _dragKey=null;
function colVis(key,v){const c=COLS.find(x=>x.key===key);if(c&&!c.fixed)c.vis=v;renderHeaders();refreshRows();renderFootTotals();refreshMobCards();save();}
function colReorder(from,to){
  if(from===to)return;
  const fi=COLS.findIndex(c=>c.key===from),ti=COLS.findIndex(c=>c.key===to);
  const[m]=COLS.splice(fi,1);COLS.splice(ti,0,m);
  buildColManager();buildWidthManager();renderHeaders();refreshRows();renderFootTotals();refreshMobCards();save();
}
let _ccId=0;
function addCustomCol(label,w,key){
  _ccId++;
  const k=key||'cc_'+Date.now()+'_'+_ccId;
  const cc={key:k,label:label||'Column '+_ccId,w:w||'auto'};
  CUSTOM_COLS.push(cc);
  COLS.push({key:k,label:cc.label,vis:true,w:cc.w,custom:true,showTotal:false});
  buildCustomColManager();buildColManager();buildWidthManager();renderHeaders();refreshRows();refreshMobCards();renderFootTotals();save();
}
function removeCustomCol(key){
  CUSTOM_COLS=CUSTOM_COLS.filter(c=>c.key!==key);
  const idx=COLS.findIndex(c=>c.key===key);if(idx>=0)COLS.splice(idx,1);
  buildCustomColManager();buildColManager();buildWidthManager();renderHeaders();refreshRows();renderFootTotals();save();
}
function updateCustomColLabel(key,label){
  const cc=CUSTOM_COLS.find(c=>c.key===key);if(cc)cc.label=label;
  const col=COLS.find(c=>c.key===key);if(col)col.label=label;
  buildColManager();buildWidthManager();renderHeaders();refreshRows();save();
}
function buildCustomColManager(){
  const list=document.getElementById('cc-list');list.innerHTML='';
  CUSTOM_COLS.forEach(cc=>{
    const item=document.createElement('div');item.className='cc-item';
    item.innerHTML=`<input value="${cc.label}" placeholder="Column label" oninput="updateCustomColLabel('${cc.key}',this.value)" style="flex:1">
    <button class="cc-del" onclick="removeCustomCol('${cc.key}')">‚úï</button>`;
    list.appendChild(item);
  });
}
function buildWidthManager(){
  const g=document.getElementById('wgrid');g.innerHTML='';
  COLS.forEach(col=>{
    const d=document.createElement('div');d.className='wf';
    d.innerHTML=`<label>${col.label}</label><input value="${col.w||'auto'}" placeholder="auto" oninput="colW('${col.key}',this.value)">`;
    g.appendChild(d);
  });
}
function colW(key,val){const col=COLS.find(c=>c.key===key);if(col)col.w=val.trim()||'auto';renderHeaders();refreshRows();save();}
function getWpx(col){const v=col.w||'auto';if(!v||v==='auto')return '';return isNaN(v)?v:v+'px';}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOTAL ROWS MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _trDragId=null;
function buildTrowsManager(){
  const mgr=document.getElementById('trows-mgr');mgr.innerHTML='';
  TROWS.forEach(tr=>{
    const item=document.createElement('div');item.className='trow-item';item.draggable=!tr.fixed;item.dataset.id=tr.id;
    item.innerHTML=`${tr.fixed?'<span style="color:#222;font-size:.8rem">‚äò</span>':'<span class="cdh" style="cursor:grab">‚ò∞</span>'}
      <input class="trow-label-inp" value="${tr.label}" ${tr.fixed?'style="color:#444"':''} oninput="trLabel('${tr.id}',this.value)">
      <label class="tsw"><input type="checkbox" ${tr.vis?'checked':''} onchange="trVis('${tr.id}',this.checked)"><span class="tsl"></span></label>
      ${tr.fixed?'':'<button class="trow-del" onclick="trDel(\''+tr.id+'\')">‚úï</button>'}`;
    if(!tr.fixed){
      item.addEventListener('dragstart',e=>{_trDragId=tr.id;item.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
      item.addEventListener('dragend',()=>{item.classList.remove('dragging');document.querySelectorAll('.trow-item').forEach(i=>i.classList.remove('drag-over'));});
      item.addEventListener('dragover',e=>{e.preventDefault();item.classList.add('drag-over');});
      item.addEventListener('dragleave',()=>item.classList.remove('drag-over'));
      item.addEventListener('drop',e=>{e.preventDefault();item.classList.remove('drag-over');trReorder(_trDragId,tr.id);});
    }
    mgr.appendChild(item);
  });
  const mgr2 = document.getElementById('trows-mgr');
  if(mgr2) mgr2._tdBound = false;
  setTimeout(()=>addTouchDrag('trows-mgr',(f,t)=>trReorder(f,t)),0);
}
function trLabel(id,v){const r=TROWS.find(t=>t.id===id);if(r)r.label=v;renderSumBox();save();}
function trVis(id,v){const r=TROWS.find(t=>t.id===id);if(r)r.vis=v;renderSumBox();save();}
function trDel(id){TROWS=TROWS.filter(t=>t.id!==id);buildTrowsManager();renderSumBox();save();}
function trReorder(from,to){
  if(from===to)return;
  const fi=TROWS.findIndex(t=>t.id===from),ti=TROWS.findIndex(t=>t.id===to);
  const[m]=TROWS.splice(fi,1);TROWS.splice(ti,0,m);
  buildTrowsManager();renderSumBox();save();
}
function addTotalRow(){
  const id='tr_'+Date.now();
  TROWS.splice(TROWS.length-1,0,{id,label:'Custom Row',type:'custom',vis:true,fixed:false});
  buildTrowsManager();renderSumBox();save();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER HEADERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getSHVal(id, fallback){
  const el=document.getElementById(id);
  return el ? el.value : fallback;
}
function renderHeaders(){
  const sizeKeys=['dia','len','bore'];
  const visSizes=COLS.filter(c=>sizeKeys.includes(c.key)&&c.vis);
  const hasSizes=visSizes.length>0;

  // Read size-header style settings
  const shBg    = getSHVal('sh-bg','#1a1212');
  const shFg    = getSHVal('sh-fg','#ffffff');
  const shFs    = getSHVal('sh-fs','10');
  const shSubBg = getSHVal('sh-sub-bg','#273d4d');
  const shSubFg = getSHVal('sh-sub-fg','#8aabb8');
  const shSubFs = getSHVal('sh-sub-fs','9');

  // Update live color swatches
  function updSwatch(vid, val){ const el=document.getElementById(vid); if(el) el.textContent=val; }
  updSwatch('sh-bg-v',shBg); updSwatch('sh-fg-v',shFg);
  updSwatch('sh-sub-bg-v',shSubBg); updSwatch('sh-sub-fg-v',shSubFg);
  document.getElementById('sh-fs-v') && (document.getElementById('sh-fs-v').textContent=shFs+'px');
  document.getElementById('sh-sub-fs-v') && (document.getElementById('sh-sub-fs-v').textContent=shSubFs+'px');

  // Rebuild both header rows from scratch
  const thead=document.querySelector('#itable thead');
  thead.innerHTML='';

  const rowTop=document.createElement('tr');rowTop.className='thm';rowTop.id='thm';
  const rowSub=hasSizes ? document.createElement('tr') : null;
  if(rowSub){rowSub.id='ths';rowSub.style.background=shSubBg;}

  function mkTh(txt,opts={}){
    const th=document.createElement('th');
    th.textContent=txt||'';
    if(opts.w)     th.style.width=opts.w;
    if(opts.cls)   th.className=opts.cls;
    if(opts.span)  th.colSpan=opts.span;
    if(opts.color) th.style.color=opts.color;
    if(opts.bg)    th.style.background=opts.bg;
    if(opts.fs)    th.style.fontSize=opts.fs;
    if(opts.extra) Object.assign(th.style, opts.extra);
    return th;
  }
  function mkEmpty(w){
    const th=document.createElement('th');
    if(w) th.style.width=w;
    return th;
  }

  let sizeGroupAdded=false;

  COLS.forEach(col=>{
    if(!col.vis) return;
    const ws=getWpx(col);

    if(sizeKeys.includes(col.key)){
      if(!sizeGroupAdded){
        const grpTh=mkTh('SIZE (IN/MM PER FIELD)',{
          cls:'ctr', span:visSizes.length,
          bg:shBg, color:shFg, fs:shFs+'px',
          extra:{letterSpacing:'2px',fontWeight:'700'}
        });
        rowTop.appendChild(grpTh);
        sizeGroupAdded=true;
      }
      if(rowSub){
        const subTh=mkTh(col.label,{
          cls:'ctr', w:ws,
          color:shSubFg, fs:shSubFs+'px',
          extra:{letterSpacing:'1px',fontWeight:'500',padding:'4px 6px',borderRight:'1px solid rgba(255,255,255,.08)'}
        });
        rowSub.appendChild(subTh);
      }
    } else {
      const cls=['weight','qty','rate','amount'].includes(col.key)?'rgt':'';
      rowTop.appendChild(mkTh(col.label,{cls,w:ws}));
      if(rowSub) rowSub.appendChild(mkEmpty(ws));
    }
  });

  rowTop.appendChild(mkTh('',{w:'22px'}));
  if(rowSub) rowSub.appendChild(mkEmpty('22px'));

  thead.appendChild(rowTop);
  if(rowSub) thead.appendChild(rowSub);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROWS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function makeSizeCell(){
  const w=document.createElement('div');w.className='size-td-wrap';
  const inp=document.createElement('input');inp.type='text';inp.placeholder='‚Äî';
  let unit='in';
  const lbl=document.createElement('span');lbl.className='ulbl';lbl.textContent='in';
  const tog=document.createElement('div');tog.className='utog';
  const bI=document.createElement('button');bI.textContent='in';bI.type='button';bI.className='active';
  const bM=document.createElement('button');bM.textContent='mm';bM.type='button';
  function su(u){unit=u;lbl.textContent=u;bI.classList.toggle('active',u==='in');bM.classList.toggle('active',u==='mm');}
  bI.onclick=()=>su('in');bM.onclick=()=>su('mm');
  tog.appendChild(bI);tog.appendChild(bM);
  w.appendChild(inp);w.appendChild(tog);w.appendChild(lbl);
  return w;
}

function buildCells(n){
  const cells={};
  // S.No
  const tsno=document.createElement('td');tsno.className='sno-td';tsno.dataset.col='sno';
  const isno=document.createElement('input');isno.type='text';isno.value=n;isno.style.cssText='width:100%;text-align:center;font-size:var(--fs-xs);color:#666;';
  tsno.appendChild(isno);cells['sno']=tsno;
  // desc
  const tdesc=document.createElement('td');tdesc.dataset.col='desc';
  const idesc=document.createElement('input');idesc.type='text';idesc.placeholder='e.g. √ò330√ó280√ó117mm Ni-Cr-Mn-Mo-Cu Chilled Cast Iron';idesc.style.width='100%';tdesc.appendChild(idesc);
  cells['desc']=tdesc;
  // stand
  const tstand=document.createElement('td');tstand.dataset.col='stand';
  const istand=document.createElement('input');istand.type='text';istand.placeholder='FM';istand.style.width='100%';tstand.appendChild(istand);
  cells['stand']=tstand;
  // casting
  const tcast=document.createElement('td');tcast.dataset.col='casting';
  const icast=document.createElement('input');icast.type='text';icast.placeholder='Centrifugally cast';icast.style.width='100%';tcast.appendChild(icast);
  cells['casting']=tcast;
  // hardness
  const thard=document.createElement('td');thard.dataset.col='hardness';
  const ihard=document.createElement('input');ihard.type='text';ihard.placeholder='70-75¬∞SH';ihard.style.width='100%';thard.appendChild(ihard);
  cells['hardness']=thard;
  // size cols
  ['dia','len','bore'].forEach(k=>{const t=document.createElement('td');t.dataset.col=k;t.appendChild(makeSizeCell());cells[k]=t;});
  // weight
  const tw=document.createElement('td');tw.dataset.col='weight';
  const iw=document.createElement('input');iw.type='number';iw.className='wgt';iw.value='0';iw.min='0';iw.step='0.001';iw.oninput=calc;iw.style.width='100%';tw.appendChild(iw);
  cells['weight']=tw;
  // qty
  const tq=document.createElement('td');tq.dataset.col='qty';
  const iq=document.createElement('input');iq.type='number';iq.className='qqty';iq.value='1';iq.min='0';iq.oninput=calc;iq.style.width='100%';tq.appendChild(iq);
  cells['qty']=tq;
  // unit
  const tu=document.createElement('td');tu.dataset.col='unit';
  const su=document.createElement('select');su.style.cssText='width:100%;border:none;background:transparent;font-family:Barlow,sans-serif;font-size:var(--fs-sm);color:var(--ink);outline:none;';
  ['Pcs','Kg','MT','Set','Lot'].forEach(u=>{const o=document.createElement('option');o.textContent=u;su.appendChild(o);});tu.appendChild(su);
  cells['unit']=tu;
  // rate
  const tr2=document.createElement('td');tr2.dataset.col='rate';
  const ir=document.createElement('input');ir.type='number';ir.className='rrate';ir.value='0';ir.min='0';ir.step='0.01';ir.oninput=calc;ir.style.width='100%';tr2.appendChild(ir);
  cells['rate']=tr2;
  // amount
  const ta=document.createElement('td');ta.dataset.col='amount';ta.className='amt-td';
  ta.innerHTML='<span class="amt-val">‚Äî</span><span class="rate-note amt-note"></span>';
  cells['amount']=ta;
  // delete
  const tx=document.createElement('td');
  const bx=document.createElement('button');bx.className='del-btn';bx.textContent='‚úï';bx.onclick=()=>delRow(n);tx.appendChild(bx);
  cells['delete']=tx;
  return cells;
}

function renderRow(tr,n){
  const cells=tr._cells||(tr._cells=buildCells(n));
  // Detach all children ‚Äî we rebuild from scratch each call
  while(tr.firstChild)tr.removeChild(tr.firstChild);

  COLS.forEach(col=>{
    if(!col.vis) return; // skip hidden cols entirely (not display:none ‚Äî that breaks table layout)

    let td=cells[col.key];
    if(!td){
      if(col.custom){
        const ctd=document.createElement('td');ctd.dataset.col=col.key;
        const ci=document.createElement('input');ci.type='text';ci.style.width='100%';ci.placeholder='‚Äî';
        ctd.appendChild(ci);cells[col.key]=ctd;td=ctd;
      } else return;
    }

    // Remove any stale display:none from previous renders
    td.style.display='';
    const ws=getWpx(col);if(ws)td.style.width=ws;else td.style.width='';
    tr.appendChild(td);
  });

  tr.appendChild(cells['delete']);
}

function addRow(){
  rc++;const n=rc;
  const tr=document.createElement('tr');tr.id='r'+n;
  tr._cells=buildCells(n);
  renderRow(tr,n);
  document.getElementById('tbody').appendChild(tr);
  // Also add mobile card if on mobile
  if(isMobile()){
    const card=buildMobCard(n);
    const container=document.getElementById('mob-card-container');
    if(container) container.appendChild(card);
  }
  calc();
}
function delRow(n){
  const el=document.getElementById('r'+n);if(el)el.remove();
  // Remove mobile card if exists
  const card=_cards[n];
  if(card&&card.parentNode) card.parentNode.removeChild(card);
  delete _cards[n];
  calc();
}
function refreshRows(){document.querySelectorAll('#tbody tr').forEach(tr=>{if(tr._cells){const n=parseInt(tr.id.replace('r',''));renderRow(tr,n);}});calc();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function calc(){
  let sub=0,totWt=0,totQty=0;
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const w=parseFloat(tr.querySelector('.wgt')?.value||0);
    const q=parseFloat(tr.querySelector('.qqty')?.value||0);
    const r=parseFloat(tr.querySelector('.rrate')?.value||0);
    const amt=w*r;
    const av=tr.querySelector('.amt-val');if(av)av.textContent=amt>0?'PKR '+fmt(amt):'‚Äî';
    const an=tr.querySelector('.amt-note');if(an)an.textContent=r>0?'PKR '+fmt(r)+'/kg':'';
    sub+=amt;totWt+=w;totQty+=q;
  });
  window._sub=sub;window._totWt=totWt;window._totQty=totQty;
  renderFootTotals(totQty,totWt,sub);
  renderSumBox();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FOOT TOTALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderFootTotals(totQty,totWt,sub){
  totQty=totQty!==undefined?totQty:(window._totQty||0);
  totWt=totWt!==undefined?totWt:(window._totWt||0);
  sub=sub!==undefined?sub:(window._sub||0);
  const tfoot=document.getElementById('tfoot-row');tfoot.innerHTML='';
  const sizeKeys=['dia','len','bore'];
  const visSizes=COLS.filter(c=>sizeKeys.includes(c.key)&&c.vis);
  let sizeGroupAdded=false;

  COLS.forEach(col=>{
    if(!col.vis)return;

    if(sizeKeys.includes(col.key)){
      if(!sizeGroupAdded){
        // One td spanning all visible size cols with label
        const td=document.createElement('td');
        td.colSpan=visSizes.length;
        td.className='tot-label';
        td.textContent='COLUMN TOTALS ‚Üì';
        tfoot.appendChild(td);
        sizeGroupAdded=true;
      }
      return; // skip individual size cols ‚Äî already grouped
    }

    const td=document.createElement('td');
    if(col.key==='weight'){
      td.style.textAlign='right';
      td.innerHTML=`<strong>${fmt(totWt)}</strong><div style="font-size:.57rem;color:#888">kg total</div>`;
    } else if(col.key==='qty'){
      td.style.textAlign='right';
      td.innerHTML=`<strong>${fmt(totQty)}</strong><div style="font-size:.57rem;color:#888">qty total</div>`;
    } else if(col.key==='amount'){
      td.style.textAlign='right';
      td.innerHTML=`<strong style="color:var(--accent)">${fmt(sub)}</strong><div style="font-size:.57rem;color:#888">subtotal</div>`;
    } else if(col.key==='desc'){
      td.className='tot-label';td.textContent='TOTALS:';
    }
    tfoot.appendChild(td);
  });
  const tdel=document.createElement('td');tfoot.appendChild(tdel);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUM BOX ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSumBox(){
  const sub=window._sub||0;
  const box=document.getElementById('sumbox');
  const cur=V('scur')||'PKR';
  const disc=parseFloat(document.querySelector('#sumbox [data-type="discount"] input')?.value||V('sdisc')||0);
  const tax=parseFloat(document.querySelector('#sumbox [data-type="tax"] input')?.value||V('stax')||18);
  const afterDisc=sub*(1-disc/100);
  const afterTax=afterDisc*(1+tax/100);
  box.innerHTML='';
  TROWS.forEach(tr=>{
    const row=document.createElement('div');
    row.className='srow'+(tr.type==='grand'?' grand':'');
    row.dataset.type=tr.type;
    if(!tr.vis)row.classList.add('disabled');
    if(tr.type==='subtotal'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(sub)}</span>`;
    } else if(tr.type==='discount'){
      row.innerHTML=`<label>${tr.label} (%)</label><span class="sv"><input type="number" value="${V('sdisc')||0}" min="0" max="100" oninput="renderSumBox()"> %</span>`;
    } else if(tr.type==='tax'){
      row.innerHTML=`<label>${tr.label} (%)</label><span class="sv"><input type="number" value="${V('stax')||18}" min="0" oninput="renderSumBox()"> %</span>`;
    } else if(tr.type==='aftertax'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(afterTax)}</span>`;
    } else if(tr.type==='grand'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(afterTax)}</span>`;
    } else if(tr.type==='custom'){
      row.innerHTML=`<label><input type="text" value="${tr.label}" oninput="trLabel('${tr.id}',this.value)" style="width:110px;border:none;background:transparent;color:#555;font-family:Barlow,sans-serif;font-size:.78rem;outline:none"></label><span class="sv">‚Äî</span>`;
    }
    box.appendChild(row);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetForm(){
  if(!confirm('Clear all items? Settings kept.'))return;
  document.getElementById('tbody').innerHTML='';rc=0;
  document.getElementById('cust').value='';document.getElementById('cust-org').value='';
  addRow();addRow();addRow();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF PREVIEW & DOWNLOAD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _pdfCanvas = null; // cached canvas for download without re-render

async function _renderForPDF(){
  // ‚îÄ‚îÄ Step 1: Sync ALL mobile card values ‚Üí hidden desktop rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const n=parseInt(tr.id.replace('r',''));
    if(isNaN(n)||!_cards[n]) return;
    const card=_cards[n];
    // Sync every data-mc field dynamically (works with any visible column set)
    card.querySelectorAll('[data-mc]').forEach(mInp=>{
      const key=mInp.dataset.mc;
      // Special class-based numeric fields
      if(mInp.classList.contains('mc-wgt')){
        const el=tr._cells&&tr._cells['weight']?.querySelector('.wgt');
        if(el) el.value=mInp.value||0;
      } else if(mInp.classList.contains('mc-rate')){
        const el=tr._cells&&tr._cells['rate']?.querySelector('.rrate');
        if(el) el.value=mInp.value||0;
      } else if(mInp.classList.contains('mc-qty')){
        const el=tr._cells&&tr._cells['qty']?.querySelector('.qqty');
        if(el) el.value=mInp.value||1;
      } else {
        // Generic text/select sync
        const el=tr._cells&&tr._cells[key]?.querySelector('input,select');
        if(el) el.value=mInp.value;
      }
    });
  });
  calc(); // refresh amounts with synced values

  // ‚îÄ‚îÄ Step 2: Force desktop layout by injecting an override <style> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // inline style cannot beat !important in media queries, so we use a <style> tag
  const overrideStyle=document.createElement('style');
  overrideStyle.id='_pdf_override';
  overrideStyle.textContent=`
    .twrap{display:block!important;overflow:visible!important;}
    .add-btn{display:none!important;}
    #mob-card-container{display:none!important;}
    .mob-add-btn{display:none!important;}
    #SP{display:none!important;}
    .del-btn{display:none!important;}
    .utog{display:none!important;}
    .ulbl{display:inline!important;}
    .srow.disabled{display:none!important;}
  `;
  document.head.appendChild(overrideStyle);

  // Fix QD width so it renders at desktop size
  const QD=document.getElementById('QD');
  const origW=QD.style.width, origMW=QD.style.maxWidth;
  QD.style.width='860px'; QD.style.maxWidth='860px';

  // Give browser a full paint cycle to apply styles
  await new Promise(r=>setTimeout(r,200));

  let canvas;
  try {
    canvas = await html2canvas(QD,{
      scale:1.6, useCORS:true, backgroundColor:'#faf8f5',
      logging:false, width:860,
      ignoreElements: el => el.id==='SP' || el.id==='mob-card-container' || el.classList.contains('mob-add-btn')
    });
  } finally {
    // ‚îÄ‚îÄ Step 3: Restore everything ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ov=document.getElementById('_pdf_override');
    if(ov) ov.remove();
    QD.style.width=origW;
    QD.style.maxWidth=origMW;
  }
  return canvas;
}

async function openPDFPreview(){
  const modal=document.getElementById('pdf-modal');
  const loading=document.getElementById('pdf-loading');
  const pages=document.getElementById('pdf-pages');
  modal.classList.add('open');
  loading.style.display='block';
  pages.style.display='none';
  pages.innerHTML='';
  _pdfCanvas=null;

  try {
    const canvas=await _renderForPDF();
    _pdfCanvas=canvas;

    // A4 aspect ratio: 210/297
    const A4_RATIO=297/210;
    const pageW=canvas.width;
    const pageH=Math.floor(pageW*A4_RATIO);
    const totalPages=Math.ceil(canvas.height/pageH);

    for(let p=0;p<totalPages;p++){
      const pageCanvas=document.createElement('canvas');
      pageCanvas.width=pageW;
      pageCanvas.height=Math.min(pageH, canvas.height - p*pageH);
      const ctx=pageCanvas.getContext('2d');
      ctx.fillStyle='#faf8f5';
      ctx.fillRect(0,0,pageCanvas.width,pageCanvas.height);
      ctx.drawImage(canvas, 0, -p*pageH);
      const img=document.createElement('img');
      img.className='pdf-page-img';
      img.src=pageCanvas.toDataURL('image/jpeg',0.88);
      if(totalPages>1){
        const lbl=document.createElement('div');
        lbl.style.cssText='color:#666;font-family:Barlow Condensed,sans-serif;font-size:.65rem;letter-spacing:2px;text-transform:uppercase;text-align:center;margin-bottom:4px;';
        lbl.textContent='Page '+(p+1)+' of '+totalPages;
        pages.appendChild(lbl);
      }
      pages.appendChild(img);
    }
    loading.style.display='none';
    pages.style.display='flex';
  } catch(err){
    loading.textContent='Error generating preview. Try downloading directly.';
    loading.style.cssText='color:#c44;font-family:Barlow Condensed,sans-serif;font-size:.8rem;letter-spacing:1px;padding:40px;text-align:center;';
    const fallback=document.createElement('button');
    fallback.className='btn-pdf-dl';
    fallback.style.cssText='margin:12px auto;display:block;padding:12px 24px;font-size:.8rem;';
    fallback.textContent='Download Without Preview';
    fallback.onclick=()=>{closePDFPreview();downloadPDF();};
    pages.appendChild(fallback);
    pages.style.display='flex';
    console.error('PDF preview error:',err);
  }
}

function closePDFPreview(){
  document.getElementById('pdf-modal').classList.remove('open');
  document.getElementById('pdf-pages').innerHTML='';
  _pdfCanvas=null;
}

async function confirmDownloadPDF(){
  const btn=document.getElementById('pdf-dl-btn');
  btn.textContent='‚è≥ Saving‚Ä¶';
  btn.disabled=true;
  try {
    let canvas=_pdfCanvas;
    if(!canvas){ canvas=await _renderForPDF(); }
    const flat=document.createElement('canvas');
    flat.width=canvas.width; flat.height=canvas.height;
    const ctx=flat.getContext('2d');
    ctx.fillStyle='#faf8f5'; ctx.fillRect(0,0,flat.width,flat.height);
    ctx.drawImage(canvas,0,0);
    const img=flat.toDataURL('image/jpeg',0.84);
    const{jsPDF}=window.jspdf;
    const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4',compress:true});
    const pw=pdf.internal.pageSize.getWidth(),ph=pdf.internal.pageSize.getHeight();
    const ih=flat.height*pw/flat.width;
    if(ih<=ph){pdf.addImage(img,'JPEG',0,0,pw,ih,undefined,'FAST');}
    else{let y=0;while(y<ih){pdf.addImage(img,'JPEG',0,-y,pw,ih,undefined,'FAST');y+=ph;if(y<ih)pdf.addPage();}}
    pdf.save(`${(V('sc')||'Quote').replace(/\s+/g,'_')}_${V('qref')||'QT'}.pdf`);
    closePDFPreview();
  } finally {
    btn.textContent='‚¨á Download PDF';
    btn.disabled=false;
  }
}

async function downloadPDF(){
  // Direct download without preview ‚Äî still uses _renderForPDF for correct syncing
  const btn = document.querySelector('.btn-pdf');
  if(btn){ btn.textContent='‚è≥ Rendering‚Ä¶'; btn.disabled=true; }
  try {
    const canvas = await _renderForPDF();
    const flat=document.createElement('canvas');
    flat.width=canvas.width; flat.height=canvas.height;
    const ctx=flat.getContext('2d');
    ctx.fillStyle='#faf8f5'; ctx.fillRect(0,0,flat.width,flat.height);
    ctx.drawImage(canvas,0,0);
    const img=flat.toDataURL('image/jpeg',0.84);
    const{jsPDF}=window.jspdf;
    const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4',compress:true});
    const pw=pdf.internal.pageSize.getWidth(),ph=pdf.internal.pageSize.getHeight();
    const ih=flat.height*pw/flat.width;
    if(ih<=ph){pdf.addImage(img,'JPEG',0,0,pw,ih,undefined,'FAST');}
    else{let y=0;while(y<ih){pdf.addImage(img,'JPEG',0,-y,pw,ih,undefined,'FAST');y+=ph;if(y<ih)pdf.addPage();}}
    pdf.save(`${(V('sc')||'Quote').replace(/\s+/g,'_')}_${V('qref')||'QT'}.pdf`);
  } finally {
    if(btn){ btn.textContent='üëÅ Preview & Download PDF'; btn.disabled=false; }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT/IMPORT/SHARE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getSettingsObj(){
  return{
    c:V('sc'),t:V('st'),pio:V('spio'),
    off:V('soff'),wrk:V('swrk'),ph1:V('sph1'),ph2:V('sph2'),
    fax:V('sfax'),mob:V('smob'),eml:V('seml'),
    cert1:V('scert1'),cert2:V('scert2'),cert3:V('scert3'),
    fmfg:V('sfmfg'),ffor:V('sffor'),fc:V('sfc'),sign:V('ssign'),
    cur:V('scur'),tax:V('stax'),disc:V('sdisc'),
    pay:V('s-pay'),warranty:V('s-warranty'),thanks:V('s-thanks'),notes:V('sn'),
    cols:JSON.parse(JSON.stringify(COLS.filter(c=>!c.custom))),
    customCols:JSON.parse(JSON.stringify(CUSTOM_COLS)),
    trows:JSON.parse(JSON.stringify(TROWS)),
    termItems:TERM_ITEMS.slice(),
    secVis:{
      payment: document.getElementById('tog-payment')?.checked !== false,
      warranty: document.getElementById('tog-warranty')?.checked !== false,
      thanks: document.getElementById('tog-thanks')?.checked !== false,
      notes: document.getElementById('tog-notes')?.checked === true,
    },
    sizeHdr:{
      bg:    document.getElementById('sh-bg')?.value    || '#1a1212',
      fg:    document.getElementById('sh-fg')?.value    || '#ffffff',
      fs:    document.getElementById('sh-fs')?.value    || '10',
      subBg: document.getElementById('sh-sub-bg')?.value|| '#273d4d',
      subFg: document.getElementById('sh-sub-fg')?.value|| '#8aabb8',
      subFs: document.getElementById('sh-sub-fs')?.value|| '9',
    },
    tableColors:{
      mainBg: document.getElementById('th-main-bg')?.value || '#1a1212',
      mainFg: document.getElementById('th-main-fg')?.value || '#faf8f5',
      mainFs: document.getElementById('th-main-fs')?.value || '10',
      tbFg:   document.getElementById('tb-fg')?.value     || '#1a1212',
      tbBord: document.getElementById('tb-border')?.value  || '#d0cbc3',
      tbAcc:  document.getElementById('tb-accent')?.value  || '#8b0000',
    },
    panelOpen:!document.getElementById('sbody').classList.contains('hide'),
    fsBase:parseFloat(document.getElementById('fs-base-r').value),
    fsSm:parseFloat(document.getElementById('fs-sm-r').value),
    fsSum:parseFloat(document.getElementById('fs-sum-r').value),
    fwBody:parseInt(document.getElementById('fw-body-r').value),
    fwLabel:parseInt(document.getElementById('fw-label-r').value),
    lh:parseFloat(document.getElementById('lh-r').value),
  };
}
function exportSettings(){
  const blob=new Blob([JSON.stringify(getSettingsObj(),null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='mrspk-settings.json';a.click();URL.revokeObjectURL(url);
}
function importSettings(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{try{const s=JSON.parse(ev.target.result);localStorage.setItem(LS,JSON.stringify(s));alert('Settings imported! Reloading‚Ä¶');location.reload();}catch(err){alert('Invalid settings file.');}};
  reader.readAsText(file);e.target.value='';
}
function copyShareLink(){
  const encoded=btoa(unescape(encodeURIComponent(JSON.stringify(getSettingsObj()))));
  const url=location.href.split('#')[0]+'#settings='+encoded;
  navigator.clipboard.writeText(url).then(()=>{
    const btn=document.getElementById('share-btn');const orig=btn.textContent;
    btn.textContent='‚úì Link Copied!';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent=orig;btn.classList.remove('copied');},2500);
  }).catch(()=>prompt('Copy this link:',url));
}
function loadFromUrlHash(){
  try{const hash=location.hash;if(hash.startsWith('#settings=')){const encoded=hash.slice('#settings='.length);const s=JSON.parse(decodeURIComponent(escape(atob(encoded))));localStorage.setItem(LS,JSON.stringify(s));history.replaceState(null,'',location.pathname+location.search);return true;}}catch(e){}return false;
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE CARD TABLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Map from row id -> card element
const _cards = {};

function isMobile(){ return window.innerWidth <= 680; }

/* Build one field div for a column */
function _mobField(col, n, isFull){
  const wrap = document.createElement('div');
  wrap.className = 'mob-card-field' + (isFull ? ' full' : '');
  wrap.dataset.mcCol = col.key; // so we can hide/show it when cols change

  const lbl = document.createElement('span');
  lbl.className = 'mob-card-lbl';
  lbl.textContent = col.label;
  wrap.appendChild(lbl);

  const sizeKeys = ['dia','len','bore'];

  if(col.key === 'amount'){
    // Amount is read-only display
    const amtRow = document.createElement('div');
    amtRow.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
    const amt = document.createElement('div');
    amt.className = 'mob-card-amt'; amt.id = 'mc-amt-' + n; amt.textContent = '‚Äî';
    const rn = document.createElement('div');
    rn.className = 'mob-card-rate-note'; rn.id = 'mc-rn-' + n;
    amtRow.appendChild(amt); amtRow.appendChild(rn);
    wrap.appendChild(amtRow);
  } else if(col.key === 'unit'){
    const sel = document.createElement('select');
    sel.dataset.mc = col.key;
    sel.style.cssText = 'border:none;border-bottom:1.5px solid var(--mgray);background:transparent;font-family:Barlow,sans-serif;font-size:1rem;color:var(--ink);outline:none;padding:5px 0;width:100%;min-height:36px;-webkit-appearance:none;';
    ['Pcs','Kg','MT','Set','Lot'].forEach(u=>{const o=document.createElement('option');o.textContent=u;sel.appendChild(o);});
    wrap.appendChild(sel);
  } else if(sizeKeys.includes(col.key)){
    // Size field: two inputs in/mm side by side
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;gap:6px;align-items:center;';
    const inp1 = document.createElement('input');
    inp1.type = 'number'; inp1.placeholder = 'in'; inp1.inputMode = 'decimal';
    inp1.dataset.mc = col.key + '_in';
    inp1.style.cssText = 'flex:1;border:none;border-bottom:1.5px solid var(--mgray);background:transparent;font-family:Barlow,sans-serif;font-size:1rem;color:var(--ink);outline:none;padding:5px 0;min-width:40px;text-align:right;';
    const sep = document.createElement('span');
    sep.textContent = '/'; sep.style.cssText = 'color:#bbb;font-size:.8rem;';
    const inp2 = document.createElement('input');
    inp2.type = 'number'; inp2.placeholder = 'mm'; inp2.inputMode = 'decimal';
    inp2.dataset.mc = col.key + '_mm';
    inp2.style.cssText = inp1.style.cssText;
    const uLbl = document.createElement('span');
    uLbl.textContent = 'in/mm'; uLbl.style.cssText = 'font-size:.6rem;color:#aaa;font-family:Barlow Condensed,sans-serif;white-space:nowrap;';
    row.appendChild(inp1); row.appendChild(sep); row.appendChild(inp2); row.appendChild(uLbl);
    wrap.appendChild(row);
  } else if(col.numeric || col.isQty || col.key === 'weight' || col.key === 'rate'){
    const inp = document.createElement('input');
    inp.type = 'number';
    inp.dataset.mc = col.key;
    inp.inputMode = 'decimal';
    inp.style.cssText = 'border:none;border-bottom:1.5px solid var(--mgray);background:transparent;font-family:Barlow,sans-serif;font-size:1rem;color:var(--ink);outline:none;padding:5px 0;width:100%;min-height:36px;text-align:right;';
    if(col.isQty || col.key === 'qty') { inp.value = '1'; inp.min = '0'; inp.className = 'mc-qty'; }
    else if(col.key === 'weight') { inp.value = '0'; inp.min = '0'; inp.step = '0.001'; inp.className = 'mc-wgt'; }
    else if(col.key === 'rate') { inp.value = '0'; inp.min = '0'; inp.step = '0.01'; inp.className = 'mc-rate'; }
    else { inp.value = '0'; inp.min = '0'; }
    inp.addEventListener('input', ()=>calcCard(n));
    wrap.appendChild(inp);
  } else {
    // Text field (desc, stand, casting, hardness, sno, custom cols)
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.dataset.mc = col.key;
    inp.style.cssText = 'border:none;border-bottom:1.5px solid var(--mgray);background:transparent;font-family:Barlow,sans-serif;font-size:1rem;color:var(--ink);outline:none;padding:5px 0;width:100%;min-height:36px;';
    // Placeholders for known fields
    const ph = {desc:'e.g. Chilled Rolls √ò330√ó280√ó117mm‚Ä¶', stand:'FM', casting:'Centrifugally cast', hardness:'70-75¬∞SH', sno:'1'};
    if(ph[col.key]) inp.placeholder = ph[col.key];
    if(col.key === 'desc'){
      inp.addEventListener('input', ()=>{
        const t = document.getElementById('mc-title-'+n);
        if(t) t.textContent = inp.value.slice(0,32) || 'Roll Description';
      });
    }
    wrap.appendChild(inp);
  }
  return wrap;
}

function buildMobCard(n){
  const card = document.createElement('div');
  card.className = 'mob-card-row';
  card.id = 'mc' + n;

  // Header
  const hdr = document.createElement('div');
  hdr.className = 'mob-card-hdr';
  hdr.innerHTML = `<span class="mob-card-sno">Item #${n}</span><span class="mob-card-stitle" id="mc-title-${n}">Roll Description</span>`;
  card.appendChild(hdr);

  // Delete button
  const del = document.createElement('button');
  del.className = 'mob-card-del';
  del.textContent = '‚úï';
  del.onclick = ()=>delRow(n);
  card.appendChild(del);

  // Grid
  const grid = document.createElement('div');
  grid.className = 'mob-card-grid';
  card.appendChild(grid);

  const sizeKeys = ['dia','len','bore'];

  // Render fields for each VISIBLE column (respects settings)
  // Skip 'sno' (shown in header) and 'amount' (shown at bottom always)
  COLS.forEach(col => {
    if(!col.vis) return;
    if(col.key === 'sno') return; // shown in header badge
    if(col.key === 'amount') return; // shown at bottom

    // Size columns: show all three together in one full-width field
    if(sizeKeys.includes(col.key)){
      // Only add once (the first visible size col triggers a combined field)
      if(grid.querySelector('[data-mc-col="dia"],[data-mc-col="len"],[data-mc-col="bore"]')) return;
      const visSizes = COLS.filter(c=>sizeKeys.includes(c.key)&&c.vis);
      visSizes.forEach(sc => {
        const f = _mobField(sc, n, false);
        grid.appendChild(f);
      });
      return;
    }

    const isFull = (col.key === 'desc');
    const f = _mobField(col, n, isFull);
    grid.appendChild(f);
  });

  // Amount row always at bottom
  const amtRow = document.createElement('div');
  amtRow.className = 'mob-card-amt-row';
  amtRow.innerHTML = `<span class="mob-card-amt-lbl">Amount</span><div><div class="mob-card-amt" id="mc-amt-${n}">‚Äî</div><div class="mob-card-rate-note" id="mc-rn-${n}"></div></div>`;
  grid.appendChild(amtRow);

  _cards[n] = card;
  return card;
}

/* Rebuild all visible mobile cards to reflect current COLS state */
function refreshMobCards(){
  if(!isMobile()) return;
  const rows = document.querySelectorAll('#tbody tr');
  rows.forEach(tr => {
    const n = parseInt(tr.id.replace('r',''));
    if(isNaN(n)) return;
    // Save current values from old card
    const oldCard = _cards[n];
    const savedVals = {};
    if(oldCard){
      oldCard.querySelectorAll('[data-mc]').forEach(inp => {
        savedVals[inp.dataset.mc] = inp.value;
      });
    }
    // Build new card
    const newCard = buildMobCard(n);
    // Restore saved values
    newCard.querySelectorAll('[data-mc]').forEach(inp => {
      if(savedVals[inp.dataset.mc] !== undefined) inp.value = savedVals[inp.dataset.mc];
    });
    // Also restore from desktop cells if available
    if(tr._cells){
      ['desc','stand','casting','hardness','qty','weight','rate','unit','sno'].forEach(k=>{
        const dInp = tr._cells[k]?.querySelector('input,select');
        const mInp = newCard.querySelector('[data-mc="'+k+'"]');
        if(dInp && mInp && !savedVals[k]) mInp.value = dInp.value;
      });
    }
    // Replace in DOM
    if(oldCard && oldCard.parentNode){
      oldCard.parentNode.replaceChild(newCard, oldCard);
    } else {
      const container = document.getElementById('mob-card-container');
      if(container) container.appendChild(newCard);
    }
    calcCard(n);
  });
}

function calcCard(n){
  const card = _cards[n]; if(!card) return;
  const w = parseFloat(card.querySelector('.mc-wgt')?.value || 0);
  const r = parseFloat(card.querySelector('.mc-rate')?.value || 0);
  const q = parseFloat(card.querySelector('.mc-qty')?.value || 1);
  const amt = w * r;
  const cur = V('scur')||'PKR';
  const el = document.getElementById('mc-amt-' + n);
  if(el) el.textContent = amt > 0 ? cur + ' ' + fmt(amt) : '‚Äî';
  const rn = document.getElementById('mc-rn-' + n);
  if(rn) rn.textContent = r > 0 ? cur + ' ' + fmt(r) + '/kg' : '';

  // Sync ALL visible column values back to the hidden desktop row
  const tr = document.getElementById('r' + n);
  if(tr && tr._cells){
    // Numeric fields
    const wgtInp  = tr._cells['weight']?.querySelector('.wgt');
    const rateInp = tr._cells['rate']?.querySelector('.rrate');
    const qtyInp  = tr._cells['qty']?.querySelector('.qqty');
    if(wgtInp)  wgtInp.value = w;
    if(rateInp) rateInp.value = r;
    if(qtyInp)  qtyInp.value = q;
    // Text & select fields ‚Äî sync all that exist in both card and desktop
    card.querySelectorAll('[data-mc]').forEach(mInp => {
      const key = mInp.dataset.mc;
      const dInp = tr._cells[key]?.querySelector('input,select');
      if(dInp) dInp.value = mInp.value;
    });
  }
  calc();
}

function renderMobCards(){
  const container = document.getElementById('mob-card-container');
  if(!container) return;
  container.innerHTML = '';
  Object.keys(_cards).forEach(k=>delete _cards[k]); // clear cache
  document.querySelectorAll('#tbody tr').forEach(tr => {
    const n = parseInt(tr.id.replace('r',''));
    if(isNaN(n)) return;
    const card = buildMobCard(n);
    // Pre-fill from desktop cells
    if(tr._cells){
      card.querySelectorAll('[data-mc]').forEach(mInp => {
        const key = mInp.dataset.mc;
        const dInp = tr._cells[key]?.querySelector('input,select');
        if(dInp) mInp.value = dInp.value;
      });
    }
    container.appendChild(card);
    calcCard(n);
  });
}

// addRow and delRow handle mobile cards directly (merged above)

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOUCH DRAG ‚Äî RELIABLE MOBILE SORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Uses a floating ghost label + live highlight to show where item will land.
   Works on both iOS and Android without preventDefault conflicts.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _ghost = null;

function addTouchDrag(listId, onReorder){
  const list = document.getElementById(listId);
  if(!list || list._tdBound) return;
  list._tdBound = true;

  let dragEl=null, startKey=null, lastTarget=null;

  function findItemAt(y){
    const els = list.querySelectorAll('[data-key],[data-id]');
    let best=null, bestDist=Infinity;
    els.forEach(el=>{
      if(el===dragEl) return;
      const r=el.getBoundingClientRect();
      const mid=(r.top+r.bottom)/2;
      const dist=Math.abs(y-mid);
      if(dist<bestDist){bestDist=dist;best=el;}
    });
    return best;
  }

  function clearHighlights(){
    list.querySelectorAll('.touch-over').forEach(el=>el.classList.remove('touch-over'));
  }

  list.addEventListener('touchstart', e=>{
    const handle = e.target.closest('.cdh,.trow-item');
    const item   = e.target.closest('[data-key],[data-id]');
    if(!item) return;
    // Only start drag from the handle icon OR if nothing interactive is under finger
    if(e.target.closest('input,select,button,label,.tsl,.tsw') && !e.target.closest('.cdh')) return;
    dragEl   = item;
    startKey = item.dataset.key || item.dataset.id;
    item.classList.add('touch-drag');
    // Create ghost label
    if(_ghost) _ghost.remove();
    _ghost = document.createElement('div');
    _ghost.className = 'drag-ghost';
    _ghost.textContent = '‚ú• ' + (item.querySelector('.cname,.trow-label-inp')?.textContent || item.querySelector('.trow-label-inp')?.value || 'Item');
    document.body.appendChild(_ghost);
    const t = e.touches[0];
    _ghost.style.left = (t.clientX - 20) + 'px';
    _ghost.style.top  = (t.clientY - 40) + 'px';
    e.preventDefault();
  }, {passive:false});

  list.addEventListener('touchmove', e=>{
    if(!dragEl) return;
    e.preventDefault();
    const t = e.touches[0];
    if(_ghost){
      _ghost.style.left = (t.clientX - 20) + 'px';
      _ghost.style.top  = (t.clientY - 40) + 'px';
    }
    clearHighlights();
    const target = findItemAt(t.clientY);
    if(target){ target.classList.add('touch-over'); lastTarget=target; }
    else lastTarget=null;
  }, {passive:false});

  function endDrag(e){
    if(!dragEl) return;
    dragEl.classList.remove('touch-drag');
    clearHighlights();
    if(_ghost){ _ghost.remove(); _ghost=null; }
    if(lastTarget){
      const toKey = lastTarget.dataset.key || lastTarget.dataset.id;
      if(toKey && toKey !== startKey) onReorder(startKey, toKey);
    }
    dragEl=null; startKey=null; lastTarget=null;
  }

  list.addEventListener('touchend',   endDrag);
  list.addEventListener('touchcancel',endDrag);
}

/* Re-init touch drag after each rebuild (wrap originals) */
// Touch drag re-init is done inline in buildColManager and buildTrowsManager

window.addEventListener('resize',()=>{
  if(isMobile()){
    const container=document.getElementById('mob-card-container');
    // Only rebuild if cards haven't been built for current COLS
    if(!container || container.children.length === 0) renderMobCards();
  }
});

loadFromUrlHash();
init();
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF PREVIEW MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="pdf-modal">
  <div class="pdf-modal-bar">
    <h3>üìÑ PDF Preview</h3>
    <div class="pdf-modal-actions">
      <button class="btn-pdf-dl" id="pdf-dl-btn" onclick="confirmDownloadPDF()">‚¨á Download PDF</button>
      <button class="btn-pdf-cl" onclick="closePDFPreview()">‚úï Close</button>
    </div>
  </div>
  <div class="pdf-modal-scroll" id="pdf-modal-scroll">
    <div class="pdf-modal-loading" id="pdf-loading">Generating preview‚Ä¶</div>
    <div class="pdf-modal-pages" id="pdf-pages" style="display:none"></div>
  </div>
</div>

</body>
</html>
