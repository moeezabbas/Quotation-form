<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quotation ‚Äì Abbas & Sons Roll Tech</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@300;400;500;600&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--iron:#1a1a1a;--rust:#b84a1e;--steel:#3d5a6e;--silver:#c0c8d0;--warm:#f5f2ee;--amber:#d4802a;--lgray:#e8e4df;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:#c8c4bc;color:var(--iron);min-height:100vh;padding:14px;}

/* ‚ïê‚ïê SETTINGS ‚ïê‚ïê */
#SP{max-width:1120px;margin:0 auto 16px;border-radius:5px;overflow:hidden;box-shadow:0 4px 22px rgba(0,0,0,.45);}
.stbar{background:#000;padding:11px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;}
.stbar h2{font-family:'Bebas Neue',sans-serif;letter-spacing:4px;font-size:1rem;color:var(--amber);}
.sbadge{background:#1a1a1a;border:1px solid #3a3a3a;border-radius:3px;padding:3px 9px;font-size:.59rem;letter-spacing:2px;color:#555;text-transform:uppercase;}
.sarr{color:var(--amber);font-size:.85rem;transition:transform .3s;}
.sarr.closed{transform:rotate(180deg);}
.stabs{background:#0a0a0a;display:flex;border-bottom:1px solid #222;flex-wrap:wrap;}
.stab{padding:9px 16px;font-family:'Barlow Condensed',sans-serif;font-size:.7rem;letter-spacing:2px;text-transform:uppercase;color:#555;cursor:pointer;border-bottom:2px solid transparent;transition:.2s;}
.stab.active{color:var(--amber);border-bottom-color:var(--amber);}
.stab:hover{color:#aaa;}
.sbody{background:#111;padding:16px 18px 20px;}
.sbody.hide{display:none;}
.spane{display:none;}.spane.active{display:block;}
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px;}
.sg{background:#1c1c1c;border:1px solid #2a2a2a;border-radius:3px;padding:11px;}
.sgt{font-family:'Barlow Condensed',sans-serif;font-size:.61rem;letter-spacing:3px;text-transform:uppercase;color:var(--amber);margin-bottom:8px;border-bottom:1px solid #2a2a2a;padding-bottom:4px;}
.sf{display:flex;flex-direction:column;gap:3px;margin-bottom:7px;}.sf:last-child{margin-bottom:0;}
.sf label{font-size:.57rem;letter-spacing:2px;text-transform:uppercase;color:var(--silver);}
.sf input,.sf textarea,.sf select{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.8rem;padding:5px 8px;outline:none;width:100%;}
.sf textarea{resize:vertical;min-height:60px;line-height:1.5;}
.sf input:focus,.sf textarea:focus{border-color:var(--rust);}
.lbtn{background:var(--rust);color:#fff;border:none;padding:6px 0;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border-radius:2px;width:100%;margin-top:3px;}
.lbtn:hover{background:#9e3614;}
.lbtn.rem{background:#2a2a2a;color:#777;margin-top:5px;}.lbtn.rem:hover{background:#333;color:#aaa;}
.swide{grid-column:1/-1;}
.abar{display:flex;gap:8px;flex-wrap:wrap;padding-top:10px;}
.btn{padding:8px 18px;font-family:'Barlow Condensed',sans-serif;font-size:.84rem;letter-spacing:2px;text-transform:uppercase;border:none;cursor:pointer;border-radius:2px;font-weight:600;}
.btn-pdf{background:var(--rust);color:#fff;}.btn-pdf:hover{background:#9e3614;}
.btn-print{background:var(--steel);color:#fff;}.btn-print:hover{background:#2c3f50;}
.btn-rf{background:#2a2a2a;color:#777;}.btn-rf:hover{background:#333;color:#aaa;}
.btn-rs{background:#1a1a1a;color:#444;border:1px solid #333;}.btn-rs:hover{background:#222;color:#aaa;}

/* toggle */
.tsw{position:relative;width:32px;height:17px;flex-shrink:0;}
.tsw input{opacity:0;width:0;height:0;}
.tsl{position:absolute;inset:0;background:#333;border-radius:17px;cursor:pointer;transition:.25s;}
.tsl:before{content:'';position:absolute;width:11px;height:11px;left:3px;top:3px;background:#666;border-radius:50%;transition:.25s;}
.tsw input:checked+.tsl{background:var(--steel);}
.tsw input:checked+.tsl:before{transform:translateX(15px);background:#fff;}

/* col manager */
.clist{display:flex;flex-direction:column;gap:4px;margin-top:4px;}
.citem{display:flex;align-items:center;gap:7px;background:#242424;border:1px solid #333;border-radius:3px;padding:6px 9px;cursor:grab;user-select:none;transition:background .15s;}
.citem:active{cursor:grabbing;}
.citem.dragging{opacity:.35;}.citem.drag-over{border-color:var(--amber);background:#1e1e12;}
.cdh{color:#444;font-size:.82rem;flex-shrink:0;}
.cname{flex:1;font-size:.68rem;letter-spacing:1.5px;text-transform:uppercase;color:#bbb;}
.cbadge{font-size:.56rem;color:#555;margin-right:4px;}

/* width grid */
.wgrid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.wf{display:flex;flex-direction:column;gap:2px;}
.wf label{font-size:.55rem;letter-spacing:1.5px;text-transform:uppercase;color:#666;}
.wf input{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.77rem;padding:4px 7px;outline:none;width:100%;}
.wf input:focus{border-color:var(--rust);}

/* totals manager */
.trows-mgr{display:flex;flex-direction:column;gap:5px;margin-top:4px;}
.trow-item{display:flex;align-items:center;gap:7px;background:#242424;border:1px solid #333;border-radius:3px;padding:7px 10px;cursor:grab;user-select:none;}
.trow-item:active{cursor:grabbing;}
.trow-item.drag-over{border-color:var(--amber);}
.trow-item input.trow-label-inp{flex:1;background:#1a1a1a;border:1px solid #333;border-radius:2px;color:#ccc;font-family:'Barlow',sans-serif;font-size:.78rem;padding:3px 6px;outline:none;}
.trow-item input.trow-label-inp:focus{border-color:var(--rust);}
.trow-del{background:none;border:none;color:#444;cursor:pointer;font-size:.8rem;}.trow-del:hover{color:var(--rust);}

/* custom col manager */
.custom-col-list{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.cc-item{display:flex;align-items:center;gap:7px;background:#242424;border:1px solid #333;border-radius:3px;padding:7px 10px;}
.cc-item input{background:#1a1a1a;border:1px solid #333;border-radius:2px;color:#ccc;font-family:'Barlow',sans-serif;font-size:.78rem;padding:3px 6px;outline:none;}
.cc-item input:focus{border-color:var(--rust);}
.cc-del{background:none;border:none;color:#444;cursor:pointer;font-size:.9rem;}.cc-del:hover{color:var(--rust);}
.add-cc-btn{background:#232323;border:1px dashed #444;color:#888;border-radius:3px;padding:6px 14px;font-family:'Barlow Condensed',sans-serif;font-size:.72rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;}
.add-cc-btn:hover{background:#2a2a2a;color:#bbb;}
.add-tr-btn{background:#232323;border:1px dashed #444;color:#888;border-radius:3px;padding:6px 14px;font-family:'Barlow Condensed',sans-serif;font-size:.72rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;margin-top:6px;}
.add-tr-btn:hover{background:#2a2a2a;color:#bbb;}

/* save dot */
.sdot{width:7px;height:7px;border-radius:50%;background:#4caf50;display:inline-block;margin-left:8px;opacity:0;transition:opacity .3s;}
.sdot.show{opacity:1;}

/* ‚ïê‚ïê DOCUMENT ‚ïê‚ïê */
#QD{background:var(--warm);max-width:1120px;margin:0 auto;box-shadow:0 6px 36px rgba(0,0,0,.28);overflow:hidden;}
.dtop{background:var(--iron);height:7px;}
.dhdr{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:18px;padding:22px 30px 16px;border-bottom:3px solid var(--rust);position:relative;}
.dhdr::after{content:'';position:absolute;bottom:-6px;left:0;right:0;height:1px;background:var(--amber);}
#logo-display{width:78px;height:78px;object-fit:contain;display:none;}
#logo-ph{width:78px;height:78px;background:var(--iron);display:flex;align-items:center;justify-content:center;}
#logo-ph svg{opacity:.4;}
#dc{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:4px;line-height:1;}
#dt{font-family:'Barlow Condensed',sans-serif;font-size:.77rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--rust);margin-top:3px;}
#da{font-size:.71rem;color:#666;margin-top:6px;line-height:1.6;}
.qtb{text-align:right;}
.qtb h1{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:6px;color:var(--steel);line-height:1;}
.qrl{font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:#999;margin-top:4px;}
.qri{text-align:right;border:none;border-bottom:2px solid var(--rust);font-family:'Barlow Condensed',sans-serif;font-size:1.05rem;font-weight:700;color:var(--rust);outline:none;background:transparent;width:150px;}

.dmeta{background:var(--steel);display:grid;grid-template-columns:repeat(4,1fr);}
.mc{padding:9px 15px;border-right:1px solid rgba(255,255,255,.1);}
.mc:last-child{border-right:none;}
.mc label{display:block;font-size:.57rem;letter-spacing:2px;text-transform:uppercase;color:var(--silver);margin-bottom:2px;}
.mc input{background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,.22);color:#fff;font-family:'Barlow',sans-serif;font-size:.83rem;width:100%;outline:none;padding:2px 0;}
.mc input::placeholder{color:rgba(255,255,255,.26);}

.dbody{padding:22px 30px;}
.crow{display:grid;grid-template-columns:1fr auto;align-items:end;gap:16px;background:#ede9e3;border-left:4px solid var(--rust);padding:11px 14px;margin-bottom:18px;}
.crl label,.crr label{display:block;font-family:'Bebas Neue',sans-serif;font-size:.75rem;letter-spacing:3px;margin-bottom:4px;}
.crl label{color:var(--rust);}.crr label{color:var(--steel);}
.crl input{width:100%;background:transparent;border:none;border-bottom:1px solid #bbb;font-family:'Barlow',sans-serif;font-size:.92rem;color:var(--iron);outline:none;padding:3px 0;}
.crl input::placeholder{color:#bbb;}
.crr input{width:140px;background:transparent;border:none;border-bottom:2px solid var(--rust);font-family:'Barlow Condensed',sans-serif;font-weight:700;color:var(--rust);font-size:1rem;outline:none;text-align:right;padding:3px 0;}

.stitle{font-family:'Bebas Neue',sans-serif;font-size:.9rem;letter-spacing:4px;color:var(--iron);border-bottom:2px solid var(--rust);padding-bottom:4px;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.stitle .line{flex:1;height:1px;background:var(--lgray);}

/* TABLE */
.twrap{overflow-x:auto;}
table.it{width:100%;border-collapse:collapse;font-size:.75rem;table-layout:auto;}
table.it thead tr.thm{background:var(--iron);color:var(--warm);}
table.it thead tr.ths{background:#273d4d;}
table.it th{padding:7px 6px;text-align:left;font-family:'Barlow Condensed',sans-serif;font-size:.64rem;letter-spacing:1.5px;text-transform:uppercase;font-weight:600;white-space:nowrap;}
table.it th.rgt{text-align:right;}table.it th.ctr{text-align:center;}
.ths th{color:#8aabb8;font-size:.59rem;letter-spacing:1px;font-weight:400;padding:4px 6px;border-right:1px solid rgba(255,255,255,.05);}
.ths th:last-child{border-right:none;}
table.it tbody tr{border-bottom:1px solid var(--lgray);}
table.it tbody tr:nth-child(even){background:rgba(0,0,0,.013);}
table.it tbody tr:hover{background:#ede9e3;}
table.it td{padding:5px 6px;vertical-align:middle;}
table.it td input,table.it td select{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:.75rem;color:var(--iron);outline:none;padding:2px 0;width:100%;}
table.it td input[type="number"]{text-align:right;}
.tc{text-align:right;font-weight:600;color:var(--rust);font-family:'Barlow Condensed',sans-serif;font-size:.84rem;white-space:nowrap;}
.del-btn{background:none;border:none;cursor:pointer;color:#ccc;font-size:.8rem;padding:0 2px;}
.del-btn:hover{color:var(--rust);}

/* TOTALS ROW */
.totals-row-bar{background:#ede9e3;border-top:2px solid var(--steel);}
.totals-row-bar td{padding:5px 6px;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;font-weight:700;color:var(--steel);text-align:right;}
.totals-row-bar td.tot-label{text-align:left;font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:#888;}
.totals-row-bar td.tot-qty{color:var(--steel);}
.totals-row-bar td.tot-wt{color:var(--steel);}
.totals-row-bar td.tot-amt{color:var(--rust);font-size:.88rem;}

/* size cell */
.size-td{display:flex;align-items:center;gap:2px;}
.size-td input{flex:1;min-width:26px;text-align:center;font-size:.73rem;}
.utog{display:flex;border:1px solid #d0cbc5;border-radius:3px;overflow:hidden;flex-shrink:0;}
.utog button{padding:2px 4px;border:none;background:#ede9e3;color:#999;font-family:'Barlow Condensed',sans-serif;font-size:.53rem;cursor:pointer;line-height:1.2;transition:background .15s,color .15s;}
.utog button.active{background:var(--steel);color:#fff;}
.utog button:first-child{border-right:1px solid #d0cbc5;}
.ulbl{font-size:.6rem;color:#999;font-family:'Barlow Condensed',sans-serif;flex-shrink:0;display:none;}

.add-btn{margin-top:8px;background:none;border:2px dashed var(--steel);color:var(--steel);font-family:'Barlow Condensed',sans-serif;font-size:.72rem;letter-spacing:2px;text-transform:uppercase;padding:5px 13px;cursor:pointer;border-radius:2px;transition:all .2s;}
.add-btn:hover{background:var(--steel);color:#fff;}

/* SUMMARY TOTALS BOX */
.sum-wrap{display:flex;justify-content:flex-end;margin-top:14px;}
.sumbox{background:#ede9e3;border:1px solid var(--lgray);min-width:295px;}
.srow{display:flex;justify-content:space-between;align-items:center;padding:7px 14px;border-bottom:1px solid var(--lgray);font-size:.79rem;}
.srow.disabled{opacity:.35;pointer-events:none;}
.srow label{color:#666;display:flex;align-items:center;gap:6px;}
.srow .sv{font-weight:600;font-family:'Barlow Condensed',sans-serif;white-space:nowrap;}
.srow input[type="number"]{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:.79rem;font-weight:600;width:50px;text-align:right;outline:none;color:var(--iron);}
.srow input[type="text"]{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:.79rem;width:110px;outline:none;color:#666;text-align:left;}
.srow.grand{background:var(--iron);color:#fff;padding:10px 14px;}
.srow.grand label{color:var(--silver);letter-spacing:2px;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;font-size:.64rem;}
.srow.grand .sv{font-family:'Bebas Neue',sans-serif;font-size:1.35rem;color:var(--amber);letter-spacing:2px;}
.cur{margin-right:2px;color:#999;font-size:.73rem;}.srow.grand .cur{color:#aaa;}

/* notes & terms */
.ntg{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-top:18px;}
.nb h4{font-family:'Bebas Neue',sans-serif;letter-spacing:3px;font-size:.77rem;color:var(--steel);margin-bottom:5px;}
.nb textarea{width:100%;background:#ede9e3;border:1px solid var(--lgray);border-left:3px solid var(--steel);font-family:'Barlow',sans-serif;font-size:.75rem;color:var(--iron);padding:8px 10px;resize:vertical;outline:none;min-height:70px;line-height:1.6;}

/* sig */
.sigrow{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-top:22px;padding-top:15px;border-top:1px solid var(--lgray);}
.sb label{display:block;font-size:.59rem;letter-spacing:2px;text-transform:uppercase;color:#aaa;margin-bottom:6px;}
.sl{border-bottom:1px solid var(--iron);height:34px;margin-bottom:4px;}
.sb p{font-size:.67rem;color:#bbb;}

/* footer */
.dfoot{background:var(--iron);padding:12px 30px;display:flex;justify-content:space-between;align-items:center;}
#dfc{font-family:'Bebas Neue',sans-serif;letter-spacing:3px;color:var(--silver);font-size:.84rem;}
#dcc{font-family:'Bebas Neue',sans-serif;letter-spacing:2px;color:var(--amber);font-size:1.1rem;}
.dbot{background:var(--rust);height:5px;}

/* print */
@media print{
  body{background:#fff;padding:0;}
  #SP{display:none!important;}
  #QD{box-shadow:none;max-width:100%;}
  .add-btn,.del-btn,.utog{display:none!important;}
  .ulbl{display:inline!important;}
  input,select{border-color:transparent!important;background:transparent!important;}
  .mc input{border-bottom-color:rgba(255,255,255,.22)!important;}
  .nb textarea{border:none!important;padding:0!important;background:transparent!important;}
  .srow.disabled{display:none;}
  @page{margin:0;size:A4;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="SP">
  <div class="stbar" onclick="toggleSP()">
    <h2>‚öô Settings &amp; Customization <span class="sdot" id="sdot"></span></h2>
    <span class="sbadge">üîí Hidden in PDF ¬∑ Auto-saved</span>
    <span class="sarr" id="sarr">‚ñ≤</span>
  </div>

  <div class="sbody" id="sbody">
    <div class="stabs">
      <div class="stab active" onclick="stab('company')">üè≠ Company</div>
      <div class="stab" onclick="stab('columns')">üìã Columns</div>
      <div class="stab" onclick="stab('widths')">‚Üî Widths</div>
      <div class="stab" onclick="stab('totals')">üí∞ Totals</div>
      <div class="stab" onclick="stab('content')">üìù Content</div>
    </div>

    <!-- Company -->
    <div class="spane active" id="pane-company">
      <div class="sgrid" style="margin-top:13px">
        <div class="sg">
          <div class="sgt">Logo</div>
          <div class="sf"><label>Upload</label>
            <button class="lbtn" onclick="document.getElementById('li').click()">üìé Upload Logo</button>
            <input type="file" id="li" accept="image/*" style="display:none" onchange="uploadLogo(event)">
          </div>
          <button class="lbtn rem" onclick="removeLogo()">‚úï Remove Logo</button>
        </div>
        <div class="sg">
          <div class="sgt">Company</div>
          <div class="sf"><label>Name</label><input id="sc" value="Abbas & Sons Roll Tech" oninput="sync('c');save()"></div>
          <div class="sf"><label>Tagline</label><input id="st" value="Specialized in Casting Steel Mill Rolls and Centrifugal Rolls" oninput="sync('t');save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Address</div>
          <div class="sf"><label>Header Address</label><textarea id="sa" oninput="sync('a');save()">Karol Ghatti, Lahore</textarea></div>
        </div>
        <div class="sg">
          <div class="sgt">Footer</div>
          <div class="sf"><label>Footer Name</label><input id="sfn" value="Abbas & Sons Roll Tech" oninput="sync('fn');save()"></div>
          <div class="sf"><label>Footer Contact</label><input id="sfc" value="03009429705" oninput="sync('fc');save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Currency &amp; Tax</div>
          <div class="sf"><label>Currency</label><input id="scur" value="PKR" oninput="updateCur();save()"></div>
          <div class="sf"><label>Default GST %</label><input type="number" id="stax" value="18" min="0" oninput="save()"></div>
          <div class="sf"><label>Default Discount %</label><input type="number" id="sdisc" value="0" min="0" oninput="save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Signatures</div>
          <div class="sf"><label>Signatory 1</label><input id="ss1" value="Authorized Signatory" oninput="document.getElementById('sl1').textContent=this.value;save()"></div>
          <div class="sf"><label>Signatory 2</label><input id="ss2" value="Client Acceptance" oninput="document.getElementById('sl2').textContent=this.value;save()"></div>
        </div>
        <div class="abar swide">
          <button class="btn btn-pdf" onclick="downloadPDF()">‚¨á Download PDF</button>
          <button class="btn btn-print" onclick="window.print()">üñ® Print</button>
          <button class="btn btn-rf" onclick="resetForm()">‚Ü∫ Reset Form</button>
          <button class="btn btn-rs" onclick="resetAll()">‚ö† Reset All Settings</button>
        </div>
      </div>
    </div>

    <!-- Columns -->
    <div class="spane" id="pane-columns">
      <div style="padding:12px 0 4px">
        <p style="font-size:.67rem;color:#555;letter-spacing:1px;margin-bottom:10px;">‚ò∞ Drag to reorder &nbsp;¬∑&nbsp; Toggle to show/hide &nbsp;¬∑&nbsp; Auto-saved</p>
        <div class="clist" id="clist"></div>
        <div style="margin-top:14px;border-top:1px solid #2a2a2a;padding-top:12px">
          <p style="font-size:.65rem;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">‚ûï Custom Columns</p>
          <div class="custom-col-list" id="cc-list"></div>
          <button class="add-cc-btn" onclick="addCustomCol()">+ Add Custom Column</button>
        </div>
      </div>
    </div>

    <!-- Widths -->
    <div class="spane" id="pane-widths">
      <div style="padding:12px 0 4px">
        <p style="font-size:.67rem;color:#555;letter-spacing:1px;margin-bottom:10px;">Enter px number or <code style="color:#888">auto</code></p>
        <div class="wgrid" id="wgrid"></div>
      </div>
    </div>

    <!-- Totals -->
    <div class="spane" id="pane-totals">
      <div style="padding:12px 0 4px">
        <p style="font-size:.67rem;color:#555;letter-spacing:1px;margin-bottom:10px;">‚ò∞ Drag to reorder &nbsp;¬∑&nbsp; Toggle to show/hide &nbsp;¬∑&nbsp; Edit label text &nbsp;¬∑&nbsp; Delete row</p>
        <div class="trows-mgr" id="trows-mgr"></div>
        <button class="add-tr-btn" onclick="addTotalRow()">+ Add Custom Total Row</button>
      </div>
    </div>

    <!-- Content -->
    <div class="spane" id="pane-content">
      <div style="padding:12px 0 4px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="sf"><label>Notes</label>
          <textarea id="sn" style="min-height:85px" oninput="syncTA('notes');save()">All castings subject to standard inspection per agreed Sizes.
Pattern / tooling cost billed separately if applicable.</textarea>
        </div>
        <div class="sf"><label>Terms &amp; Conditions</label>
          <textarea id="ste" style="min-height:85px" oninput="syncTA('terms');save()">Payment: 50% advance, 50% against delivery.
Validity: Prices valid for 30 days from issue date.</textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCUMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="QD">
  <div class="dtop"></div>
  <div class="dhdr">
    <div>
      <img id="logo-display" src="" alt="Logo">
      <div id="logo-ph">
        <svg width="54" height="54" viewBox="0 0 60 60" fill="none">
          <polygon points="30,4 56,18 56,42 30,56 4,42 4,18" stroke="#c0c8d0" stroke-width="2" fill="none"/>
          <polygon points="30,14 46,23 46,37 30,46 14,37 14,23" stroke="#b84a1e" stroke-width="1.5" fill="none"/>
          <circle cx="30" cy="30" r="5" fill="#c0c8d0"/>
        </svg>
      </div>
    </div>
    <div>
      <div id="dc">Abbas &amp; Sons Roll Tech</div>
      <div id="dt">Specialized in Casting Steel Mill Rolls and Centrifugal Rolls</div>
      <div id="da">Karol Ghatti, Lahore</div>
    </div>
    <div class="qtb">
      <h1>QUOTATION</h1>
      <div class="qrl">Quote Reference</div>
      <input class="qri" type="text" id="qref" value="AST-2026-001">
    </div>
  </div>

  <div class="dmeta">
    <div class="mc"><label>Issue Date</label><input type="date" id="mdate"></div>
    <div class="mc"><label>Valid Until</label><input type="date" id="mvalid"></div>
    <div class="mc"><label>Delivery Lead Time</label><input type="text" placeholder="e.g. 4‚Äì6 weeks after PO"></div>
    <div class="mc"><label>Payment Terms</label><input type="text" placeholder="50% Advance / 50% Delivery"></div>
  </div>

  <div class="dbody">
    <div class="crow">
      <div class="crl"><label>Customer / Party Name</label><input type="text" id="cust" placeholder="Enter customer or party name‚Ä¶"></div>
      <div class="crr"><label>Quote No.</label><input type="text" value="AST-2026-001" oninput="document.getElementById('qref').value=this.value"></div>
    </div>

    <div class="stitle">Items &amp; Specifications <span class="line"></span></div>
    <div class="twrap">
      <table class="it" id="itable">
        <thead>
          <tr class="thm" id="thm"></tr>
          <tr class="ths" id="ths"></tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr class="totals-row-bar" id="tfoot-row"></tr>
        </tfoot>
      </table>
    </div>
    <button class="add-btn" onclick="addRow()">+ Add Item</button>

    <div class="sum-wrap">
      <div class="sumbox" id="sumbox"></div>
    </div>

    <div class="ntg">
      <div class="nb"><h4>Notes</h4><textarea id="doc-notes">All castings subject to standard inspection per agreed Sizes.
Pattern / tooling cost billed separately if applicable.</textarea></div>
      <div class="nb"><h4>Terms &amp; Conditions</h4><textarea id="doc-terms">Payment: 50% advance, 50% against delivery.
Validity: Prices valid for 30 days from issue date.</textarea></div>
    </div>

    <div class="sigrow">
      <div class="sb"><label id="sl1">Authorized Signatory</label><div class="sl"></div><p>Name &amp; Designation / Stamp</p></div>
      <div class="sb"><label id="sl2">Client Acceptance</label><div class="sl"></div><p>Name &amp; Designation / Company Stamp</p></div>
    </div>
  </div>

  <div class="dfoot">
    <div id="dfc">ABBAS &amp; SONS ROLL TECH</div>
    <div id="dcc">03009429705</div>
  </div>
  <div class="dbot"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DEFAULT COLUMN DEFINITIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const COL_DEFS = [
  {key:'desc',   label:'Item / Description', vis:true,  w:'auto', fixed:true,              showTotal:false},
  {key:'dia',    label:'Dia',                vis:true,  w:'auto', size:true,               showTotal:false},
  {key:'len',    label:'Length',             vis:true,  w:'auto', size:true,               showTotal:false},
  {key:'bore',   label:'Bore',               vis:true,  w:'auto', size:true,               showTotal:false},
  {key:'weight', label:'Weight (kg)',         vis:true,  w:'62',   numeric:true,            showTotal:true},
  {key:'qty',    label:'Qty',                vis:true,  w:'44',   numeric:true, isQty:true, showTotal:true},
  {key:'unit',   label:'Unit',               vis:false, w:'50',                            showTotal:false},
  {key:'rate',   label:'Rate / kg',          vis:true,  w:'76',   numeric:true,            showTotal:false},
  {key:'amount', label:'Amount',             vis:true,  w:'86',   numeric:true, isAmt:true, showTotal:true},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DEFAULT TOTAL ROWS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TROW_DEFS = [
  {id:'subtotal', label:'Subtotal',    type:'subtotal', vis:true, fixed:true},
  {id:'discount', label:'Discount',   type:'discount', vis:true, fixed:false},
  {id:'tax',      label:'GST / Tax',  type:'tax',      vis:true, fixed:false},
  {id:'aftertax', label:'After Tax',  type:'aftertax', vis:true, fixed:false},
  {id:'grand',    label:'Grand Total',type:'grand',    vis:true, fixed:true},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let COLS        = [];
let TROWS       = [];
let CUSTOM_COLS = [];
const LS        = 'abbrol_v5';
const LS_LOGO   = 'abbrol_logo';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STORAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function defState(){
  return {
    c:'Abbas & Sons Roll Tech',
    t:'Specialized in Casting Steel Mill Rolls and Centrifugal Rolls',
    a:'Karol Ghatti, Lahore',
    fn:'Abbas & Sons Roll Tech',
    fc:'03009429705',
    cur:'PKR', tax:'18', disc:'0',
    s1:'Authorized Signatory', s2:'Client Acceptance',
    notes:'All castings subject to standard inspection per agreed Sizes.\nPattern / tooling cost billed separately if applicable.',
    terms:'Payment: 50% advance, 50% against delivery.\nValidity: Prices valid for 30 days from issue date.',
    cols: JSON.parse(JSON.stringify(COL_DEFS)),
    trows: JSON.parse(JSON.stringify(TROW_DEFS)),
    customCols: [],
    panelOpen: true,
  };
}

function loadState(){
  try{
    const r=localStorage.getItem(LS);
    if(r){
      const s=JSON.parse(r);
      if(!s.cols||!Array.isArray(s.cols))     s.cols=JSON.parse(JSON.stringify(COL_DEFS));
      if(!s.trows||!Array.isArray(s.trows))   s.trows=JSON.parse(JSON.stringify(TROW_DEFS));
      if(!s.customCols)                        s.customCols=[];
      return s;
    }
  }catch(e){}
  return defState();
}

let _saveTimer=null;
function save(){
  const s={
    c:V('sc'), t:V('st'), a:V('sa'),
    fn:V('sfn'), fc:V('sfc'),
    cur:V('scur'), tax:V('stax'), disc:V('sdisc'),
    s1:V('ss1'), s2:V('ss2'),
    notes:V('sn'), terms:V('ste'),
    cols: JSON.parse(JSON.stringify(COLS.filter(c=>!c.custom))),
    customCols: JSON.parse(JSON.stringify(CUSTOM_COLS)),
    trows: JSON.parse(JSON.stringify(TROWS)),
    panelOpen: !document.getElementById('sbody').classList.contains('hide'),
  };
  localStorage.setItem(LS,JSON.stringify(s));
  clearTimeout(_saveTimer);
  const d=document.getElementById('sdot');
  d.classList.add('show');
  _saveTimer=setTimeout(()=>d.classList.remove('show'),1400);
}
function V(id){return document.getElementById(id)?.value||'';}

function resetAll(){
  if(!confirm('Reset ALL settings to factory defaults?')) return;
  localStorage.removeItem(LS); localStorage.removeItem(LS_LOGO); location.reload();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function init(){
  const s=loadState();
  COLS        = mergeCustomCols(s.cols||JSON.parse(JSON.stringify(COL_DEFS)), s.customCols||[]);
  TROWS       = s.trows||JSON.parse(JSON.stringify(TROW_DEFS));
  CUSTOM_COLS = s.customCols||[];

  setV('sc',s.c); setV('st',s.t); setV('sa',s.a);
  setV('sfn',s.fn); setV('sfc',s.fc);
  setV('scur',s.cur); setV('stax',s.tax); setV('sdisc',s.disc);
  setV('ss1',s.s1); setV('ss2',s.s2);
  setV('sn',s.notes); setV('ste',s.terms);

  applyToDom(s);
  loadLogo();

  if(!s.panelOpen){
    document.getElementById('sbody').classList.add('hide');
    const a=document.getElementById('sarr');
    a.textContent='‚ñº'; a.classList.add('closed');
  }

  const td=new Date();
  document.getElementById('mdate').value=fmtD(td);
  const vd=new Date(td); vd.setDate(vd.getDate()+30);
  document.getElementById('mvalid').value=fmtD(vd);

  buildColManager();
  buildWidthManager();
  buildTrowsManager();
  buildCustomColManager();
  renderHeaders();
  addRow(); addRow(); addRow();
  renderSumBox();
})();

function mergeCustomCols(cols, customCols){
  const filtered=cols.filter(c=>!c.custom);
  customCols.forEach(cc=>{
    filtered.push({key:cc.key, label:cc.label, vis:cc.vis!==false, w:cc.w||'auto', custom:true, showTotal:false});
  });
  return filtered;
}

function setV(id,val){ const el=document.getElementById(id); if(el) el.value=val; }
function fmtD(d){return d.toISOString().split('T')[0];}

function applyToDom(s){
  document.getElementById('dc').textContent=s.c;
  document.getElementById('dt').textContent=s.t;
  document.getElementById('da').innerHTML=s.a.replace(/\n/g,'<br>');
  document.getElementById('dfc').textContent=(s.fn||'').toUpperCase();
  document.getElementById('dcc').textContent=s.fc;
  document.getElementById('sl1').textContent=s.s1;
  document.getElementById('sl2').textContent=s.s2;
  document.getElementById('doc-notes').value=s.notes;
  document.getElementById('doc-terms').value=s.terms;
  updateCur(s.cur);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SYNC HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sync(k){
  const v=V('s'+k);
  if(k==='c'){ document.getElementById('dc').textContent=v; document.getElementById('dfc').textContent=v.toUpperCase(); setV('sfn',v); }
  if(k==='t') document.getElementById('dt').textContent=v;
  if(k==='a') document.getElementById('da').innerHTML=v.replace(/\n/g,'<br>');
  if(k==='fn') document.getElementById('dfc').textContent=v.toUpperCase();
  if(k==='fc') document.getElementById('dcc').textContent=v;
}
function syncTA(k){ document.getElementById('doc-'+k).value=V('s'+(k==='notes'?'n':'te')); }
function updateCur(v){
  const c=v||V('scur')||'PKR';
  document.querySelectorAll('.cur').forEach(el=>el.textContent=c+' ');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function uploadLogo(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const i=document.getElementById('logo-display');
    i.src=ev.target.result; i.style.display='block';
    document.getElementById('logo-ph').style.display='none';
    try{localStorage.setItem(LS_LOGO,ev.target.result);}catch(e){}
  };
  r.readAsDataURL(f);
}
function removeLogo(){
  const i=document.getElementById('logo-display');
  i.src=''; i.style.display='none';
  document.getElementById('logo-ph').style.display='flex';
  document.getElementById('li').value='';
  try{localStorage.removeItem(LS_LOGO);}catch(e){}
}
function loadLogo(){
  try{
    const src=localStorage.getItem(LS_LOGO);
    if(src){
      const i=document.getElementById('logo-display');
      i.src=src; i.style.display='block';
      document.getElementById('logo-ph').style.display='none';
    }
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleSP(){
  const b=document.getElementById('sbody'),a=document.getElementById('sarr');
  const h=b.classList.toggle('hide');
  a.classList.toggle('closed',h); a.textContent=h?'‚ñº':'‚ñ≤'; save();
}
function stab(name){
  const tabs=['company','columns','widths','totals','content'];
  document.querySelectorAll('.stab').forEach((t,i)=>t.classList.toggle('active',tabs[i]===name));
  document.querySelectorAll('.spane').forEach(p=>p.classList.remove('active'));
  document.getElementById('pane-'+name).classList.add('active');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COLUMN MANAGER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildColManager(){
  const list=document.getElementById('clist'); list.innerHTML='';
  COLS.forEach((col)=>{
    const item=document.createElement('div'); item.className='citem'; item.draggable=true; item.dataset.key=col.key;
    item.innerHTML=`
      <span class="cdh">‚ò∞</span>
      <span class="cname">${col.label}${col.custom?' <span style="color:#556;font-size:.55rem">[custom]</span>':''}</span>
      ${col.fixed?'<span class="cbadge">always on</span>':`
      <label class="tsw"><input type="checkbox" ${col.vis?'checked':''} onchange="colVis('${col.key}',this.checked)"><span class="tsl"></span></label>`}
    `;
    item.addEventListener('dragstart',e=>{_dragKey=col.key;item.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
    item.addEventListener('dragend',()=>{item.classList.remove('dragging');document.querySelectorAll('.citem').forEach(i=>i.classList.remove('drag-over'));});
    item.addEventListener('dragover',e=>{e.preventDefault();item.classList.add('drag-over');});
    item.addEventListener('dragleave',()=>item.classList.remove('drag-over'));
    item.addEventListener('drop',e=>{e.preventDefault();item.classList.remove('drag-over');colReorder(_dragKey,col.key);});
    list.appendChild(item);
  });
}
let _dragKey=null;
function colVis(key,v){ const c=COLS.find(x=>x.key===key); if(c){c.vis=v;} renderHeaders(); refreshRows(); renderFootTotals(); save(); }
function colReorder(from,to){
  if(from===to) return;
  const fi=COLS.findIndex(c=>c.key===from), ti=COLS.findIndex(c=>c.key===to);
  const [m]=COLS.splice(fi,1); COLS.splice(ti,0,m);
  buildColManager(); buildWidthManager(); renderHeaders(); refreshRows(); renderFootTotals(); save();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CUSTOM COLUMNS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _ccId=0;
function addCustomCol(label,w,key){
  _ccId++;
  const k=key||'cc_'+Date.now()+'_'+_ccId;
  const cc={key:k, label:label||'Column '+_ccId, w:w||'auto'};
  CUSTOM_COLS.push(cc);
  COLS.push({key:k, label:cc.label, vis:true, w:cc.w, custom:true, showTotal:false});
  buildCustomColManager(); buildColManager(); buildWidthManager(); renderHeaders(); refreshRows(); renderFootTotals(); save();
}
function removeCustomCol(key){
  CUSTOM_COLS=CUSTOM_COLS.filter(c=>c.key!==key);
  const idx=COLS.findIndex(c=>c.key===key); if(idx>=0) COLS.splice(idx,1);
  buildCustomColManager(); buildColManager(); buildWidthManager(); renderHeaders(); refreshRows(); renderFootTotals(); save();
}
function updateCustomColLabel(key,label){
  const cc=CUSTOM_COLS.find(c=>c.key===key); if(cc) cc.label=label;
  const col=COLS.find(c=>c.key===key); if(col) col.label=label;
  buildColManager(); buildWidthManager(); renderHeaders(); refreshRows(); save();
}
function buildCustomColManager(){
  const list=document.getElementById('cc-list'); list.innerHTML='';
  CUSTOM_COLS.forEach(cc=>{
    const item=document.createElement('div'); item.className='cc-item';
    item.innerHTML=`
      <input value="${cc.label}" placeholder="Column label" oninput="updateCustomColLabel('${cc.key}',this.value)" style="flex:1">
      <button class="cc-del" onclick="removeCustomCol('${cc.key}')">‚úï</button>
    `;
    list.appendChild(item);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WIDTH MANAGER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildWidthManager(){
  const g=document.getElementById('wgrid'); g.innerHTML='';
  COLS.forEach(col=>{
    const d=document.createElement('div'); d.className='wf';
    d.innerHTML=`<label>${col.label}</label><input value="${col.w||'auto'}" placeholder="auto" oninput="colW('${col.key}',this.value)">`;
    g.appendChild(d);
  });
}
function colW(key,val){
  const col=COLS.find(c=>c.key===key); if(col){ col.w=val.trim()||'auto'; }
  renderHeaders(); refreshRows(); save();
}
function getWpx(col){ const v=col.w||'auto'; if(!v||v==='auto') return ''; return isNaN(v)?v:v+'px'; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOTAL ROWS MANAGER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _trDragId=null;
function buildTrowsManager(){
  const mgr=document.getElementById('trows-mgr'); mgr.innerHTML='';
  TROWS.forEach(tr=>{
    const item=document.createElement('div'); item.className='trow-item'; item.draggable=!tr.fixed; item.dataset.id=tr.id;
    item.innerHTML=`
      ${tr.fixed?'<span style="color:#333;font-size:.82rem">‚äò</span>':'<span class="cdh" style="cursor:grab">‚ò∞</span>'}
      <input class="trow-label-inp" value="${tr.label}" ${tr.fixed?'style="color:#555"':''} oninput="trLabel('${tr.id}',this.value)">
      <label class="tsw" title="Show/Hide"><input type="checkbox" ${tr.vis?'checked':''} onchange="trVis('${tr.id}',this.checked)"><span class="tsl"></span></label>
      ${tr.fixed?'':'<button class="trow-del" onclick="trDel(\''+tr.id+'\')">‚úï</button>'}
    `;
    if(!tr.fixed){
      item.addEventListener('dragstart',e=>{_trDragId=tr.id;item.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
      item.addEventListener('dragend',()=>{item.classList.remove('dragging');document.querySelectorAll('.trow-item').forEach(i=>i.classList.remove('drag-over'));});
      item.addEventListener('dragover',e=>{e.preventDefault();item.classList.add('drag-over');});
      item.addEventListener('dragleave',()=>item.classList.remove('drag-over'));
      item.addEventListener('drop',e=>{e.preventDefault();item.classList.remove('drag-over');trReorder(_trDragId,tr.id);});
    }
    mgr.appendChild(item);
  });
}
function trLabel(id,v){ const r=TROWS.find(t=>t.id===id); if(r) r.label=v; renderSumBox(); save(); }
function trVis(id,v){ const r=TROWS.find(t=>t.id===id); if(r) r.vis=v; renderSumBox(); save(); }
function trDel(id){ TROWS=TROWS.filter(t=>t.id!==id); buildTrowsManager(); renderSumBox(); save(); }
function trReorder(from,to){
  if(from===to) return;
  const fi=TROWS.findIndex(t=>t.id===from), ti=TROWS.findIndex(t=>t.id===to);
  const [m]=TROWS.splice(fi,1); TROWS.splice(ti,0,m);
  buildTrowsManager(); renderSumBox(); save();
}
function addTotalRow(){
  const id='tr_'+Date.now();
  TROWS.splice(TROWS.length-1,0,{id,label:'Custom Row',type:'custom',vis:true,fixed:false});
  buildTrowsManager(); renderSumBox(); save();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER HEADERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderHeaders(){
  const thm=document.getElementById('thm');
  const ths=document.getElementById('ths');
  thm.innerHTML=''; ths.innerHTML='';

  const h0=document.createElement('th'); h0.style.width='28px'; h0.textContent='#'; thm.appendChild(h0);
  const s0=document.createElement('th'); ths.appendChild(s0);

  const sizeKeys=['dia','len','bore'];
  const visSizes=COLS.filter(c=>sizeKeys.includes(c.key)&&c.vis);
  let sizeAdded=false;

  COLS.forEach(col=>{
    if(!col.vis) return;
    const ws=getWpx(col);
    if(sizeKeys.includes(col.key)){
      if(!sizeAdded){
        const grp=document.createElement('th'); grp.className='ctr';
        grp.colSpan=visSizes.length;
        grp.innerHTML='Size <span style="font-size:.52rem;opacity:.4;font-weight:400">(in/mm per field)</span>';
        thm.appendChild(grp); sizeAdded=true;
      }
      const sub=document.createElement('th'); sub.className='ctr'; sub.textContent=col.label;
      if(ws) sub.style.width=ws; ths.appendChild(sub);
    } else {
      const th=document.createElement('th');
      th.textContent=col.label;
      if(['weight','qty','rate','amount'].includes(col.key)) th.className='rgt';
      if(ws) th.style.width=ws;
      thm.appendChild(th);
      const sp=document.createElement('th'); ths.appendChild(sp);
    }
  });

  const hd=document.createElement('th'); hd.style.width='22px'; thm.appendChild(hd);
  const sd=document.createElement('th'); ths.appendChild(sd);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ROWS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let rc=0;

function makeSizeCell(){
  const w=document.createElement('div'); w.className='size-td';
  const inp=document.createElement('input'); inp.type='text'; inp.placeholder='‚Äî';
  let unit='in';
  const lbl=document.createElement('span'); lbl.className='ulbl'; lbl.textContent='in';
  const tog=document.createElement('div'); tog.className='utog';
  const bI=document.createElement('button'); bI.textContent='in'; bI.type='button'; bI.className='active';
  const bM=document.createElement('button'); bM.textContent='mm'; bM.type='button';
  function su(u){unit=u;lbl.textContent=u;bI.classList.toggle('active',u==='in');bM.classList.toggle('active',u==='mm');}
  bI.onclick=()=>su('in'); bM.onclick=()=>su('mm');
  tog.appendChild(bI); tog.appendChild(bM);
  w.appendChild(inp); w.appendChild(tog); w.appendChild(lbl);
  return w;
}

function buildCells(n){
  const cells={};
  // serial
  const tn=document.createElement('td'); tn.style.cssText='color:#aaa;text-align:center;font-size:.7rem;width:28px'; tn.textContent=n;
  cells['#']=tn;
  // desc
  const tdesc=document.createElement('td'); tdesc.dataset.col='desc';
  const idesc=document.createElement('input'); idesc.type='text'; idesc.placeholder='e.g. Centrifugal Roll ‚Äì SG Iron'; idesc.style.width='100%'; tdesc.appendChild(idesc);
  cells['desc']=tdesc;
  // size cells
  ['dia','len','bore'].forEach(k=>{
    const t=document.createElement('td'); t.dataset.col=k; t.appendChild(makeSizeCell()); cells[k]=t;
  });
  // weight
  const tw=document.createElement('td'); tw.dataset.col='weight';
  const iw=document.createElement('input'); iw.type='number'; iw.className='wgt'; iw.value='0'; iw.min='0'; iw.step='0.001'; iw.oninput=calc; iw.style.width='100%'; tw.appendChild(iw);
  cells['weight']=tw;
  // qty
  const tq=document.createElement('td'); tq.dataset.col='qty';
  const iq=document.createElement('input'); iq.type='number'; iq.className='qqty'; iq.value='1'; iq.min='0'; iq.oninput=calc; iq.style.width='100%'; tq.appendChild(iq);
  cells['qty']=tq;
  // unit
  const tu=document.createElement('td'); tu.dataset.col='unit';
  const su=document.createElement('select'); su.style.cssText='width:100%;border:none;background:transparent;font-family:Barlow,sans-serif;font-size:.75rem;color:var(--iron);outline:none';
  ['Pcs','Kg','MT','Set','Lot'].forEach(u=>{const o=document.createElement('option');o.textContent=u;su.appendChild(o);}); tu.appendChild(su);
  cells['unit']=tu;
  // rate
  const tr=document.createElement('td'); tr.dataset.col='rate';
  const ir=document.createElement('input'); ir.type='number'; ir.className='rrate'; ir.value='0'; ir.min='0'; ir.step='0.01'; ir.oninput=calc; ir.style.width='100%'; tr.appendChild(ir);
  cells['rate']=tr;
  // amount (computed, read-only display)
  const ta=document.createElement('td'); ta.dataset.col='amount'; ta.className='tc'; ta.textContent='0.00';
  cells['amount']=ta;
  // delete button
  const tx=document.createElement('td');
  const bx=document.createElement('button'); bx.className='del-btn'; bx.textContent='‚úï'; bx.onclick=()=>delRow(n); tx.appendChild(bx);
  cells['delete']=tx;
  return cells;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FIX: renderRow correctly handles custom cols.
   Previously the custom-col branch appended
   the cell and then returned early, meaning
   display/width were never applied and on
   subsequent refreshes the cell would be lost.
   Now we always fall through to the shared
   style+append block.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderRow(tr, n){
  const cells = tr._cells || (tr._cells = buildCells(n));
  // detach all children
  while(tr.firstChild) tr.removeChild(tr.firstChild);

  // serial # always first
  tr.appendChild(cells['#']);

  COLS.forEach(col => {
    // Resolve or create the cell for this column
    let td = cells[col.key];

    if(!td){
      if(col.custom){
        // Create custom column cell on first encounter
        const ctd = document.createElement('td');
        ctd.dataset.col = col.key;
        const ci = document.createElement('input');
        ci.type = 'text';
        ci.style.width = '100%';
        ci.placeholder = '‚Äî';
        ctd.appendChild(ci);
        cells[col.key] = ctd;  // cache it
        td = ctd;               // fall through to style + append below
      } else {
        return; // unknown built-in key ‚Äî skip
      }
    }

    // Apply visibility and width, then append
    td.style.display = col.vis ? '' : 'none';
    const ws = getWpx(col);
    if(ws) td.style.width = ws; else td.style.width = '';
    tr.appendChild(td);
  });

  // delete button always last
  tr.appendChild(cells['delete']);
}

function addRow(){
  rc++;
  const n=rc;
  const tr=document.createElement('tr'); tr.id='r'+n;
  tr._cells=buildCells(n);
  renderRow(tr,n);
  document.getElementById('tbody').appendChild(tr);
  calc();
}
function delRow(n){ const el=document.getElementById('r'+n); if(el) el.remove(); calc(); }

function refreshRows(){
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    if(tr._cells){ const n=parseInt(tr.id.replace('r','')); renderRow(tr,n); }
  });
  calc();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CALCULATION  ‚Äî Amount = Weight √ó Rate
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}

function calc(){
  let sub=0, totWt=0, totQty=0;
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const w=parseFloat(tr.querySelector('.wgt')?.value||0);
    const q=parseFloat(tr.querySelector('.qqty')?.value||0);
    const r=parseFloat(tr.querySelector('.rrate')?.value||0);
    const amt=w*r;
    const tc=tr.querySelector('.tc'); if(tc) tc.textContent=fmt(amt);
    sub+=amt; totWt+=w; totQty+=q;
  });
  window._sub=sub; window._totWt=totWt; window._totQty=totQty;
  renderFootTotals(totQty, totWt, sub);
  renderSumBox();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FOOTER TOTALS ROW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderFootTotals(totQty, totWt, sub){
  totQty = totQty!==undefined ? totQty : (window._totQty||0);
  totWt  = totWt!==undefined  ? totWt  : (window._totWt||0);
  sub    = sub!==undefined    ? sub    : (window._sub||0);

  const tfoot=document.getElementById('tfoot-row');
  tfoot.innerHTML='';

  const t0=document.createElement('td'); tfoot.appendChild(t0);

  const sizeKeys=['dia','len','bore'];
  let sizeAdded=false;
  const sizeCount=COLS.filter(c=>sizeKeys.includes(c.key)&&c.vis).length;

  COLS.forEach(col=>{
    if(!col.vis) return;
    const td=document.createElement('td');
    if(sizeKeys.includes(col.key)){
      if(!sizeAdded){
        td.colSpan=sizeCount;
        td.className='tot-label';
        td.textContent='Column Totals ‚Üì';
        tfoot.appendChild(td);
        sizeAdded=true;
      }
      return;
    }
    if(col.key==='weight'){
      td.className='tot-wt rgt'; td.style.textAlign='right';
      td.innerHTML=`<strong>${fmt(totWt)}</strong><div style="font-size:.58rem;color:#888;letter-spacing:1px">kg total</div>`;
    } else if(col.key==='qty'){
      td.className='tot-qty rgt'; td.style.textAlign='right';
      td.innerHTML=`<strong>${fmt(totQty)}</strong><div style="font-size:.58rem;color:#888;letter-spacing:1px">qty total</div>`;
    } else if(col.key==='amount'){
      td.className='tot-amt'; td.style.textAlign='right';
      td.innerHTML=`<strong>${fmt(sub)}</strong><div style="font-size:.58rem;color:#888;letter-spacing:1px">subtotal</div>`;
    } else if(col.key==='desc'){
      td.className='tot-label'; td.textContent='Totals:';
    }
    // rate, unit, custom ‚Äî empty td
    tfoot.appendChild(td);
  });
  const tdel=document.createElement('td'); tfoot.appendChild(tdel);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUMMARY TOTALS BOX
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSumBox(){
  const sub = window._sub || 0;
  const box = document.getElementById('sumbox');
  const cur = V('scur')||'PKR';
  const disc = parseFloat(document.querySelector('#sumbox [data-type="discount"] input')?.value || V('sdisc') || 0);
  const tax  = parseFloat(document.querySelector('#sumbox [data-type="tax"] input')?.value || V('stax') || 18);
  const afterDisc = sub*(1-disc/100);
  const afterTax  = afterDisc*(1+tax/100);

  box.innerHTML='';
  TROWS.forEach(tr=>{
    const row=document.createElement('div');
    row.className='srow'+(tr.type==='grand'?' grand':'');
    row.dataset.type=tr.type;
    if(!tr.vis) row.classList.add('disabled');

    if(tr.type==='subtotal'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(sub)}</span>`;
    } else if(tr.type==='discount'){
      row.innerHTML=`<label>${tr.label} (%)</label><span class="sv"><input type="number" value="${V('sdisc')||0}" min="0" max="100" oninput="renderSumBox()" style="width:50px;border:none;background:transparent;font-weight:600;text-align:right;outline:none;color:var(--iron);font-family:Barlow,sans-serif"> %</span>`;
    } else if(tr.type==='tax'){
      row.innerHTML=`<label>${tr.label} (%)</label><span class="sv"><input type="number" value="${V('stax')||18}" min="0" oninput="renderSumBox()" style="width:50px;border:none;background:transparent;font-weight:600;text-align:right;outline:none;color:var(--iron);font-family:Barlow,sans-serif"> %</span>`;
    } else if(tr.type==='aftertax'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(afterTax)}</span>`;
    } else if(tr.type==='grand'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(afterTax)}</span>`;
    } else if(tr.type==='custom'){
      row.innerHTML=`<label><input type="text" value="${tr.label}" oninput="trLabel('${tr.id}',this.value)" style="width:110px;border:none;background:transparent;color:#666;font-family:Barlow,sans-serif;font-size:.79rem;outline:none"></label><span class="sv">‚Äî</span>`;
    }
    box.appendChild(row);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESET FORM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetForm(){
  if(!confirm('Clear all items? Settings kept.')) return;
  document.getElementById('tbody').innerHTML='';
  rc=0; document.getElementById('cust').value='';
  addRow(); addRow(); addRow();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PDF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function downloadPDF(){
  const sp=document.getElementById('SP');
  const ab=document.querySelector('.add-btn');
  const dbs=document.querySelectorAll('.del-btn');
  const uts=document.querySelectorAll('.utog');
  const uls=document.querySelectorAll('.ulbl');
  sp.style.display='none'; ab.style.display='none';
  dbs.forEach(b=>b.style.display='none');
  uts.forEach(t=>t.style.display='none');
  uls.forEach(l=>l.style.display='inline');
  document.querySelectorAll('.srow.disabled').forEach(r=>r.style.display='none');
  try{
    const el=document.getElementById('QD');
    const canvas=await html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#f5f2ee'});
    const img=canvas.toDataURL('image/png');
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight();
    const ih=canvas.height*pw/canvas.width;
    if(ih<=ph){pdf.addImage(img,'PNG',0,0,pw,ih);}
    else{let y=0;while(y<ih){pdf.addImage(img,'PNG',0,-y,pw,ih);y+=ph;if(y<ih)pdf.addPage();}}
    const co=(V('sc')||'Quote').replace(/\s+/g,'_');
    const ref=V('qref')||'QT';
    pdf.save(`${co}_${ref}.pdf`);
  } finally {
    sp.style.display=''; ab.style.display='';
    dbs.forEach(b=>b.style.display='');
    uts.forEach(t=>t.style.display='');
    uls.forEach(l=>l.style.display='none');
    document.querySelectorAll('.srow.disabled').forEach(r=>r.style.display='');
  }
}
</script>
</body>
</html>
