<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mill Roll Quotation Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Serif+4:wght@300;400;600;700&family=Barlow+Condensed:wght@400;600;700&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#1a1212;
  --accent:#8b0000;
  --accent2:#c0392b;
  --steel:#1a3a5c;
  --gold:#b8860b;
  --warm:#faf8f5;
  --lgray:#e8e4de;
  --mgray:#d0cbc3;
  --dgray:#888;
  --panel:#0f0f0f;
  --panel2:#181818;
  --panel3:#232323;
  --amber:#d4802a;
  --silver:#c0c8d0;

  /* Font settings ‚Äî adjustable */
  --fs-base: 13px;
  --fs-sm: 11px;
  --fs-xs: 10px;
  --fs-sum: 14px;
  --fw-body: 400;
  --fw-label: 600;
  --fw-head: 700;
  --lh: 1.55;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:#b0aba3;color:var(--ink);min-height:100vh;padding:12px;-webkit-text-size-adjust:100%;font-size:var(--fs-base);line-height:var(--lh);}

/* ‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê */
#SP{max-width:1100px;margin:0 auto 14px;border-radius:4px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,.55);}
.stbar{background:#000;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;}
.stbar h2{font-family:'Barlow Condensed',sans-serif;letter-spacing:3px;font-size:.82rem;color:var(--amber);text-transform:uppercase;}
.sbadge{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:2px;padding:2px 8px;font-size:.55rem;letter-spacing:2px;color:#444;text-transform:uppercase;}
.sarr{color:var(--amber);font-size:.8rem;transition:transform .3s;}
.sarr.closed{transform:rotate(180deg);}
.stabs{background:#0a0a0a;display:flex;border-bottom:1px solid #1e1e1e;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.stab{padding:8px 14px;font-family:'Barlow Condensed',sans-serif;font-size:.65rem;letter-spacing:2px;text-transform:uppercase;color:#444;cursor:pointer;border-bottom:2px solid transparent;transition:.2s;white-space:nowrap;flex-shrink:0;}
.stab.active{color:var(--amber);border-bottom-color:var(--amber);}
.stab:hover{color:#aaa;}
.sbody{background:#111;padding:14px 16px 18px;}
.sbody.hide{display:none;}
.spane{display:none;}.spane.active{display:block;}
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;}
.sg{background:#1c1c1c;border:1px solid #2a2a2a;border-radius:3px;padding:10px;}
.sgt{font-family:'Barlow Condensed',sans-serif;font-size:.58rem;letter-spacing:3px;text-transform:uppercase;color:var(--amber);margin-bottom:7px;border-bottom:1px solid #2a2a2a;padding-bottom:3px;}
.sf{display:flex;flex-direction:column;gap:2px;margin-bottom:6px;}.sf:last-child{margin-bottom:0;}
.sf label{font-size:.53rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--silver);}
.sf input,.sf textarea,.sf select{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.78rem;padding:4px 7px;outline:none;width:100%;}
.sf textarea{resize:vertical;min-height:55px;line-height:1.5;}
.sf input:focus,.sf textarea:focus{border-color:var(--accent);}
.lbtn{background:var(--accent);color:#fff;border:none;padding:5px 0;font-family:'Barlow Condensed',sans-serif;font-size:.72rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border-radius:2px;width:100%;margin-top:2px;}
.lbtn:hover{background:#6b0000;}
.lbtn.rem{background:#2a2a2a;color:#666;margin-top:4px;}.lbtn.rem:hover{background:#333;color:#aaa;}
.swide{grid-column:1/-1;}
.abar{display:flex;gap:7px;flex-wrap:wrap;padding-top:8px;}
.btn{padding:7px 15px;font-family:'Barlow Condensed',sans-serif;font-size:.78rem;letter-spacing:2px;text-transform:uppercase;border:none;cursor:pointer;border-radius:2px;font-weight:600;}
.btn-pdf{background:var(--accent);color:#fff;}.btn-pdf:hover{background:#6b0000;}
.btn-print{background:var(--steel);color:#fff;}.btn-print:hover{background:#122a45;}
.btn-rf{background:#2a2a2a;color:#666;}.btn-rf:hover{background:#333;color:#aaa;}
.btn-rs{background:#1a1a1a;color:#333;border:1px solid #2a2a2a;}.btn-rs:hover{background:#222;color:#aaa;}
.btn-share{background:#1e3a2a;color:#4caf50;border:1px solid #2a5c3a;}.btn-share:hover{background:#244d33;}
.btn-link{background:#1a2a3a;color:#4a9fd4;border:1px solid #2a4a6a;}.btn-link:hover{background:#1e3348;}
.btn-link.copied{background:#2a3a1a;color:#8bc34a;border-color:#4a6a2a;}
.sdot{width:6px;height:6px;border-radius:50%;background:#4caf50;display:inline-block;margin-left:6px;opacity:0;transition:opacity .3s;}
.sdot.show{opacity:1;}
/* toggles */
.tsw{position:relative;width:30px;height:16px;flex-shrink:0;}
.tsw input{opacity:0;width:0;height:0;}
.tsl{position:absolute;inset:0;background:#333;border-radius:16px;cursor:pointer;transition:.22s;}
.tsl:before{content:'';position:absolute;width:10px;height:10px;left:3px;top:3px;background:#666;border-radius:50%;transition:.22s;}
.tsw input:checked+.tsl{background:var(--steel);}
.tsw input:checked+.tsl:before{transform:translateX(14px);background:#fff;}
/* col manager */
.clist{display:flex;flex-direction:column;gap:4px;margin-top:4px;}
.citem{display:flex;align-items:center;gap:6px;background:#242424;border:1px solid #2e2e2e;border-radius:2px;padding:5px 8px;cursor:grab;user-select:none;transition:background .12s;}
.citem:active{cursor:grabbing;}
.citem.dragging{opacity:.3;}.citem.drag-over{border-color:var(--amber);}
.cdh{color:#333;font-size:.8rem;flex-shrink:0;}
.cname{flex:1;font-size:.63rem;letter-spacing:1.5px;text-transform:uppercase;color:#aaa;}
.cbadge{font-size:.52rem;color:#444;margin-right:3px;}
/* width grid */
.wgrid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.wf{display:flex;flex-direction:column;gap:1px;}
.wf label{font-size:.52rem;letter-spacing:1.5px;text-transform:uppercase;color:#555;}
.wf input{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.73rem;padding:3px 6px;outline:none;width:100%;}
.wf input:focus{border-color:var(--accent);}
/* totals manager */
.trows-mgr{display:flex;flex-direction:column;gap:4px;margin-top:4px;}
.trow-item{display:flex;align-items:center;gap:6px;background:#242424;border:1px solid #2e2e2e;border-radius:2px;padding:6px 9px;cursor:grab;user-select:none;}
.trow-item:active{cursor:grabbing;}
.trow-item.drag-over{border-color:var(--amber);}
.trow-item input.trow-label-inp{flex:1;background:#1a1a1a;border:1px solid #2e2e2e;border-radius:2px;color:#bbb;font-family:'Barlow',sans-serif;font-size:.76rem;padding:3px 5px;outline:none;}
.trow-item input.trow-label-inp:focus{border-color:var(--accent);}
.trow-del{background:none;border:none;color:#333;cursor:pointer;font-size:.78rem;}.trow-del:hover{color:var(--accent);}
/* custom col manager */
.custom-col-list{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;}
.cc-item{display:flex;align-items:center;gap:6px;background:#242424;border:1px solid #2e2e2e;border-radius:2px;padding:6px 9px;}
.cc-item input{background:#1a1a1a;border:1px solid #2e2e2e;border-radius:2px;color:#bbb;font-family:'Barlow',sans-serif;font-size:.75rem;padding:3px 5px;outline:none;}
.cc-item input:focus{border-color:var(--accent);}
.cc-del{background:none;border:none;color:#333;cursor:pointer;font-size:.85rem;}.cc-del:hover{color:var(--accent);}
.add-cc-btn,.add-tr-btn{background:#1e1e1e;border:1px dashed #3a3a3a;color:#666;border-radius:2px;padding:5px 12px;font-family:'Barlow Condensed',sans-serif;font-size:.68rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;margin-top:5px;}
.add-cc-btn:hover,.add-tr-btn:hover{background:#272727;color:#aaa;}
/* font panel */
.font-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.font-grid .sg{padding:10px;}
.fslider{display:flex;align-items:center;gap:7px;}
.fslider input[type=range]{flex:1;accent-color:var(--amber);}
.fslider span{font-size:.68rem;color:#aaa;min-width:30px;text-align:right;}
/* terms manager */
.terms-list{display:flex;flex-direction:column;gap:5px;margin-bottom:8px;}
.ti-item{display:flex;align-items:center;gap:6px;background:#1e1e1e;border:1px solid #2e2e2e;border-radius:2px;padding:5px 8px;}
.ti-item input{flex:1;background:#141414;border:1px solid #2e2e2e;border-radius:2px;color:#ccc;font-family:'Barlow',sans-serif;font-size:.75rem;padding:3px 5px;outline:none;}
.ti-item input:focus{border-color:var(--accent);}
.ti-del{background:none;border:none;color:#333;cursor:pointer;font-size:.82rem;}.ti-del:hover{color:var(--accent);}
.add-ti-btn{background:#1e1e1e;border:1px dashed #3a3a3a;color:#666;border-radius:2px;padding:5px 12px;font-family:'Barlow Condensed',sans-serif;font-size:.67rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;width:100%;margin-top:4px;}
.add-ti-btn:hover{background:#272727;color:#aaa;}

/* ‚ïê‚ïê‚ïê DOCUMENT ‚ïê‚ïê‚ïê */
#QD{background:var(--warm);max-width:1100px;margin:0 auto;box-shadow:0 6px 36px rgba(0,0,0,.28);overflow:hidden;font-size:var(--fs-base);}

/* HEADER */
.doc-header{padding:16px 22px 12px;border-bottom:2px solid var(--ink);}
.header-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;}
.company-block{flex:1;}
.company-name-wrap{display:flex;align-items:baseline;gap:8px;margin-bottom:2px;}
#dc-big{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--ink);line-height:1;letter-spacing:-0.5px;}
#dc-big span{color:var(--accent);}
#dc-tag{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:5px;}
.addr-block{font-size:.72rem;color:#444;line-height:1.65;margin-top:4px;}
.addr-block .lbl{font-weight:600;color:#222;display:inline-block;min-width:52px;}
.cert-block{display:flex;flex-direction:column;align-items:center;text-align:center;gap:6px;min-width:140px;}
.cert-badges{display:flex;gap:6px;justify-content:center;}
.cert-badge{border:2px solid var(--ink);border-radius:2px;padding:3px 7px;font-family:'Barlow Condensed',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--ink);background:transparent;}
.logo-area{display:flex;justify-content:center;align-items:center;margin-top:4px;}
#logo-display{max-width:88px;max-height:72px;object-fit:contain;display:none;}
#logo-ph{width:72px;height:72px;background:var(--ink);border-radius:50%;display:flex;align-items:center;justify-content:center;}
#logo-ph svg{opacity:.4;}
.pioneer-text{font-family:'Barlow Condensed',sans-serif;font-size:.55rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--ink);text-align:center;border-top:1px solid var(--ink);padding-top:4px;margin-top:2px;}

.doc-meta{background:var(--ink);display:grid;grid-template-columns:repeat(4,1fr);}
.mc{padding:7px 14px;border-right:1px solid rgba(255,255,255,.08);}
.mc:last-child{border-right:none;}
.mc label{display:block;font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:2px;}
.mc input{background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,.18);color:#fff;font-family:'Barlow',sans-serif;font-size:.8rem;width:100%;outline:none;padding:2px 0;}
.mc input::placeholder{color:rgba(255,255,255,.22);}

/* DOC BODY */
.dbody{padding:18px 22px;}

.doc-date-line{font-size:var(--fs-sm);margin-bottom:10px;}
.doc-date-line input{border:none;border-bottom:1px solid #ccc;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);outline:none;color:var(--ink);padding:1px 0;width:120px;}

.customer-block{margin-bottom:12px;}
.customer-block .cust-field{font-size:var(--fs-base);font-weight:var(--fw-label);color:var(--ink);}
.customer-block input.cust-in{border:none;border-bottom:1px solid #bbb;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-base);font-weight:var(--fw-label);outline:none;color:var(--ink);padding:1px 0;width:260px;}
.customer-block .org-in{font-size:var(--fs-base);font-weight:400;}

.doc-subject{text-align:center;margin-bottom:14px;}
.doc-subject input{border:none;border-bottom:2px solid var(--ink);background:transparent;font-family:'Source Serif 4',serif;font-size:.98rem;font-weight:700;text-align:center;outline:none;color:var(--ink);padding:2px 4px;width:340px;letter-spacing:.3px;}
.doc-subject .underline-label{font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:2px;display:block;}

.dear-block{font-size:var(--fs-sm);color:#333;margin-bottom:12px;line-height:1.6;}
.dear-block textarea{width:100%;border:none;border-bottom:1px solid #ddd;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);outline:none;color:var(--ink);padding:2px 0;resize:none;line-height:1.6;}

/* TABLE */
.twrap{overflow-x:auto;margin-bottom:10px;}
table.it{width:100%;border-collapse:collapse;font-size:var(--fs-sm);}
table.it thead tr.thm{background:var(--ink);color:#fff;}
table.it th{padding:7px 8px;text-align:left;font-family:'Barlow Condensed',sans-serif;font-size:.64rem;letter-spacing:1.5px;text-transform:uppercase;font-weight:600;white-space:nowrap;border:1px solid #555;}
table.it th.rgt{text-align:right;}table.it th.ctr{text-align:center;}
table.it tbody tr{border-bottom:1px solid var(--mgray);}
table.it tbody tr:nth-child(even){background:rgba(0,0,0,.018);}
table.it td{padding:5px 8px;vertical-align:middle;border:1px solid var(--mgray);}
table.it td input,table.it td select{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);color:var(--ink);outline:none;padding:1px 0;width:100%;}
table.it td input[type="number"]{text-align:right;}
.tc{text-align:right;font-weight:var(--fw-label);color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-size:.84rem;white-space:nowrap;}
.del-btn{background:none;border:none;cursor:pointer;color:#ccc;font-size:.78rem;padding:0 2px;}
.del-btn:hover{color:var(--accent);}
.sno-td{color:#888;text-align:center;font-size:var(--fs-xs);width:28px;}

/* amount highlight */
.amt-td{text-align:right;font-weight:700;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-size:.88rem;white-space:nowrap;}
.amt-td .rate-note{font-size:.58rem;color:#888;font-weight:400;display:block;}

/* foot totals */
.totals-row-bar{background:#f0ece5;border-top:2px solid var(--steel);}
.totals-row-bar td{padding:5px 8px;font-family:'Barlow Condensed',sans-serif;font-size:var(--fs-sum);font-weight:700;color:var(--steel);text-align:right;border:1px solid var(--mgray);}
.totals-row-bar td.tot-label{text-align:left;font-size:calc(var(--fs-sum) * 0.85);letter-spacing:1.5px;text-transform:uppercase;color:#888;}

.add-btn{margin-top:6px;background:none;border:2px dashed var(--steel);color:var(--steel);font-family:'Barlow Condensed',sans-serif;font-size:.68rem;letter-spacing:2px;text-transform:uppercase;padding:5px 12px;cursor:pointer;border-radius:2px;transition:all .2s;}
.add-btn:hover{background:var(--steel);color:#fff;}

/* TOTALS BOX */
.sum-wrap{display:flex;justify-content:flex-end;margin-top:12px;}
.sumbox{background:#f0ece5;border:1px solid var(--lgray);min-width:280px;}
.srow{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;border-bottom:1px solid var(--lgray);font-size:var(--fs-sum);}
.srow.disabled{opacity:.3;pointer-events:none;}
.srow label{color:#555;display:flex;align-items:center;gap:5px;}
.srow .sv{font-weight:var(--fw-label);font-family:'Barlow Condensed',sans-serif;white-space:nowrap;}
.srow input[type="number"]{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sum);font-weight:600;width:56px;text-align:right;outline:none;color:var(--ink);}
.srow input[type="text"]{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sum);width:115px;outline:none;color:#555;}
.srow.grand{background:var(--ink);color:#fff;padding:10px 12px;}
.srow.grand label{color:#aaa;letter-spacing:2px;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;font-size:calc(var(--fs-sum) * 0.85);}
.srow.grand .sv{font-family:'Barlow Condensed',sans-serif;font-size:calc(var(--fs-sum) * 1.6);color:var(--amber);letter-spacing:1.5px;font-weight:700;}
.cur{margin-right:2px;color:#777;font-size:calc(var(--fs-sum) * 0.9);}.srow.grand .cur{color:#aaa;}
.sumbox .tot-foot{padding:5px 12px;font-family:'Barlow Condensed',sans-serif;font-size:calc(var(--fs-sum) * 0.9);color:#888;border-top:1px solid var(--lgray);text-align:right;}

/* TERMS */
.terms-section{margin-top:16px;}
.terms-section h4{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--ink);margin-bottom:7px;text-decoration:underline;text-underline-offset:3px;}
.terms-list-view{margin-bottom:14px;}
.terms-list-view ol{list-style:lower-roman;margin-left:22px;}
.terms-list-view li{font-size:var(--fs-sm);color:#333;line-height:1.7;padding-left:4px;}
.terms-list-view li .highlight{color:var(--accent);font-weight:700;}
.payment-block{margin-bottom:12px;}
.payment-block .pb-label{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink);margin-bottom:2px;text-decoration:underline;text-underline-offset:2px;}
.payment-block textarea,.warranty-block textarea{width:100%;border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);color:#333;outline:none;resize:none;line-height:1.6;padding:0;}
.warranty-block{margin-bottom:12px;}
.warranty-block .wb-label{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink);margin-bottom:2px;text-decoration:underline;text-underline-offset:2px;}
.thank-block textarea{width:100%;border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:var(--fs-sm);color:#333;outline:none;resize:none;line-height:1.6;padding:0;}

/* SIG */
.sigrow{margin-top:20px;}
.sig-inner{display:inline-block;min-width:220px;}
.sig-line{border-bottom:1.5px solid var(--ink);height:42px;margin-bottom:4px;}
.sig-name{font-family:'Barlow Condensed',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:1px;color:var(--ink);}
.sig-name input{border:none;background:transparent;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;font-weight:700;color:var(--ink);outline:none;width:180px;}

/* FOOTER */
.doc-footer-strip{background:var(--ink);padding:8px 22px;display:flex;justify-content:space-between;align-items:center;gap:12px;}
.footer-manufactures{font-family:'Barlow Condensed',sans-serif;font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:#777;flex:1;}
.footer-manufactures strong{color:#999;}
.footer-contact{text-align:right;}
.footer-contact div{font-family:'Barlow Condensed',sans-serif;letter-spacing:1.5px;color:var(--amber);font-size:.75rem;}
#dcc-main{font-size:.88rem;font-weight:700;}
.doc-foot-bar{background:var(--accent);height:4px;}

/* size cell */
.size-td-wrap{display:flex;align-items:center;gap:2px;}
.size-td-wrap input{flex:1;min-width:28px;text-align:center;font-size:var(--fs-xs);}
.utog{display:flex;border:1px solid #ccc;border-radius:2px;overflow:hidden;flex-shrink:0;}
.utog button{padding:2px 4px;border:none;background:#f0ece5;color:#888;font-family:'Barlow Condensed',sans-serif;font-size:.5rem;cursor:pointer;line-height:1.2;transition:background .12s,color .12s;}
.utog button.active{background:var(--steel);color:#fff;}
.utog button:first-child{border-right:1px solid #ccc;}
.ulbl{font-size:.58rem;color:#999;font-family:'Barlow Condensed',sans-serif;flex-shrink:0;display:none;}

/* ref box */
.ref-box{background:#f0ece5;border:1px solid var(--mgray);padding:6px 12px;margin-bottom:12px;display:flex;gap:18px;flex-wrap:wrap;align-items:center;}
.ref-field{display:flex;align-items:center;gap:6px;}
.ref-field label{font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:#888;white-space:nowrap;}
.ref-field input{border:none;border-bottom:1px solid var(--mgray);background:transparent;font-family:'Barlow',sans-serif;font-size:.8rem;outline:none;color:var(--ink);padding:1px 0;width:130px;}

@media(max-width:680px){
  body{padding:5px;}
  .header-top{flex-direction:column;gap:10px;}
  .cert-block{flex-direction:row;flex-wrap:wrap;justify-content:flex-start;align-items:center;min-width:0;}
  .doc-meta{grid-template-columns:1fr 1fr;}
  .mc{border-right:none;border-bottom:1px solid rgba(255,255,255,.08);padding:7px 10px;}
  .mc:nth-child(odd){border-right:1px solid rgba(255,255,255,.08);}
  .dbody{padding:12px 12px;}
  .twrap{margin:0 -12px;padding:0 12px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
  table.it{min-width:500px;font-size:.7rem;}
  .sum-wrap{justify-content:stretch;}
  .sumbox{width:100%;min-width:0;}
  .doc-footer-strip{flex-direction:column;gap:5px;text-align:center;padding:8px 12px;}
  .footer-contact{text-align:center;}
  #dc-big{font-size:1.5rem;}
  .btn{flex:1 1 calc(50% - 4px);}
  .font-grid{grid-template-columns:1fr;}
}
@media print{
  body{background:#fff;padding:0;}
  #SP{display:none!important;}
  #QD{box-shadow:none;max-width:100%;}
  .add-btn,.del-btn,.utog{display:none!important;}
  .ulbl{display:inline!important;}
  input,select,textarea{border-color:transparent!important;background:transparent!important;}
  .mc input{border-bottom-color:rgba(255,255,255,.18)!important;}
  .srow.disabled{display:none;}
  @page{margin:0;size:A4;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="SP">
  <div class="stbar" onclick="toggleSP()">
    <h2>‚öô Settings &amp; Customization <span class="sdot" id="sdot"></span></h2>
    <span class="sbadge">üîí Hidden in PDF ¬∑ Auto-saved</span>
    <span class="sarr" id="sarr">‚ñ≤</span>
  </div>
  <div class="sbody" id="sbody">
    <div class="stabs">
      <div class="stab active"  onclick="stab('company')">üè≠ Company</div>
      <div class="stab"         onclick="stab('columns')">üìã Columns</div>
      <div class="stab"         onclick="stab('widths')">‚Üî Widths</div>
      <div class="stab"         onclick="stab('totals')">üí∞ Totals</div>
      <div class="stab"         onclick="stab('terms')">üìù Terms</div>
      <div class="stab"         onclick="stab('font')">üî§ Font</div>
    </div>

    <!-- Company -->
    <div class="spane active" id="pane-company">
      <div class="sgrid" style="margin-top:11px">
        <div class="sg">
          <div class="sgt">Logo</div>
          <div class="sf"><label>Upload</label>
            <button class="lbtn" onclick="document.getElementById('li').click()">üìé Upload Logo</button>
            <input type="file" id="li" accept="image/*" style="display:none" onchange="uploadLogo(event)">
          </div>
          <button class="lbtn rem" onclick="removeLogo()">‚úï Remove Logo</button>
        </div>
        <div class="sg">
          <div class="sgt">Company</div>
          <div class="sf"><label>Name</label><input id="sc" value="Mill Roll Specialists" oninput="syncCompany();save()"></div>
          <div class="sf"><label>Tagline</label><input id="st" value="ISO-9001:2008 Certified" oninput="sync('t');save()"></div>
          <div class="sf"><label>Pioneer Text</label><input id="spio" value="Pioneers of Excellence in Roll Casting Metallurgy" oninput="document.getElementById('pioneer-text').textContent=this.value;save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Address</div>
          <div class="sf"><label>Phone (Off)</label><input id="sph1" value="92-042-6631228 (Off)" oninput="renderAddr();save()"></div>
          <div class="sf"><label>Phone (Works)</label><input id="sph2" value="92-042-6543076 (Works)" oninput="renderAddr();save()"></div>
          <div class="sf"><label>Mobile</label><input id="smob" value="0333-4256862, 0300-4265109" oninput="renderAddr();save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Certifications</div>
          <div class="sf"><label>Badge 1</label><input id="scert1" value="JAS-ANZ" oninput="renderCerts();save()"></div>
          <div class="sf"><label>Badge 2</label><input id="scert2" value="QMS" oninput="renderCerts();save()"></div>
          <div class="sf"><label>Badge 3</label><input id="scert3" value="ISO 9001" oninput="renderCerts();save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Footer</div>
          <div class="sf"><label>Manufactures</label><input id="sfmfg" value="Chilled Rolls, S.G. Iron Rolls, Grain Iron Rolls" oninput="document.getElementById('foot-mfg').innerHTML='<strong>MANUFACTURES:</strong> '+this.value;save()"></div>
          <div class="sf"><label>Footer Tag</label><input id="sffor" value="For: Steel Re-Rolling Mills, Non Ferrous Rolling Mills, Flour Mills, Textile Mills, Paper Mills, Plastic and Paints Industry" oninput="document.getElementById('foot-for').innerHTML='<strong>FOR:</strong> '+this.value;save()"></div>
          <div class="sf"><label>Footer Contact</label><input id="sfc" value="03334256862" oninput="document.getElementById('dcc-main').textContent=this.value;save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Currency &amp; Tax</div>
          <div class="sf"><label>Currency</label><input id="scur" value="PKR" oninput="updateCur();save()"></div>
          <div class="sf"><label>Default GST %</label><input type="number" id="stax" value="18" min="0" oninput="save()"></div>
          <div class="sf"><label>Default Discount %</label><input type="number" id="sdisc" value="0" min="0" oninput="save()"></div>
        </div>
        <div class="sg">
          <div class="sgt">Signature</div>
          <div class="sf"><label>Signatory Name</label><input id="ssign" value="Engr. Mian Khurram Akram" oninput="document.getElementById('sig-name-inp').value=this.value;save()"></div>
        </div>
        <div class="abar swide">
          <button class="btn btn-pdf" onclick="downloadPDF()">‚¨á Download PDF</button>
          <button class="btn btn-print" onclick="window.print()">üñ® Print</button>
          <button class="btn btn-rf" onclick="resetForm()">‚Ü∫ Reset Form</button>
          <button class="btn btn-rs" onclick="resetAll()">‚ö† Reset All</button>
        </div>
        <div class="abar swide" style="border-top:1px solid #1e1e1e;margin-top:6px;padding-top:10px;">
          <span style="font-size:.55rem;letter-spacing:2px;text-transform:uppercase;color:#444;align-self:center;">üì≤ Sync:</span>
          <button class="btn btn-share" onclick="exportSettings()">‚¨á Export</button>
          <button class="btn btn-share" onclick="document.getElementById('import-file').click()">‚¨Ü Import</button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="importSettings(event)">
          <button class="btn btn-link" id="share-btn" onclick="copyShareLink()">üîó Copy Share Link</button>
        </div>
      </div>
    </div>

    <!-- Columns -->
    <div class="spane" id="pane-columns">
      <div style="padding:10px 0 3px">
        <p style="font-size:.63rem;color:#444;letter-spacing:1px;margin-bottom:8px;">‚ò∞ Drag to reorder ¬∑ Toggle show/hide ¬∑ Auto-saved</p>
        <div class="clist" id="clist"></div>
        <div style="margin-top:12px;border-top:1px solid #222;padding-top:10px">
          <p style="font-size:.62rem;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px">‚ûï Custom Columns</p>
          <div class="custom-col-list" id="cc-list"></div>
          <button class="add-cc-btn" onclick="addCustomCol()">+ Add Custom Column</button>
        </div>
      </div>
    </div>

    <!-- Widths -->
    <div class="spane" id="pane-widths">
      <div style="padding:10px 0 3px">
        <p style="font-size:.63rem;color:#444;letter-spacing:1px;margin-bottom:8px;">Enter px number or <code style="color:#888">auto</code></p>
        <div class="wgrid" id="wgrid"></div>
      </div>
    </div>

    <!-- Totals -->
    <div class="spane" id="pane-totals">
      <div style="padding:10px 0 3px">
        <p style="font-size:.63rem;color:#444;letter-spacing:1px;margin-bottom:8px;">‚ò∞ Drag to reorder ¬∑ Toggle ¬∑ Edit label ¬∑ Delete</p>
        <div class="trows-mgr" id="trows-mgr"></div>
        <button class="add-tr-btn" onclick="addTotalRow()">+ Add Custom Total Row</button>
      </div>
    </div>

    <!-- Terms Manager -->
    <div class="spane" id="pane-terms">
      <div style="padding:10px 0 3px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <p style="font-size:.62rem;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px">Terms &amp; Conditions</p>
          <div class="terms-list" id="tc-list"></div>
          <button class="add-ti-btn" onclick="addTermItem()">+ Add Term</button>
        </div>
        <div>
          <div class="sf" style="margin-bottom:8px"><label>Payment Text</label>
            <textarea id="s-pay" style="min-height:60px" oninput="document.getElementById('doc-payment').value=this.value;save()">1,000,000/- advance, balance at the time of delivery after final inspection.</textarea>
          </div>
          <div class="sf" style="margin-bottom:8px"><label>Warranty Text</label>
            <textarea id="s-warranty" style="min-height:70px" oninput="document.getElementById('doc-warranty').value=this.value;save()">Mill Roll Specialists offers guarantee for free replacement in case of Roll breakage in normal operation, without mill accident up to first dressing.</textarea>
          </div>
          <div class="sf"><label>Closing / Thanks</label>
            <textarea id="s-thanks" style="min-height:50px" oninput="document.getElementById('doc-thanks').value=this.value;save()">Thanking you and assuring you best of our services.</textarea>
          </div>
          <div class="sf" style="margin-top:6px"><label>Notes / Remarks</label>
            <textarea id="sn" style="min-height:50px" oninput="document.getElementById('doc-notes').value=this.value;save()"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Font -->
    <div class="spane" id="pane-font">
      <div style="padding:10px 0 3px">
        <div class="font-grid">
          <div class="sg">
            <div class="sgt">Totals Box Font</div>
            <div class="fslider">
              <input type="range" id="fs-sum-r" min="10" max="22" value="14" oninput="updateFonts()">
              <span id="fs-sum-v">14px</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Base Font Size</div>
            <div class="fslider">
              <input type="range" id="fs-base-r" min="10" max="18" value="13" oninput="updateFonts()">
              <span id="fs-base-v">13px</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Small Font Size</div>
            <div class="fslider">
              <input type="range" id="fs-sm-r" min="8" max="16" value="11" oninput="updateFonts()">
              <span id="fs-sm-v">11px</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Body Weight</div>
            <div class="fslider">
              <input type="range" id="fw-body-r" min="300" max="600" step="100" value="400" oninput="updateFonts()">
              <span id="fw-body-v">400</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Label Weight</div>
            <div class="fslider">
              <input type="range" id="fw-label-r" min="400" max="700" step="100" value="600" oninput="updateFonts()">
              <span id="fw-label-v">600</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Line Height</div>
            <div class="fslider">
              <input type="range" id="lh-r" min="1.2" max="2.2" step="0.05" value="1.55" oninput="updateFonts()">
              <span id="lh-v">1.55</span>
            </div>
          </div>
          <div class="sg">
            <div class="sgt">Preview</div>
            <p id="font-preview" style="font-size:.75rem;color:#aaa;line-height:1.5">Roll Description: √ò330√ó280√ó117mm<br>Ni-Cr-Mn-Mo-Cu Chilled Cast Iron<br>Approx Wt: 165 Kg/Sleeve</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCUMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="QD">

  <!-- HEADER -->
  <div class="doc-header">
    <div class="header-top">
      <div class="company-block">
        <div class="company-name-wrap">
          <div id="dc-big"><span>Mill Roll</span> Specialists</div>
        </div>
        <div id="dc-tag">ISO-9001:2008 Certified</div>
        <div class="addr-block" id="da">
          <div><span class="lbl">Phone No:</span> 92-042-6631228 (Off) &nbsp; 92-042-6543076 (Works)</div>
          <div><span class="lbl">Mobile No:</span> 0333-4256862 &nbsp; 0300-4265109</div>
        </div>
      </div>
      <div class="cert-block">
        <div class="logo-area">
          <img id="logo-display" src="" alt="Logo">
          <div id="logo-ph">
            <svg width="48" height="48" viewBox="0 0 60 60" fill="none">
              <polygon points="30,4 56,18 56,42 30,56 4,42 4,18" stroke="#c0c8d0" stroke-width="2" fill="none"/>
              <polygon points="30,14 46,23 46,37 30,46 14,37 14,23" stroke="#8b0000" stroke-width="1.5" fill="none"/>
              <circle cx="30" cy="30" r="5" fill="#c0c8d0"/>
            </svg>
          </div>
        </div>
        <div class="cert-badges" id="cert-badges">
          <div class="cert-badge">JAS-ANZ</div>
          <div class="cert-badge">QMS</div>
          <div class="cert-badge" style="font-size:.5rem">ISO 9001</div>
        </div>
        <div class="pioneer-text" id="pioneer-text">Pioneers of Excellence in Roll Casting Metallurgy</div>
      </div>
    </div>
  </div>

  <!-- META BAR -->
  <div class="doc-meta">
    <div class="mc"><label>Issue Date</label><input type="date" id="mdate"></div>
    <div class="mc"><label>Valid Until</label><input type="date" id="mvalid"></div>
    <div class="mc"><label>Delivery Lead Time</label><input type="text" placeholder="e.g. 6‚Äì8 weeks after PO"></div>
    <div class="mc"><label>Payment Terms</label><input type="text" placeholder="50% Advance / 50% Delivery"></div>
  </div>

  <!-- BODY -->
  <div class="dbody">

    <!-- Date line -->
    <div class="doc-date-line">
      <input type="text" id="doc-date-text" placeholder="January 08, 2025" style="width:150px">
    </div>

    <!-- Customer -->
    <div class="customer-block" style="margin-top:8px">
      <div style="margin-bottom:3px">Mr./Ms./Dr. <input class="cust-in" type="text" id="cust" placeholder="Customer Name‚Ä¶"></div>
      <div><input class="cust-in org-in" type="text" id="cust-org" placeholder="Company / Organization‚Ä¶" style="font-size:var(--fs-base);font-weight:400;"></div>
    </div>

    <!-- Reference box -->
    <div class="ref-box">
      <div class="ref-field"><label>Quote No.</label><input type="text" id="qref" value="MRS-2025-001"></div>
      <div class="ref-field"><label>Ref / Subject</label><input type="text" id="qsubj" value="Quotation of Rolls for Finishing Stand" style="width:240px"></div>
    </div>

    <!-- Dear line -->
    <div class="dear-block">
      <textarea id="doc-dear" rows="2" style="width:100%;border:none;border-bottom:1px solid #ddd;background:transparent;font-family:Barlow,sans-serif;font-size:var(--fs-sm);outline:none;color:#333;resize:none;line-height:1.65;">Dear Sir,
Please refer to the telephonic talk and your visit to the Office; we are pleased to quote the rock bottom price of the desired rolls as under.</textarea>
    </div>

    <!-- ITEMS TABLE -->
    <div style="margin-top:12px">
      <div class="twrap">
        <table class="it" id="itable">
          <thead>
            <tr class="thm" id="thm"></tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr class="totals-row-bar" id="tfoot-row"></tr>
          </tfoot>
        </table>
      </div>
      <button class="add-btn" onclick="addRow()">+ Add Item</button>
    </div>

    <!-- TOTALS BOX -->
    <div class="sum-wrap">
      <div class="sumbox" id="sumbox"></div>
    </div>

    <!-- TERMS & CONDITIONS -->
    <div class="terms-section">
      <h4>Terms &amp; Conditions.</h4>
      <div class="terms-list-view">
        <ol id="terms-view-list"></ol>
      </div>

      <div class="payment-block">
        <div class="pb-label">Payment:</div>
        <textarea id="doc-payment" rows="1">1,000,000/- advance, balance at the time of delivery after final inspection.</textarea>
      </div>

      <div class="warranty-block">
        <div class="wb-label">Warranty / Guarantee:</div>
        <textarea id="doc-warranty" rows="3">Mill Roll Specialists offers guarantee for free replacement in case of Roll breakage in normal operation, without mill accident up to first dressing.</textarea>
      </div>

      <div class="thank-block" style="margin-bottom:14px">
        <textarea id="doc-thanks" rows="1">Thanking you and assuring you best of our services.</textarea>
      </div>

      <div id="doc-notes-wrap" style="margin-bottom:14px;display:none">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--ink);margin-bottom:2px;">Notes / Remarks:</div>
        <textarea id="doc-notes" rows="2" style="width:100%;border:none;background:transparent;font-family:Barlow,sans-serif;font-size:var(--fs-sm);color:#333;outline:none;resize:none;line-height:1.6;padding:0;"></textarea>
      </div>
    </div>

    <!-- SIGNATURE -->
    <div class="sigrow">
      <div class="sig-inner">
        <div class="sig-line"></div>
        <div class="sig-name"><input id="sig-name-inp" value="Engr. Mian Khurram Akram" style="width:100%"></div>
      </div>
    </div>

  </div>

  <!-- FOOTER -->
  <div class="doc-footer-strip">
    <div class="footer-manufactures">
      <div id="foot-mfg"><strong>MANUFACTURES:</strong> Chilled Rolls, S.G. Iron Rolls, Grain Iron Rolls</div>
      <div id="foot-for" style="margin-top:2px;"><strong>FOR:</strong> Steel Re-Rolling Mills, Non Ferrous Rolling Mills, Flour Mills, Textile Mills, Paper Mills, Plastic and Paints Industry</div>
    </div>
    <div class="footer-contact">
      <div id="dcc-main">03334256862</div>
    </div>
  </div>
  <div class="doc-foot-bar"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLUMN DEFINITIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const COL_DEFS = [
  {key:'desc',    label:'Roll Description',  vis:true,  w:'auto', fixed:true,              showTotal:false},
  {key:'sno',     label:'S.No',              vis:true,  w:'40',   fixed:false,             showTotal:false},
  {key:'stand',   label:'Stand #',           vis:true,  w:'65',   numeric:false,           showTotal:false},
  {key:'casting', label:'Casting Process',   vis:true,  w:'100',                           showTotal:false},
  {key:'hardness',label:'Hardness',          vis:true,  w:'85',                            showTotal:false},
  {key:'dia',     label:'Dia',               vis:false, w:'auto', size:true,               showTotal:false},
  {key:'len',     label:'Length',            vis:false, w:'auto', size:true,               showTotal:false},
  {key:'bore',    label:'Bore',              vis:false, w:'auto', size:true,               showTotal:false},
  {key:'weight',  label:'Weight (kg)',        vis:false, w:'70',   numeric:true,            showTotal:true},
  {key:'qty',     label:'Quantity',           vis:true,  w:'70',   numeric:true, isQty:true,showTotal:true},
  {key:'unit',    label:'Unit',              vis:false, w:'55',                            showTotal:false},
  {key:'rate',    label:'Rate / kg',         vis:false, w:'80',   numeric:true,            showTotal:false},
  {key:'amount',  label:'Amount',            vis:true,  w:'110',  numeric:true, isAmt:true,showTotal:true},
];

const TROW_DEFS = [
  {id:'subtotal', label:'Subtotal',   type:'subtotal', vis:true,  fixed:true},
  {id:'discount', label:'Discount',  type:'discount', vis:false, fixed:false},
  {id:'tax',      label:'GST / Tax', type:'tax',      vis:true,  fixed:false},
  {id:'aftertax', label:'After Tax', type:'aftertax', vis:false, fixed:false},
  {id:'grand',    label:'Grand Total',type:'grand',   vis:true,  fixed:true},
];

const TERM_DEFS = [
  'Prices Ex- Works Lahore.',
  'Prices are exclusive of 18% G.S.T which will be charged and invoice will be provided.',
  'Rolls will be rough machined with minor machining allowance.',
  'Mill Test Certificate will be provided with each Roll.',
  'Delivery of rolls will start in 6 to 8 weeks of receiving confirm P.O and advance.',
  'Validity of quotation is for 10 days only.',
  'Approximate Weight of Order 2840 Kg',
];

let COLS = [], TROWS = [], CUSTOM_COLS = [], TERM_ITEMS = [];
let rc = 0;
const LS = 'mrspk_qt_v1', LS_LOGO = 'mrspk_logo';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function defState(){
  return {
    c:'Mill Roll Specialists', t:'ISO-9001:2008 Certified',
    pio:'Pioneers of Excellence in Roll Casting Metallurgy',
    off:'61-B Guldasht Town, Zarar Shaheed Road, Lahore Cantt.',
    wrk:'Bismillah Street, Industrial Area, Momenpora, G.T. Road, Daroghawala, Lahore',
    ph1:'92-042-6631228 (Off)', ph2:'92-042-6543076 (Works)',
    fax:'92-042-6633908', mob:'0333-4256862, 0300-4265109',
    eml:'info@mrspk.com  www.mrspk.com',
    cert1:'JAS-ANZ', cert2:'QMS', cert3:'ISO 9001',
    fmfg:'Chilled Rolls, S.G. Iron Rolls, Grain Iron Rolls',
    ffor:'For: Steel Re-Rolling Mills, Non Ferrous Rolling Mills, Flour Mills, Textile Mills, Paper Mills, Plastic and Paints Industry',
    fc:'03334256862',
    sign:'Engr. Mian Khurram Akram',
    cur:'PKR', tax:'18', disc:'0',
    pay:'1,000,000/- advance, balance at the time of delivery after final inspection.',
    warranty:'Mill Roll Specialists offers guarantee for free replacement in case of Roll breakage in normal operation, without mill accident up to first dressing.',
    thanks:'Thanking you and assuring you best of our services.',
    notes:'',
    cols: JSON.parse(JSON.stringify(COL_DEFS)),
    trows: JSON.parse(JSON.stringify(TROW_DEFS)),
    customCols: [],
    termItems: TERM_DEFS.slice(),
    panelOpen: true,
    fsBase:13, fsSm:11, fwBody:400, fwLabel:600, lh:1.55,
  };
}

function loadState(){
  try{
    const r=localStorage.getItem(LS);
    if(r){
      const s=JSON.parse(r);
      if(!s.cols||!Array.isArray(s.cols))   s.cols=JSON.parse(JSON.stringify(COL_DEFS));
      if(!s.trows||!Array.isArray(s.trows)) s.trows=JSON.parse(JSON.stringify(TROW_DEFS));
      if(!s.customCols)                      s.customCols=[];
      if(!s.termItems)                       s.termItems=TERM_DEFS.slice();
      s.cols.forEach(c=>{if(c.fixed)c.vis=true;});
      return s;
    }
  }catch(e){}
  return defState();
}

let _saveTimer=null;
function save(){
  const s={
    c:V('sc'),t:V('st'),pio:V('spio'),
    off:V('soff'),wrk:V('swrk'),ph1:V('sph1'),ph2:V('sph2'),
    fax:V('sfax'),mob:V('smob'),eml:V('seml'),
    cert1:V('scert1'),cert2:V('scert2'),cert3:V('scert3'),
    fmfg:V('sfmfg'),ffor:V('sffor'),fc:V('sfc'),
    sign:V('ssign'),
    cur:V('scur'),tax:V('stax'),disc:V('sdisc'),
    pay:V('s-pay'),warranty:V('s-warranty'),thanks:V('s-thanks'),notes:V('sn'),
    cols:JSON.parse(JSON.stringify(COLS.filter(c=>!c.custom))),
    customCols:JSON.parse(JSON.stringify(CUSTOM_COLS)),
    trows:JSON.parse(JSON.stringify(TROWS)),
    termItems:TERM_ITEMS.slice(),
    panelOpen:!document.getElementById('sbody').classList.contains('hide'),
    fsBase:parseFloat(document.getElementById('fs-base-r').value),
    fsSm:parseFloat(document.getElementById('fs-sm-r').value),
    fsSum:parseFloat(document.getElementById('fs-sum-r').value),
    fwBody:parseInt(document.getElementById('fw-body-r').value),
    fwLabel:parseInt(document.getElementById('fw-label-r').value),
    lh:parseFloat(document.getElementById('lh-r').value),
  };
  localStorage.setItem(LS,JSON.stringify(s));
  clearTimeout(_saveTimer);
  const d=document.getElementById('sdot'); d.classList.add('show');
  _saveTimer=setTimeout(()=>d.classList.remove('show'),1400);
}

function V(id){return document.getElementById(id)?.value||'';}
function setV(id,val){const el=document.getElementById(id);if(el)el.value=val;}
function fmtD(d){return d.toISOString().split('T')[0];}

function resetAll(){if(!confirm('Reset ALL to defaults?'))return;localStorage.removeItem(LS);localStorage.removeItem(LS_LOGO);location.reload();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function init(){
  const s=loadState();
  COLS        = mergeCustomCols(s.cols||JSON.parse(JSON.stringify(COL_DEFS)), s.customCols||[]);
  TROWS       = s.trows||JSON.parse(JSON.stringify(TROW_DEFS));
  CUSTOM_COLS = s.customCols||[];
  TERM_ITEMS  = s.termItems||TERM_DEFS.slice();

  setV('sc',s.c);setV('st',s.t);setV('spio',s.pio||'');
  setV('soff',s.off);setV('swrk',s.wrk);setV('sph1',s.ph1);setV('sph2',s.ph2);
  setV('sfax',s.fax);setV('smob',s.mob);setV('seml',s.eml);
  setV('scert1',s.cert1);setV('scert2',s.cert2);setV('scert3',s.cert3);
  setV('sfmfg',s.fmfg);setV('sffor',s.ffor);setV('sfc',s.fc);
  setV('ssign',s.sign);
  setV('scur',s.cur);setV('stax',s.tax);setV('sdisc',s.disc);
  setV('s-pay',s.pay||'');setV('s-warranty',s.warranty||'');setV('s-thanks',s.thanks||'');setV('sn',s.notes||'');

  // font sliders
  document.getElementById('fs-base-r').value=s.fsBase||13;
  document.getElementById('fs-sm-r').value=s.fsSm||11;
  document.getElementById('fs-sum-r').value=s.fsSum||14;
  document.getElementById('fw-body-r').value=s.fwBody||400;
  document.getElementById('fw-label-r').value=s.fwLabel||600;
  document.getElementById('lh-r').value=s.lh||1.55;
  updateFonts(true);

  applyToDom(s);
  loadLogo();

  if(!s.panelOpen){
    document.getElementById('sbody').classList.add('hide');
    const a=document.getElementById('sarr'); a.textContent='‚ñº'; a.classList.add('closed');
  }

  const td=new Date();
  document.getElementById('mdate').value=fmtD(td);
  const vd=new Date(td); vd.setDate(vd.getDate()+30);
  document.getElementById('mvalid').value=fmtD(vd);
  document.getElementById('doc-date-text').value=td.toLocaleDateString('en-US',{month:'long',day:'2-digit',year:'numeric'}).replace(',','');

  // wire doc-notes visibility
  document.getElementById('sn').addEventListener('input',()=>{
    document.getElementById('doc-notes-wrap').style.display=document.getElementById('doc-notes').value.trim()?'block':'none';
  });

  buildColManager(); buildWidthManager(); buildTrowsManager(); buildCustomColManager(); buildTermManager();
  renderHeaders(); addRow(); addRow(); addRow();
  renderSumBox(); renderTermsView();
}

function mergeCustomCols(cols,customCols){
  const filtered=cols.filter(c=>!c.custom);
  customCols.forEach(cc=>{
    filtered.push({key:cc.key,label:cc.label,vis:cc.vis!==false,w:cc.w||'auto',custom:true,showTotal:false});
  });
  return filtered;
}

function applyToDom(s){
  syncCompany();
  document.getElementById('dc-tag').textContent=s.t||'';
  document.getElementById('pioneer-text').textContent=s.pio||'';
  renderAddr();
  renderCerts();
  document.getElementById('dcc-main').textContent=s.fc||'';
  document.getElementById('sig-name-inp').value=s.sign||'';
  document.getElementById('doc-payment').value=s.pay||'';
  document.getElementById('doc-warranty').value=s.warranty||'';
  document.getElementById('doc-thanks').value=s.thanks||'';
  document.getElementById('doc-notes').value=s.notes||'';
  document.getElementById('doc-notes-wrap').style.display=(s.notes||'').trim()?'block':'none';
  document.getElementById('foot-mfg').innerHTML='<strong>MANUFACTURES:</strong> '+(s.fmfg||'');
  document.getElementById('foot-for').innerHTML='<strong>FOR:</strong> '+(s.ffor||'');
  updateCur(s.cur);
}

function syncCompany(){
  const v=V('sc');
  const parts=v.split(' ');
  const last=parts.pop()||'';
  const first=parts.join(' ');
  document.getElementById('dc-big').innerHTML=`<span>${first}</span> ${last}`;
}
function sync(k){
  if(k==='t') document.getElementById('dc-tag').textContent=V('st');
}
function renderAddr(){
  const el=document.getElementById('da');
  el.innerHTML=`
    <div><span class="lbl">Phone No:</span> ${V('sph1')} &nbsp; ${V('sph2')}</div>
    <div><span class="lbl">Mobile No:</span> ${V('smob')}</div>
  `;
}
function renderCerts(){
  const badges=document.getElementById('cert-badges'); badges.innerHTML='';
  [V('scert1'),V('scert2'),V('scert3')].filter(Boolean).forEach(b=>{
    const d=document.createElement('div'); d.className='cert-badge'; d.textContent=b; badges.appendChild(d);
  });
}
function updateCur(v){
  const c=v||V('scur')||'PKR';
  document.querySelectorAll('.cur').forEach(el=>el.textContent=c+' ');
}
function updateFonts(silent){
  const fsBase=document.getElementById('fs-base-r').value;
  const fsSm=document.getElementById('fs-sm-r').value;
  const fsSum=document.getElementById('fs-sum-r').value;
  const fwBody=document.getElementById('fw-body-r').value;
  const fwLabel=document.getElementById('fw-label-r').value;
  const lh=document.getElementById('lh-r').value;
  document.getElementById('fs-base-v').textContent=fsBase+'px';
  document.getElementById('fs-sm-v').textContent=fsSm+'px';
  document.getElementById('fs-sum-v').textContent=fsSum+'px';
  document.getElementById('fw-body-v').textContent=fwBody;
  document.getElementById('fw-label-v').textContent=fwLabel;
  document.getElementById('lh-v').textContent=lh;
  const root=document.documentElement;
  root.style.setProperty('--fs-base',fsBase+'px');
  root.style.setProperty('--fs-sm',fsSm+'px');
  root.style.setProperty('--fs-sum',fsSum+'px');
  root.style.setProperty('--fw-body',fwBody);
  root.style.setProperty('--fw-label',fwLabel);
  root.style.setProperty('--lh',lh);
  document.getElementById('font-preview').style.fontWeight=fwBody;
  if(!silent) save();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function uploadLogo(e){
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader(); r.onload=ev=>{
    const i=document.getElementById('logo-display'); i.src=ev.target.result; i.style.display='block';
    document.getElementById('logo-ph').style.display='none';
    try{localStorage.setItem(LS_LOGO,ev.target.result);}catch(e){}
  }; r.readAsDataURL(f);
}
function removeLogo(){
  const i=document.getElementById('logo-display'); i.src=''; i.style.display='none';
  document.getElementById('logo-ph').style.display='flex';
  document.getElementById('li').value='';
  try{localStorage.removeItem(LS_LOGO);}catch(e){}
}
function loadLogo(){
  try{const src=localStorage.getItem(LS_LOGO);if(src){
    const i=document.getElementById('logo-display'); i.src=src; i.style.display='block';
    document.getElementById('logo-ph').style.display='none';
  }}catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleSP(){
  const b=document.getElementById('sbody'),a=document.getElementById('sarr');
  const h=b.classList.toggle('hide');
  a.classList.toggle('closed',h); a.textContent=h?'‚ñº':'‚ñ≤'; save();
}
function stab(name){
  const tabs=['company','columns','widths','totals','terms','font'];
  document.querySelectorAll('.stab').forEach((t,i)=>t.classList.toggle('active',tabs[i]===name));
  document.querySelectorAll('.spane').forEach(p=>p.classList.remove('active'));
  document.getElementById('pane-'+name).classList.add('active');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TERMS MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildTermManager(){
  const list=document.getElementById('tc-list'); list.innerHTML='';
  TERM_ITEMS.forEach((txt,i)=>{
    const item=document.createElement('div'); item.className='ti-item';
    item.innerHTML=`<input value="${txt.replace(/"/g,'&quot;')}" oninput="TERM_ITEMS[${i}]=this.value;renderTermsView();save()">
    <button class="ti-del" onclick="removeTermItem(${i})">‚úï</button>`;
    list.appendChild(item);
  });
}
function addTermItem(){
  TERM_ITEMS.push('New term');
  buildTermManager(); renderTermsView(); save();
}
function removeTermItem(i){
  TERM_ITEMS.splice(i,1);
  buildTermManager(); renderTermsView(); save();
}
function renderTermsView(){
  const ol=document.getElementById('terms-view-list'); ol.innerHTML='';
  TERM_ITEMS.forEach(txt=>{
    const li=document.createElement('li');
    // highlight numbers like 2840 Kg or 18% in accent color
    li.innerHTML=txt.replace(/(\d[\d,.]*\s*(Kg|kg|%|days|weeks))/g,'<span class="highlight">$1</span>');
    ol.appendChild(li);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLUMN MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildColManager(){
  const list=document.getElementById('clist'); list.innerHTML='';
  COLS.forEach(col=>{
    const item=document.createElement('div'); item.className='citem'; item.draggable=true; item.dataset.key=col.key;
    item.innerHTML=`<span class="cdh">‚ò∞</span>
      <span class="cname">${col.label}${col.custom?' <span style="color:#444;font-size:.53rem">[custom]</span>':''}</span>
      ${col.fixed?'<span class="cbadge">always on</span>':`<label class="tsw"><input type="checkbox" ${col.vis?'checked':''} onchange="colVis('${col.key}',this.checked)"><span class="tsl"></span></label>`}`;
    item.addEventListener('dragstart',e=>{_dragKey=col.key;item.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
    item.addEventListener('dragend',()=>{item.classList.remove('dragging');document.querySelectorAll('.citem').forEach(i=>i.classList.remove('drag-over'));});
    item.addEventListener('dragover',e=>{e.preventDefault();item.classList.add('drag-over');});
    item.addEventListener('dragleave',()=>item.classList.remove('drag-over'));
    item.addEventListener('drop',e=>{e.preventDefault();item.classList.remove('drag-over');colReorder(_dragKey,col.key);});
    list.appendChild(item);
  });
}
let _dragKey=null;
function colVis(key,v){const c=COLS.find(x=>x.key===key);if(c&&!c.fixed)c.vis=v;renderHeaders();refreshRows();renderFootTotals();save();}
function colReorder(from,to){
  if(from===to)return;
  const fi=COLS.findIndex(c=>c.key===from),ti=COLS.findIndex(c=>c.key===to);
  const[m]=COLS.splice(fi,1);COLS.splice(ti,0,m);
  buildColManager();buildWidthManager();renderHeaders();refreshRows();renderFootTotals();save();
}
let _ccId=0;
function addCustomCol(label,w,key){
  _ccId++;
  const k=key||'cc_'+Date.now()+'_'+_ccId;
  const cc={key:k,label:label||'Column '+_ccId,w:w||'auto'};
  CUSTOM_COLS.push(cc);
  COLS.push({key:k,label:cc.label,vis:true,w:cc.w,custom:true,showTotal:false});
  buildCustomColManager();buildColManager();buildWidthManager();renderHeaders();refreshRows();renderFootTotals();save();
}
function removeCustomCol(key){
  CUSTOM_COLS=CUSTOM_COLS.filter(c=>c.key!==key);
  const idx=COLS.findIndex(c=>c.key===key);if(idx>=0)COLS.splice(idx,1);
  buildCustomColManager();buildColManager();buildWidthManager();renderHeaders();refreshRows();renderFootTotals();save();
}
function updateCustomColLabel(key,label){
  const cc=CUSTOM_COLS.find(c=>c.key===key);if(cc)cc.label=label;
  const col=COLS.find(c=>c.key===key);if(col)col.label=label;
  buildColManager();buildWidthManager();renderHeaders();refreshRows();save();
}
function buildCustomColManager(){
  const list=document.getElementById('cc-list');list.innerHTML='';
  CUSTOM_COLS.forEach(cc=>{
    const item=document.createElement('div');item.className='cc-item';
    item.innerHTML=`<input value="${cc.label}" placeholder="Column label" oninput="updateCustomColLabel('${cc.key}',this.value)" style="flex:1">
    <button class="cc-del" onclick="removeCustomCol('${cc.key}')">‚úï</button>`;
    list.appendChild(item);
  });
}
function buildWidthManager(){
  const g=document.getElementById('wgrid');g.innerHTML='';
  COLS.forEach(col=>{
    const d=document.createElement('div');d.className='wf';
    d.innerHTML=`<label>${col.label}</label><input value="${col.w||'auto'}" placeholder="auto" oninput="colW('${col.key}',this.value)">`;
    g.appendChild(d);
  });
}
function colW(key,val){const col=COLS.find(c=>c.key===key);if(col)col.w=val.trim()||'auto';renderHeaders();refreshRows();save();}
function getWpx(col){const v=col.w||'auto';if(!v||v==='auto')return '';return isNaN(v)?v:v+'px';}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOTAL ROWS MANAGER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _trDragId=null;
function buildTrowsManager(){
  const mgr=document.getElementById('trows-mgr');mgr.innerHTML='';
  TROWS.forEach(tr=>{
    const item=document.createElement('div');item.className='trow-item';item.draggable=!tr.fixed;item.dataset.id=tr.id;
    item.innerHTML=`${tr.fixed?'<span style="color:#222;font-size:.8rem">‚äò</span>':'<span class="cdh" style="cursor:grab">‚ò∞</span>'}
      <input class="trow-label-inp" value="${tr.label}" ${tr.fixed?'style="color:#444"':''} oninput="trLabel('${tr.id}',this.value)">
      <label class="tsw"><input type="checkbox" ${tr.vis?'checked':''} onchange="trVis('${tr.id}',this.checked)"><span class="tsl"></span></label>
      ${tr.fixed?'':'<button class="trow-del" onclick="trDel(\''+tr.id+'\')">‚úï</button>'}`;
    if(!tr.fixed){
      item.addEventListener('dragstart',e=>{_trDragId=tr.id;item.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
      item.addEventListener('dragend',()=>{item.classList.remove('dragging');document.querySelectorAll('.trow-item').forEach(i=>i.classList.remove('drag-over'));});
      item.addEventListener('dragover',e=>{e.preventDefault();item.classList.add('drag-over');});
      item.addEventListener('dragleave',()=>item.classList.remove('drag-over'));
      item.addEventListener('drop',e=>{e.preventDefault();item.classList.remove('drag-over');trReorder(_trDragId,tr.id);});
    }
    mgr.appendChild(item);
  });
}
function trLabel(id,v){const r=TROWS.find(t=>t.id===id);if(r)r.label=v;renderSumBox();save();}
function trVis(id,v){const r=TROWS.find(t=>t.id===id);if(r)r.vis=v;renderSumBox();save();}
function trDel(id){TROWS=TROWS.filter(t=>t.id!==id);buildTrowsManager();renderSumBox();save();}
function trReorder(from,to){
  if(from===to)return;
  const fi=TROWS.findIndex(t=>t.id===from),ti=TROWS.findIndex(t=>t.id===to);
  const[m]=TROWS.splice(fi,1);TROWS.splice(ti,0,m);
  buildTrowsManager();renderSumBox();save();
}
function addTotalRow(){
  const id='tr_'+Date.now();
  TROWS.splice(TROWS.length-1,0,{id,label:'Custom Row',type:'custom',vis:true,fixed:false});
  buildTrowsManager();renderSumBox();save();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER HEADERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderHeaders(){
  const thm=document.getElementById('thm');
  thm.innerHTML='';

  const sizeKeys=['dia','len','bore'];
  const visSizes=COLS.filter(c=>sizeKeys.includes(c.key)&&c.vis);
  let sizeAdded=false;

  // # header
  const h0=document.createElement('th');h0.style.cssText='width:28px;text-align:center';h0.textContent='S.No';
  // we'll handle sno column in row rendering

  COLS.forEach(col=>{
    if(!col.vis)return;
    const ws=getWpx(col);
    if(sizeKeys.includes(col.key)){
      if(!sizeAdded){
        const grp=document.createElement('th');grp.className='ctr';
        grp.colSpan=visSizes.length;
        grp.textContent='Size (in/mm per field)';
        thm.appendChild(grp);sizeAdded=true;
      }
      return;
    }
    const th=document.createElement('th');
    th.textContent=col.label;
    if(['weight','qty','rate','amount'].includes(col.key))th.className='rgt';
    if(ws)th.style.width=ws;
    thm.appendChild(th);
  });

  // size sub headers
  if(visSizes.length>0){
    // we need a second header row for size subs ‚Äî append to same row via a ths row
    // Instead, we add sub-labels inline via row rendering, so just skip second row complexity
    // Add size sub-headers as separate row
    const ths=document.getElementById('ths')||createSubHeaderRow();
    ths.innerHTML='';
    COLS.filter(c=>c.vis).forEach(col=>{
      if(sizeKeys.includes(col.key)){
        const th=document.createElement('th');th.className='ctr';th.textContent=col.label;
        const ws=getWpx(col);if(ws)th.style.width=ws;
        ths.appendChild(th);
      }
    });
  } else {
    const ths=document.getElementById('ths');if(ths)ths.remove();
  }

  const tdel=document.createElement('th');tdel.style.width='22px';thm.appendChild(tdel);
}

function createSubHeaderRow(){
  const tr=document.createElement('tr');tr.id='ths';tr.style.cssText='background:#273d4d;';
  tr.querySelectorAll('th').forEach=()=>{};
  const thead=document.querySelector('#itable thead');
  thead.appendChild(tr);
  return tr;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROWS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function makeSizeCell(){
  const w=document.createElement('div');w.className='size-td-wrap';
  const inp=document.createElement('input');inp.type='text';inp.placeholder='‚Äî';
  let unit='in';
  const lbl=document.createElement('span');lbl.className='ulbl';lbl.textContent='in';
  const tog=document.createElement('div');tog.className='utog';
  const bI=document.createElement('button');bI.textContent='in';bI.type='button';bI.className='active';
  const bM=document.createElement('button');bM.textContent='mm';bM.type='button';
  function su(u){unit=u;lbl.textContent=u;bI.classList.toggle('active',u==='in');bM.classList.toggle('active',u==='mm');}
  bI.onclick=()=>su('in');bM.onclick=()=>su('mm');
  tog.appendChild(bI);tog.appendChild(bM);
  w.appendChild(inp);w.appendChild(tog);w.appendChild(lbl);
  return w;
}

function buildCells(n){
  const cells={};
  // S.No
  const tsno=document.createElement('td');tsno.className='sno-td';tsno.dataset.col='sno';
  const isno=document.createElement('input');isno.type='text';isno.value=n;isno.style.cssText='width:100%;text-align:center;font-size:var(--fs-xs);color:#666;';
  tsno.appendChild(isno);cells['sno']=tsno;
  // desc
  const tdesc=document.createElement('td');tdesc.dataset.col='desc';
  const idesc=document.createElement('input');idesc.type='text';idesc.placeholder='e.g. √ò330√ó280√ó117mm Ni-Cr-Mn-Mo-Cu Chilled Cast Iron';idesc.style.width='100%';tdesc.appendChild(idesc);
  cells['desc']=tdesc;
  // stand
  const tstand=document.createElement('td');tstand.dataset.col='stand';
  const istand=document.createElement('input');istand.type='text';istand.placeholder='FM';istand.style.width='100%';tstand.appendChild(istand);
  cells['stand']=tstand;
  // casting
  const tcast=document.createElement('td');tcast.dataset.col='casting';
  const icast=document.createElement('input');icast.type='text';icast.placeholder='Centrifugally cast';icast.style.width='100%';tcast.appendChild(icast);
  cells['casting']=tcast;
  // hardness
  const thard=document.createElement('td');thard.dataset.col='hardness';
  const ihard=document.createElement('input');ihard.type='text';ihard.placeholder='70-75¬∞SH';ihard.style.width='100%';thard.appendChild(ihard);
  cells['hardness']=thard;
  // size cols
  ['dia','len','bore'].forEach(k=>{const t=document.createElement('td');t.dataset.col=k;t.appendChild(makeSizeCell());cells[k]=t;});
  // weight
  const tw=document.createElement('td');tw.dataset.col='weight';
  const iw=document.createElement('input');iw.type='number';iw.className='wgt';iw.value='0';iw.min='0';iw.step='0.001';iw.oninput=calc;iw.style.width='100%';tw.appendChild(iw);
  cells['weight']=tw;
  // qty
  const tq=document.createElement('td');tq.dataset.col='qty';
  const iq=document.createElement('input');iq.type='number';iq.className='qqty';iq.value='1';iq.min='0';iq.oninput=calc;iq.style.width='100%';tq.appendChild(iq);
  cells['qty']=tq;
  // unit
  const tu=document.createElement('td');tu.dataset.col='unit';
  const su=document.createElement('select');su.style.cssText='width:100%;border:none;background:transparent;font-family:Barlow,sans-serif;font-size:var(--fs-sm);color:var(--ink);outline:none;';
  ['Pcs','Kg','MT','Set','Lot'].forEach(u=>{const o=document.createElement('option');o.textContent=u;su.appendChild(o);});tu.appendChild(su);
  cells['unit']=tu;
  // rate
  const tr2=document.createElement('td');tr2.dataset.col='rate';
  const ir=document.createElement('input');ir.type='number';ir.className='rrate';ir.value='0';ir.min='0';ir.step='0.01';ir.oninput=calc;ir.style.width='100%';tr2.appendChild(ir);
  cells['rate']=tr2;
  // amount
  const ta=document.createElement('td');ta.dataset.col='amount';ta.className='amt-td';
  ta.innerHTML='<span class="amt-val">‚Äî</span><span class="rate-note amt-note"></span>';
  cells['amount']=ta;
  // delete
  const tx=document.createElement('td');
  const bx=document.createElement('button');bx.className='del-btn';bx.textContent='‚úï';bx.onclick=()=>delRow(n);tx.appendChild(bx);
  cells['delete']=tx;
  return cells;
}

function renderRow(tr,n){
  const cells=tr._cells||(tr._cells=buildCells(n));
  while(tr.firstChild)tr.removeChild(tr.firstChild);
  const sizeKeys=['dia','len','bore'];
  COLS.forEach(col=>{
    let td=cells[col.key];
    if(!td){
      if(col.custom){
        const ctd=document.createElement('td');ctd.dataset.col=col.key;
        const ci=document.createElement('input');ci.type='text';ci.style.width='100%';ci.placeholder='‚Äî';
        ctd.appendChild(ci);cells[col.key]=ctd;td=ctd;
      } else return;
    }
    td.style.display=col.vis?'':'none';
    const ws=getWpx(col);if(ws)td.style.width=ws;else td.style.width='';
    tr.appendChild(td);
  });
  tr.appendChild(cells['delete']);
}

function addRow(){
  rc++;const n=rc;
  const tr=document.createElement('tr');tr.id='r'+n;
  tr._cells=buildCells(n);
  renderRow(tr,n);
  document.getElementById('tbody').appendChild(tr);
  calc();
}
function delRow(n){const el=document.getElementById('r'+n);if(el)el.remove();calc();}
function refreshRows(){document.querySelectorAll('#tbody tr').forEach(tr=>{if(tr._cells){const n=parseInt(tr.id.replace('r',''));renderRow(tr,n);}});calc();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function calc(){
  let sub=0,totWt=0,totQty=0;
  document.querySelectorAll('#tbody tr').forEach(tr=>{
    const w=parseFloat(tr.querySelector('.wgt')?.value||0);
    const q=parseFloat(tr.querySelector('.qqty')?.value||0);
    const r=parseFloat(tr.querySelector('.rrate')?.value||0);
    const amt=w*r;
    const av=tr.querySelector('.amt-val');if(av)av.textContent=amt>0?'PKR '+fmt(amt):'‚Äî';
    const an=tr.querySelector('.amt-note');if(an)an.textContent=r>0?'PKR '+fmt(r)+'/kg':'';
    sub+=amt;totWt+=w;totQty+=q;
  });
  window._sub=sub;window._totWt=totWt;window._totQty=totQty;
  renderFootTotals(totQty,totWt,sub);
  renderSumBox();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FOOT TOTALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderFootTotals(totQty,totWt,sub){
  totQty=totQty!==undefined?totQty:(window._totQty||0);
  totWt=totWt!==undefined?totWt:(window._totWt||0);
  sub=sub!==undefined?sub:(window._sub||0);
  const tfoot=document.getElementById('tfoot-row');tfoot.innerHTML='';
  const sizeKeys=['dia','len','bore'];
  let sizeAdded=false;
  const sizeCount=COLS.filter(c=>sizeKeys.includes(c.key)&&c.vis).length;
  COLS.forEach(col=>{
    if(!col.vis)return;
    const td=document.createElement('td');
    if(sizeKeys.includes(col.key)){
      if(!sizeAdded){td.colSpan=sizeCount;td.className='tot-label';td.textContent='Column Totals ‚Üì';tfoot.appendChild(td);sizeAdded=true;}return;
    }
    if(col.key==='weight'){td.style.textAlign='right';td.innerHTML=`<strong>${fmt(totWt)}</strong><div style="font-size:.57rem;color:#888">kg total</div>`;}
    else if(col.key==='qty'){td.style.textAlign='right';td.innerHTML=`<strong>${fmt(totQty)}</strong><div style="font-size:.57rem;color:#888">qty total</div>`;}
    else if(col.key==='amount'){td.style.textAlign='right';td.innerHTML=`<strong style="color:var(--accent)">${fmt(sub)}</strong><div style="font-size:.57rem;color:#888">subtotal</div>`;}
    else if(col.key==='desc'){td.className='tot-label';td.textContent='Totals:';}
    tfoot.appendChild(td);
  });
  const tdel=document.createElement('td');tfoot.appendChild(tdel);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUM BOX ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSumBox(){
  const sub=window._sub||0;
  const box=document.getElementById('sumbox');
  const cur=V('scur')||'PKR';
  const disc=parseFloat(document.querySelector('#sumbox [data-type="discount"] input')?.value||V('sdisc')||0);
  const tax=parseFloat(document.querySelector('#sumbox [data-type="tax"] input')?.value||V('stax')||18);
  const afterDisc=sub*(1-disc/100);
  const afterTax=afterDisc*(1+tax/100);
  box.innerHTML='';
  TROWS.forEach(tr=>{
    const row=document.createElement('div');
    row.className='srow'+(tr.type==='grand'?' grand':'');
    row.dataset.type=tr.type;
    if(!tr.vis)row.classList.add('disabled');
    if(tr.type==='subtotal'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(sub)}</span>`;
    } else if(tr.type==='discount'){
      row.innerHTML=`<label>${tr.label} (%)</label><span class="sv"><input type="number" value="${V('sdisc')||0}" min="0" max="100" oninput="renderSumBox()"> %</span>`;
    } else if(tr.type==='tax'){
      row.innerHTML=`<label>${tr.label} (%)</label><span class="sv"><input type="number" value="${V('stax')||18}" min="0" oninput="renderSumBox()"> %</span>`;
    } else if(tr.type==='aftertax'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(afterTax)}</span>`;
    } else if(tr.type==='grand'){
      row.innerHTML=`<label>${tr.label}</label><span class="sv"><span class="cur">${cur} </span>${fmt(afterTax)}</span>`;
    } else if(tr.type==='custom'){
      row.innerHTML=`<label><input type="text" value="${tr.label}" oninput="trLabel('${tr.id}',this.value)" style="width:110px;border:none;background:transparent;color:#555;font-family:Barlow,sans-serif;font-size:.78rem;outline:none"></label><span class="sv">‚Äî</span>`;
    }
    box.appendChild(row);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetForm(){
  if(!confirm('Clear all items? Settings kept.'))return;
  document.getElementById('tbody').innerHTML='';rc=0;
  document.getElementById('cust').value='';document.getElementById('cust-org').value='';
  addRow();addRow();addRow();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function downloadPDF(){
  const sp=document.getElementById('SP');
  const ab=document.querySelector('.add-btn');
  const dbs=document.querySelectorAll('.del-btn');
  const uts=document.querySelectorAll('.utog');
  const uls=document.querySelectorAll('.ulbl');
  sp.style.display='none';ab.style.display='none';
  dbs.forEach(b=>b.style.display='none');
  uts.forEach(t=>t.style.display='none');
  uls.forEach(l=>l.style.display='inline');
  document.querySelectorAll('.srow.disabled').forEach(r=>r.style.display='none');
  try{
    const el=document.getElementById('QD');
    const canvas=await html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#faf8f5'});
    const img=canvas.toDataURL('image/png');
    const{jsPDF}=window.jspdf;
    const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const pw=pdf.internal.pageSize.getWidth(),ph=pdf.internal.pageSize.getHeight();
    const ih=canvas.height*pw/canvas.width;
    if(ih<=ph){pdf.addImage(img,'PNG',0,0,pw,ih);}
    else{let y=0;while(y<ih){pdf.addImage(img,'PNG',0,-y,pw,ih);y+=ph;if(y<ih)pdf.addPage();}}
    const co=(V('sc')||'Quote').replace(/\s+/g,'_');
    const ref=V('qref')||'QT';
    pdf.save(`${co}_${ref}.pdf`);
  }finally{
    sp.style.display='';ab.style.display='';
    dbs.forEach(b=>b.style.display='');
    uts.forEach(t=>t.style.display='');
    uls.forEach(l=>l.style.display='none');
    document.querySelectorAll('.srow.disabled').forEach(r=>r.style.display='');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT/IMPORT/SHARE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getSettingsObj(){
  return{
    c:V('sc'),t:V('st'),pio:V('spio'),
    off:V('soff'),wrk:V('swrk'),ph1:V('sph1'),ph2:V('sph2'),
    fax:V('sfax'),mob:V('smob'),eml:V('seml'),
    cert1:V('scert1'),cert2:V('scert2'),cert3:V('scert3'),
    fmfg:V('sfmfg'),ffor:V('sffor'),fc:V('sfc'),sign:V('ssign'),
    cur:V('scur'),tax:V('stax'),disc:V('sdisc'),
    pay:V('s-pay'),warranty:V('s-warranty'),thanks:V('s-thanks'),notes:V('sn'),
    cols:JSON.parse(JSON.stringify(COLS.filter(c=>!c.custom))),
    customCols:JSON.parse(JSON.stringify(CUSTOM_COLS)),
    trows:JSON.parse(JSON.stringify(TROWS)),
    termItems:TERM_ITEMS.slice(),
    panelOpen:!document.getElementById('sbody').classList.contains('hide'),
    fsBase:parseFloat(document.getElementById('fs-base-r').value),
    fsSm:parseFloat(document.getElementById('fs-sm-r').value),
    fsSum:parseFloat(document.getElementById('fs-sum-r').value),
    fwBody:parseInt(document.getElementById('fw-body-r').value),
    fwLabel:parseInt(document.getElementById('fw-label-r').value),
    lh:parseFloat(document.getElementById('lh-r').value),
  };
}
function exportSettings(){
  const blob=new Blob([JSON.stringify(getSettingsObj(),null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='mrspk-settings.json';a.click();URL.revokeObjectURL(url);
}
function importSettings(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{try{const s=JSON.parse(ev.target.result);localStorage.setItem(LS,JSON.stringify(s));alert('Settings imported! Reloading‚Ä¶');location.reload();}catch(err){alert('Invalid settings file.');}};
  reader.readAsText(file);e.target.value='';
}
function copyShareLink(){
  const encoded=btoa(unescape(encodeURIComponent(JSON.stringify(getSettingsObj()))));
  const url=location.href.split('#')[0]+'#settings='+encoded;
  navigator.clipboard.writeText(url).then(()=>{
    const btn=document.getElementById('share-btn');const orig=btn.textContent;
    btn.textContent='‚úì Link Copied!';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent=orig;btn.classList.remove('copied');},2500);
  }).catch(()=>prompt('Copy this link:',url));
}
function loadFromUrlHash(){
  try{const hash=location.hash;if(hash.startsWith('#settings=')){const encoded=hash.slice('#settings='.length);const s=JSON.parse(decodeURIComponent(escape(atob(encoded))));localStorage.setItem(LS,JSON.stringify(s));history.replaceState(null,'',location.pathname+location.search);return true;}}catch(e){}return false;
}

loadFromUrlHash();
init();
</script>
</body>
</html>
