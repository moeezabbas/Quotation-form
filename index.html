<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quotation â€“ Abbas & Sons Roll Tech</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@300;400;500;600&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --iron:#1a1a1a;--rust:#b84a1e;--steel:#3d5a6e;
  --silver:#c0c8d0;--warm:#f5f2ee;--amber:#d4802a;--lgray:#e8e4df;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:#c8c4bc;color:var(--iron);min-height:100vh;padding:14px;}

/* â•â• SETTINGS PANEL â•â• */
#settings-panel{max-width:1100px;margin:0 auto 16px;border-radius:5px;overflow:hidden;box-shadow:0 4px 22px rgba(0,0,0,.45);}
.s-topbar{background:#000;padding:11px 20px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;}
.s-topbar h2{font-family:'Bebas Neue',sans-serif;letter-spacing:4px;font-size:1rem;color:var(--amber);}
.s-badge{background:#1a1a1a;border:1px solid #3a3a3a;border-radius:3px;padding:3px 9px;font-size:.59rem;letter-spacing:2px;color:#555;text-transform:uppercase;}
.s-arr{color:var(--amber);font-size:.85rem;transition:transform .3s;}
.s-arr.closed{transform:rotate(180deg);}

.s-tabs{background:#0a0a0a;display:flex;border-bottom:1px solid #222;}
.s-tab{padding:9px 18px;font-family:'Barlow Condensed',sans-serif;font-size:.72rem;letter-spacing:2px;text-transform:uppercase;color:#555;cursor:pointer;border-bottom:2px solid transparent;transition:.2s;}
.s-tab.active{color:var(--amber);border-bottom-color:var(--amber);}
.s-tab:hover{color:#aaa;}

.s-body{background:#111;padding:18px 20px 22px;}
.s-body.hide{display:none;}
.s-pane{display:none;} .s-pane.active{display:block;}

.s-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:13px;}
.sg{background:#1c1c1c;border:1px solid #2a2a2a;border-radius:3px;padding:12px;}
.sg-title{font-family:'Barlow Condensed',sans-serif;font-size:.62rem;letter-spacing:3px;text-transform:uppercase;color:var(--amber);margin-bottom:9px;border-bottom:1px solid #2a2a2a;padding-bottom:5px;}
.sf{display:flex;flex-direction:column;gap:3px;margin-bottom:8px;}
.sf:last-child{margin-bottom:0;}
.sf label{font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--silver);}
.sf input,.sf textarea,.sf select{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.81rem;padding:5px 8px;outline:none;width:100%;}
.sf textarea{resize:vertical;min-height:62px;line-height:1.5;}
.sf input:focus,.sf textarea:focus{border-color:var(--rust);}
.logo-btn{background:var(--rust);color:#fff;border:none;padding:6px 0;font-family:'Barlow Condensed',sans-serif;font-size:.76rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border-radius:2px;width:100%;margin-top:3px;}
.logo-btn:hover{background:#9e3614;}
.logo-btn.rem{background:#2a2a2a;color:#777;margin-top:6px;} .logo-btn.rem:hover{background:#333;color:#aaa;}
.s-wide{grid-column:1/-1;}
.action-bar{display:flex;gap:9px;flex-wrap:wrap;padding-top:12px;}
.btn{padding:9px 20px;font-family:'Barlow Condensed',sans-serif;font-size:.86rem;letter-spacing:2px;text-transform:uppercase;border:none;cursor:pointer;border-radius:2px;font-weight:600;}
.btn-pdf{background:var(--rust);color:#fff;} .btn-pdf:hover{background:#9e3614;}
.btn-print{background:var(--steel);color:#fff;} .btn-print:hover{background:#2c3f50;}
.btn-reset-form{background:#2a2a2a;color:#777;} .btn-reset-form:hover{background:#333;color:#aaa;}
.btn-reset-settings{background:#1a1a1a;color:#555;border:1px solid #333;} .btn-reset-settings:hover{background:#222;color:#aaa;}

/* Toggle switch */
.tog-switch{position:relative;width:32px;height:17px;flex-shrink:0;}
.tog-switch input{opacity:0;width:0;height:0;}
.tog-slider{position:absolute;inset:0;background:#333;border-radius:17px;cursor:pointer;transition:.25s;}
.tog-slider:before{content:'';position:absolute;width:11px;height:11px;left:3px;top:3px;background:#666;border-radius:50%;transition:.25s;}
.tog-switch input:checked+.tog-slider{background:var(--steel);}
.tog-switch input:checked+.tog-slider:before{transform:translateX(15px);background:#fff;}

/* â”€â”€ Column manager (drag list) â”€â”€ */
.col-list{display:flex;flex-direction:column;gap:5px;margin-top:2px;}
.col-item{
  display:flex;align-items:center;gap:8px;
  background:#242424;border:1px solid #333;border-radius:3px;padding:6px 9px;
  cursor:grab;transition:background .15s;user-select:none;
}
.col-item:active{cursor:grabbing;}
.col-item.dragging{opacity:.4;background:#2e2e2e;}
.col-item.drag-over{border-color:var(--amber);background:#1e1e14;}
.drag-handle{color:#444;font-size:.85rem;flex-shrink:0;}
.col-item-name{flex:1;font-size:.7rem;letter-spacing:1.5px;text-transform:uppercase;color:#bbb;}
.col-vis-badge{font-size:.58rem;letter-spacing:1px;color:#555;margin-right:4px;}

/* Width controls */
.width-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.wf{display:flex;flex-direction:column;gap:2px;}
.wf label{font-size:.56rem;letter-spacing:1.5px;text-transform:uppercase;color:#777;}
.wf input{background:#232323;border:1px solid #363636;border-radius:2px;color:#ddd;font-family:'Barlow',sans-serif;font-size:.78rem;padding:4px 7px;outline:none;width:100%;}
.wf input:focus{border-color:var(--rust);}

/* â•â• DOCUMENT â•â• */
#quote-doc{background:var(--warm);max-width:1100px;margin:0 auto;box-shadow:0 6px 36px rgba(0,0,0,.28);overflow:hidden;}
.doc-topbar{background:var(--iron);height:7px;}
.doc-header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:18px;padding:24px 32px 18px;border-bottom:3px solid var(--rust);position:relative;}
.doc-header::after{content:'';position:absolute;bottom:-6px;left:0;right:0;height:1px;background:var(--amber);}
#logo-display{width:80px;height:80px;object-fit:contain;display:none;}
#logo-ph{width:80px;height:80px;background:var(--iron);display:flex;align-items:center;justify-content:center;}
#logo-ph svg{opacity:.4;}
#disp-company{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:4px;line-height:1;}
#disp-tagline{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--rust);margin-top:3px;}
#disp-addr{font-size:.72rem;color:#666;margin-top:6px;line-height:1.6;}
.qtitle-block{text-align:right;}
.qtitle-block h1{font-family:'Bebas Neue',sans-serif;font-size:2.6rem;letter-spacing:6px;color:var(--steel);line-height:1;}
.qref-label{font-size:.63rem;letter-spacing:2px;text-transform:uppercase;color:#999;margin-top:4px;}
.qref-input{text-align:right;border:none;border-bottom:2px solid var(--rust);font-family:'Barlow Condensed',sans-serif;font-size:1.05rem;font-weight:700;color:var(--rust);outline:none;background:transparent;width:150px;}

.doc-meta{background:var(--steel);display:grid;grid-template-columns:repeat(4,1fr);}
.mc{padding:9px 16px;border-right:1px solid rgba(255,255,255,.1);}
.mc:last-child{border-right:none;}
.mc label{display:block;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;color:var(--silver);margin-bottom:2px;}
.mc input{background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,.22);color:#fff;font-family:'Barlow',sans-serif;font-size:.84rem;width:100%;outline:none;padding:2px 0;}
.mc input::placeholder{color:rgba(255,255,255,.26);}

.doc-body{padding:24px 32px;}
.customer-row{display:grid;grid-template-columns:1fr auto;align-items:end;gap:18px;background:#ede9e3;border-left:4px solid var(--rust);padding:12px 15px;margin-bottom:20px;}
.cr-left label,.cr-right label{display:block;font-family:'Bebas Neue',sans-serif;font-size:.76rem;letter-spacing:3px;margin-bottom:4px;}
.cr-left label{color:var(--rust);} .cr-right label{color:var(--steel);}
.cr-left input{width:100%;background:transparent;border:none;border-bottom:1px solid #bbb;font-family:'Barlow',sans-serif;font-size:.93rem;color:var(--iron);outline:none;padding:3px 0;}
.cr-left input::placeholder{color:#bbb;}
.cr-right input{width:145px;background:transparent;border:none;border-bottom:2px solid var(--rust);font-family:'Barlow Condensed',sans-serif;font-weight:700;color:var(--rust);font-size:1rem;outline:none;text-align:right;padding:3px 0;}

.stitle{font-family:'Bebas Neue',sans-serif;font-size:.92rem;letter-spacing:4px;color:var(--iron);border-bottom:2px solid var(--rust);padding-bottom:5px;margin-bottom:11px;display:flex;align-items:center;gap:9px;}
.stitle .line{flex:1;height:1px;background:var(--lgray);}

/* TABLE */
.tbl-wrap{overflow-x:auto;}
table.itable{width:100%;border-collapse:collapse;font-size:.76rem;table-layout:auto;}
table.itable thead tr.th-main{background:var(--iron);color:var(--warm);}
table.itable thead tr.th-sub{background:#273d4d;}
table.itable th{padding:8px 6px;text-align:left;font-family:'Barlow Condensed',sans-serif;font-size:.65rem;letter-spacing:1.5px;text-transform:uppercase;font-weight:600;white-space:nowrap;}
table.itable th.rgt{text-align:right;} table.itable th.ctr{text-align:center;}
.th-sub th{color:#8aabb8;font-size:.6rem;letter-spacing:1px;font-weight:400;padding:4px 6px;border-right:1px solid rgba(255,255,255,.06);}
.th-sub th:last-child{border-right:none;}
table.itable tbody tr{border-bottom:1px solid var(--lgray);}
table.itable tbody tr:nth-child(even){background:rgba(0,0,0,.015);}
table.itable tbody tr:hover{background:#ede9e3;}
table.itable td{padding:5px 6px;vertical-align:middle;}
table.itable td input,table.itable td select{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:.76rem;color:var(--iron);outline:none;padding:2px 0;width:100%;}
table.itable td input[type="number"]{text-align:right;}
.tc{text-align:right;font-weight:600;color:var(--rust);font-family:'Barlow Condensed',sans-serif;font-size:.85rem;white-space:nowrap;}
.del-btn{background:none;border:none;cursor:pointer;color:#ccc;font-size:.82rem;padding:0 2px;}
.del-btn:hover{color:var(--rust);}

/* Size cell */
.size-td{display:flex;align-items:center;gap:2px;}
.size-td input{flex:1;min-width:28px;text-align:center;font-size:.74rem;}
.unit-toggle{display:flex;border:1px solid #d0cbc5;border-radius:3px;overflow:hidden;flex-shrink:0;}
.unit-toggle button{padding:2px 4px;border:none;background:#ede9e3;color:#999;font-family:'Barlow Condensed',sans-serif;font-size:.54rem;cursor:pointer;line-height:1.2;transition:background .15s,color .15s;}
.unit-toggle button.active{background:var(--steel);color:#fff;}
.unit-toggle button:first-child{border-right:1px solid #d0cbc5;}
.unit-label{font-size:.62rem;color:#999;font-family:'Barlow Condensed',sans-serif;flex-shrink:0;display:none;}

.add-btn{margin-top:8px;background:none;border:2px dashed var(--steel);color:var(--steel);font-family:'Barlow Condensed',sans-serif;font-size:.73rem;letter-spacing:2px;text-transform:uppercase;padding:6px 14px;cursor:pointer;border-radius:2px;transition:all .2s;}
.add-btn:hover{background:var(--steel);color:#fff;}

/* Totals */
.totals-wrap{display:flex;justify-content:flex-end;margin-top:16px;}
.tbox{background:#ede9e3;border:1px solid var(--lgray);min-width:290px;}
.trow{display:flex;justify-content:space-between;align-items:center;padding:7px 14px;border-bottom:1px solid var(--lgray);font-size:.8rem;}
.trow label{color:#666;} .trow .v{font-weight:600;font-family:'Barlow Condensed',sans-serif;}
.trow input[type="number"]{border:none;background:transparent;font-family:'Barlow',sans-serif;font-size:.8rem;font-weight:600;width:50px;text-align:right;outline:none;color:var(--iron);}
.trow.grand{background:var(--iron);color:#fff;padding:10px 14px;}
.trow.grand label{color:var(--silver);letter-spacing:2px;font-family:'Barlow Condensed',sans-serif;text-transform:uppercase;font-size:.65rem;}
.trow.grand .v{font-family:'Bebas Neue',sans-serif;font-size:1.35rem;color:var(--amber);letter-spacing:2px;}
.cur{margin-right:2px;color:#999;font-size:.75rem;} .trow.grand .cur{color:#aaa;}

/* Notes & terms */
.nt-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:20px;}
.nb h4{font-family:'Bebas Neue',sans-serif;letter-spacing:3px;font-size:.78rem;color:var(--steel);margin-bottom:5px;}
.nb textarea{width:100%;background:#ede9e3;border:1px solid var(--lgray);border-left:3px solid var(--steel);font-family:'Barlow',sans-serif;font-size:.76rem;color:var(--iron);padding:8px 10px;resize:vertical;outline:none;min-height:72px;line-height:1.6;}

/* Signatures */
.sig-row{display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-top:24px;padding-top:16px;border-top:1px solid var(--lgray);}
.sb label{display:block;font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:#aaa;margin-bottom:6px;}
.sl{border-bottom:1px solid var(--iron);height:34px;margin-bottom:4px;}
.sb p{font-size:.68rem;color:#bbb;}

/* Footer */
.doc-foot{background:var(--iron);padding:12px 32px;display:flex;justify-content:space-between;align-items:center;}
#disp-foot-name{font-family:'Bebas Neue',sans-serif;letter-spacing:3px;color:var(--silver);font-size:.85rem;}
#disp-foot-contact{font-family:'Bebas Neue',sans-serif;letter-spacing:2px;color:var(--amber);font-size:1.1rem;}
.doc-botbar{background:var(--rust);height:5px;}

/* Save indicator */
.save-dot{width:7px;height:7px;border-radius:50%;background:#4caf50;display:inline-block;margin-left:8px;opacity:0;transition:opacity .3s;}
.save-dot.show{opacity:1;}

/* â•â• PRINT â•â• */
@media print{
  body{background:#fff;padding:0;}
  #settings-panel{display:none!important;}
  #quote-doc{box-shadow:none;max-width:100%;}
  .add-btn,.del-btn{display:none!important;}
  .unit-toggle{display:none!important;}
  .unit-label{display:inline!important;}
  input,select{border-color:transparent!important;background:transparent!important;}
  .mc input{border-bottom-color:rgba(255,255,255,.22)!important;}
  .nb textarea{border:none!important;padding:0!important;background:transparent!important;}
  @page{margin:0;size:A4;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     âš™ SETTINGS PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="settings-panel">
  <div class="s-topbar" onclick="toggleSettings()">
    <h2>âš™ Settings &amp; Customization
      <span class="save-dot" id="save-dot" title="Settings saved"></span>
    </h2>
    <span class="s-badge">ğŸ”’ Hidden in PDF Â· Auto-saved to browser</span>
    <span class="s-arr" id="sarr">â–²</span>
  </div>

  <div class="s-body" id="sbody">
    <!-- Tabs -->
    <div class="s-tabs">
      <div class="s-tab active" onclick="switchTab('company')">ğŸ­ Company</div>
      <div class="s-tab" onclick="switchTab('columns')">ğŸ“‹ Columns</div>
      <div class="s-tab" onclick="switchTab('widths')">â†” Widths</div>
      <div class="s-tab" onclick="switchTab('content')">ğŸ“ Content</div>
    </div>

    <!-- TAB: Company -->
    <div class="s-pane active" id="pane-company">
      <div class="s-grid" style="margin-top:14px">
        <div class="sg">
          <div class="sg-title">Logo</div>
          <div class="sf"><label>Upload Logo</label>
            <button class="logo-btn" onclick="document.getElementById('logo-input').click()">ğŸ“ Upload Logo</button>
            <input type="file" id="logo-input" accept="image/*" style="display:none" onchange="uploadLogo(event)">
          </div>
          <button class="logo-btn rem" onclick="removeLogo()">âœ• Remove Logo</button>
        </div>
        <div class="sg">
          <div class="sg-title">Company</div>
          <div class="sf"><label>Company Name</label><input id="s-company" value="Abbas & Sons Roll Tech" oninput="sync('company');saveSettings()"></div>
          <div class="sf"><label>Tagline</label><input id="s-tagline" value="Specialized in Casting Steel Mill Rolls and Centrifugal Rolls" oninput="sync('tagline');saveSettings()"></div>
        </div>
        <div class="sg">
          <div class="sg-title">Address</div>
          <div class="sf"><label>Header Address</label>
            <textarea id="s-addr" oninput="sync('addr');saveSettings()">Karol Ghatti, Lahore</textarea>
          </div>
        </div>
        <div class="sg">
          <div class="sg-title">Footer</div>
          <div class="sf"><label>Footer Name</label><input id="s-foot-name" value="Abbas & Sons Roll Tech" oninput="sync('foot-name');saveSettings()"></div>
          <div class="sf"><label>Footer Contact</label><input id="s-foot-contact" value="03009429705" oninput="sync('foot-contact');saveSettings()"></div>
        </div>
        <div class="sg">
          <div class="sg-title">Currency &amp; Tax</div>
          <div class="sf"><label>Currency Symbol</label><input id="s-currency" value="PKR" oninput="updateCurrency();saveSettings()"></div>
          <div class="sf"><label>Default GST/Tax %</label><input type="number" id="s-default-tax" value="18" min="0" oninput="document.getElementById('tax').value=this.value;calcTotals();saveSettings()"></div>
          <div class="sf"><label>Default Discount %</label><input type="number" id="s-default-disc" value="0" min="0" oninput="document.getElementById('discount').value=this.value;calcTotals();saveSettings()"></div>
        </div>
        <div class="sg">
          <div class="sg-title">Signature Labels</div>
          <div class="sf"><label>Signatory 1</label><input id="s-sig1" value="Authorized Signatory" oninput="document.getElementById('sig1-label').textContent=this.value;saveSettings()"></div>
          <div class="sf"><label>Signatory 2</label><input id="s-sig2" value="Client Acceptance" oninput="document.getElementById('sig2-label').textContent=this.value;saveSettings()"></div>
        </div>
        <div class="action-bar s-wide">
          <button class="btn btn-pdf" onclick="downloadPDF()">â¬‡ Download PDF</button>
          <button class="btn btn-print" onclick="window.print()">ğŸ–¨ Print</button>
          <button class="btn btn-reset-form" onclick="resetForm()">â†º Reset Form Data</button>
          <button class="btn btn-reset-settings" onclick="resetAllSettings()">âš  Reset All Settings</button>
        </div>
      </div>
    </div>

    <!-- TAB: Columns (visibility + drag to reorder) -->
    <div class="s-pane" id="pane-columns">
      <div style="padding:14px 0 6px">
        <p style="font-size:.68rem;color:#666;letter-spacing:1px;margin-bottom:12px;">
          â˜° <strong style="color:#888">Drag</strong> to reorder &nbsp;Â·&nbsp; Toggle switch to show/hide &nbsp;Â·&nbsp; Changes save automatically
        </p>
        <div class="col-list" id="col-list"></div>
      </div>
    </div>

    <!-- TAB: Widths -->
    <div class="s-pane" id="pane-widths">
      <div style="padding:14px 0 6px">
        <p style="font-size:.68rem;color:#666;letter-spacing:1px;margin-bottom:12px;">
          Enter a number (px) or <code style="color:#aaa">auto</code> for each column width.
        </p>
        <div class="width-grid" id="width-grid"></div>
      </div>
    </div>

    <!-- TAB: Content -->
    <div class="s-pane" id="pane-content">
      <div style="padding:14px 0 6px;display:grid;grid-template-columns:1fr 1fr;gap:13px;">
        <div class="sf">
          <label>Notes</label>
          <textarea id="s-notes" style="min-height:90px" oninput="syncTA('notes');saveSettings()">All castings subject to standard inspection per agreed Sizes.
Pattern / tooling cost billed separately if applicable.</textarea>
        </div>
        <div class="sf">
          <label>Terms &amp; Conditions</label>
          <textarea id="s-terms" style="min-height:90px" oninput="syncTA('terms');saveSettings()">Payment: 50% advance, 50% against delivery.
Validity: Prices valid for 30 days from issue date.</textarea>
        </div>
      </div>
    </div>

  </div><!-- /s-body -->
</div><!-- /settings-panel -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     QUOTATION DOCUMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="quote-doc">
  <div class="doc-topbar"></div>
  <div class="doc-header">
    <div>
      <img id="logo-display" src="" alt="Logo">
      <div id="logo-ph">
        <svg width="56" height="56" viewBox="0 0 60 60" fill="none">
          <polygon points="30,4 56,18 56,42 30,56 4,42 4,18" stroke="#c0c8d0" stroke-width="2" fill="none"/>
          <polygon points="30,14 46,23 46,37 30,46 14,37 14,23" stroke="#b84a1e" stroke-width="1.5" fill="none"/>
          <circle cx="30" cy="30" r="5" fill="#c0c8d0"/>
        </svg>
      </div>
    </div>
    <div>
      <div id="disp-company">Abbas &amp; Sons Roll Tech</div>
      <div id="disp-tagline">Specialized in Casting Steel Mill Rolls and Centrifugal Rolls</div>
      <div id="disp-addr">Karol Ghatti, Lahore</div>
    </div>
    <div class="qtitle-block">
      <h1>QUOTATION</h1>
      <div class="qref-label">Quote Reference</div>
      <input class="qref-input" type="text" id="quote-ref" value="AST-2026-001">
    </div>
  </div>

  <div class="doc-meta">
    <div class="mc"><label>Issue Date</label><input type="date" id="meta-date"></div>
    <div class="mc"><label>Valid Until</label><input type="date" id="meta-valid"></div>
    <div class="mc"><label>Delivery Lead Time</label><input type="text" placeholder="e.g. 4â€“6 weeks after PO"></div>
    <div class="mc"><label>Payment Terms</label><input type="text" placeholder="50% Advance / 50% Delivery"></div>
  </div>

  <div class="doc-body">
    <div class="customer-row">
      <div class="cr-left">
        <label>Customer / Party Name</label>
        <input type="text" id="customer-name" placeholder="Enter customer or party nameâ€¦">
      </div>
      <div class="cr-right">
        <label>Quote No.</label>
        <input type="text" value="AST-2026-001" oninput="document.getElementById('quote-ref').value=this.value">
      </div>
    </div>

    <div class="stitle">Items &amp; Specifications <span class="line"></span></div>
    <div class="tbl-wrap">
      <table class="itable" id="itable">
        <thead>
          <tr class="th-main" id="th-main-row">
            <th style="width:28px">#</th>
            <th id="th-desc">Item / Description</th>
            <!-- size group: colspan updated dynamically -->
            <th id="th-size-grp" class="ctr" colspan="3">Size <span style="font-size:.54rem;opacity:.45;font-weight:400">(in/mm per field)</span></th>
            <th id="th-weight" class="rgt">Wt(kg)</th>
            <th id="th-qty" class="rgt">Qty</th>
            <th id="th-unit">Unit</th>
            <th id="th-rate" class="rgt">Rate/kg</th>
            <th id="th-amount" class="rgt">Amount</th>
            <th style="width:22px"></th>
          </tr>
          <tr class="th-sub" id="th-sub-row">
            <th></th><th></th>
            <th id="th-dia" class="ctr">Dia</th>
            <th id="th-len" class="ctr">Length</th>
            <th id="th-bore" class="ctr">Bore</th>
            <th></th><th></th><th></th><th></th><th></th><th></th>
          </tr>
        </thead>
        <tbody id="items-body"></tbody>
      </table>
    </div>
    <button class="add-btn" onclick="addRow()">+ Add Item</button>

    <div class="totals-wrap">
      <div class="tbox">
        <div class="trow"><label>Subtotal</label><span class="v"><span class="cur" id="cur1">PKR</span> <span id="subtotal">0.00</span></span></div>
        <div class="trow"><label>Discount (%)</label><span class="v"><input type="number" id="discount" value="0" min="0" max="100" oninput="calcTotals()"> %</span></div>
        <div class="trow"><label>GST / Tax (%)</label><span class="v"><input type="number" id="tax" value="18" min="0" oninput="calcTotals()"> %</span></div>
        <div class="trow"><label>After Tax</label><span class="v"><span class="cur" id="cur2">PKR</span> <span id="after-tax">0.00</span></span></div>
        <div class="trow grand"><label>Grand Total</label><span class="v"><span class="cur" id="cur3">PKR</span> <span id="grand-total">0.00</span></span></div>
      </div>
    </div>

    <div class="nt-grid">
      <div class="nb"><h4>Notes</h4>
        <textarea id="doc-notes">All castings subject to standard inspection per agreed Sizes.
Pattern / tooling cost billed separately if applicable.</textarea>
      </div>
      <div class="nb"><h4>Terms &amp; Conditions</h4>
        <textarea id="doc-terms">Payment: 50% advance, 50% against delivery.
Validity: Prices valid for 30 days from issue date.</textarea>
      </div>
    </div>

    <div class="sig-row">
      <div class="sb"><label id="sig1-label">Authorized Signatory</label><div class="sl"></div><p>Name &amp; Designation / Stamp</p></div>
      <div class="sb"><label id="sig2-label">Client Acceptance</label><div class="sl"></div><p>Name &amp; Designation / Company Stamp</p></div>
    </div>
  </div>

  <div class="doc-foot">
    <div id="disp-foot-name">ABBAS &amp; SONS ROLL TECH</div>
    <div id="disp-foot-contact">03009429705</div>
  </div>
  <div class="doc-botbar"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLUMN DEFINITIONS â€” order here = default order
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COL_DEFAULTS = [
  { key:'desc',   label:'Description', visible:true,  width:'auto', fixed:true  }, // always visible, not toggleable
  { key:'dia',    label:'Dia',         visible:true,  width:'auto', size:true   },
  { key:'len',    label:'Length',      visible:true,  width:'auto', size:true   },
  { key:'bore',   label:'Bore',        visible:true,  width:'auto', size:true   },
  { key:'weight', label:'Weight (kg)', visible:true,  width:'62'               },
  { key:'qty',    label:'Qty',         visible:true,  width:'44'               },
  { key:'unit',   label:'Unit',        visible:false, width:'50'               },
  { key:'rate',   label:'Rate / kg',   visible:true,  width:'78'               },
  { key:'amount', label:'Amount',      visible:true,  width:'86'               },
];

// Live column state (loaded from storage or defaults)
let COLS = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCAL STORAGE KEYS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LS_KEY = 'abbrol_settings_v3';

function defaultSettings(){
  return {
    company:      'Abbas & Sons Roll Tech',
    tagline:      'Specialized in Casting Steel Mill Rolls and Centrifugal Rolls',
    addr:         'Karol Ghatti, Lahore',
    footName:     'Abbas & Sons Roll Tech',
    footContact:  '03009429705',
    currency:     'PKR',
    defTax:       '18',
    defDisc:      '0',
    sig1:         'Authorized Signatory',
    sig2:         'Client Acceptance',
    notes:        'All castings subject to standard inspection per agreed Sizes.\nPattern / tooling cost billed separately if applicable.',
    terms:        'Payment: 50% advance, 50% against delivery.\nValidity: Prices valid for 30 days from issue date.',
    cols:         JSON.parse(JSON.stringify(COL_DEFAULTS)),
    panelOpen:    true,
  };
}

function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const s = JSON.parse(raw);
      // merge cols: if stored cols exist use them (preserves order + state)
      // but fill in any missing keys from defaults
      if(s.cols && Array.isArray(s.cols)){
        const defaultKeys = COL_DEFAULTS.map(c=>c.key);
        const storedKeys  = s.cols.map(c=>c.key);
        // add any new cols from defaults that aren't in stored
        defaultKeys.forEach(k=>{ if(!storedKeys.includes(k)){ s.cols.push(COL_DEFAULTS.find(c=>c.key===k)); } });
      } else {
        s.cols = JSON.parse(JSON.stringify(COL_DEFAULTS));
      }
      return s;
    }
  } catch(e){}
  return defaultSettings();
}

let saveTimer = null;
function saveSettings(){
  const s = {
    company:     document.getElementById('s-company').value,
    tagline:     document.getElementById('s-tagline').value,
    addr:        document.getElementById('s-addr').value,
    footName:    document.getElementById('s-foot-name').value,
    footContact: document.getElementById('s-foot-contact').value,
    currency:    document.getElementById('s-currency').value,
    defTax:      document.getElementById('s-default-tax').value,
    defDisc:     document.getElementById('s-default-disc').value,
    sig1:        document.getElementById('s-sig1').value,
    sig2:        document.getElementById('s-sig2').value,
    notes:       document.getElementById('s-notes').value,
    terms:       document.getElementById('s-terms').value,
    cols:        JSON.parse(JSON.stringify(COLS)),
    panelOpen:   !document.getElementById('sbody').classList.contains('hide'),
  };
  localStorage.setItem(LS_KEY, JSON.stringify(s));
  // Flash save dot
  clearTimeout(saveTimer);
  const dot = document.getElementById('save-dot');
  dot.classList.add('show');
  saveTimer = setTimeout(()=>dot.classList.remove('show'), 1500);
}

function resetAllSettings(){
  if(!confirm('Reset ALL settings to factory defaults? This cannot be undone.')) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APPLY SETTINGS TO DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applySettingsToInputs(s){
  document.getElementById('s-company').value      = s.company;
  document.getElementById('s-tagline').value      = s.tagline;
  document.getElementById('s-addr').value         = s.addr;
  document.getElementById('s-foot-name').value    = s.footName;
  document.getElementById('s-foot-contact').value = s.footContact;
  document.getElementById('s-currency').value     = s.currency;
  document.getElementById('s-default-tax').value  = s.defTax;
  document.getElementById('s-default-disc').value = s.defDisc;
  document.getElementById('s-sig1').value         = s.sig1;
  document.getElementById('s-sig2').value         = s.sig2;
  document.getElementById('s-notes').value        = s.notes;
  document.getElementById('s-terms').value        = s.terms;
  document.getElementById('tax').value            = s.defTax;
  document.getElementById('discount').value       = s.defDisc;
}

function applySettingsToDoc(s){
  document.getElementById('disp-company').textContent = s.company;
  document.getElementById('disp-tagline').textContent = s.tagline;
  document.getElementById('disp-addr').innerHTML      = s.addr.replace(/\n/g,'<br>');
  document.getElementById('disp-foot-name').textContent    = s.footName.toUpperCase();
  document.getElementById('disp-foot-contact').textContent = s.footContact;
  document.getElementById('sig1-label').textContent   = s.sig1;
  document.getElementById('sig2-label').textContent   = s.sig2;
  document.getElementById('doc-notes').value          = s.notes;
  document.getElementById('doc-terms').value          = s.terms;
  updateCurrency(s.currency);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(name){
  document.querySelectorAll('.s-tab').forEach((t,i)=>t.classList.remove('active'));
  document.querySelectorAll('.s-pane').forEach(p=>p.classList.remove('active'));
  const tabs = document.querySelectorAll('.s-tab');
  const tabNames = ['company','columns','widths','content'];
  tabs[tabNames.indexOf(name)].classList.add('active');
  document.getElementById('pane-'+name).classList.add('active');
}

function toggleSettings(){
  const b=document.getElementById('sbody'), a=document.getElementById('sarr');
  const h=b.classList.toggle('hide');
  a.classList.toggle('closed',h); a.textContent=h?'â–¼':'â–²';
  saveSettings();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC helpers
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sync(key){
  const v = document.getElementById('s-'+key).value;
  if(key==='company'){
    document.getElementById('disp-company').textContent = v;
    document.getElementById('disp-foot-name').textContent = v.toUpperCase();
    document.getElementById('s-foot-name').value = v;
  }
  if(key==='tagline') document.getElementById('disp-tagline').textContent=v;
  if(key==='addr')    document.getElementById('disp-addr').innerHTML=v.replace(/\n/g,'<br>');
  if(key==='foot-name')    document.getElementById('disp-foot-name').textContent=v.toUpperCase();
  if(key==='foot-contact') document.getElementById('disp-foot-contact').textContent=v;
}
function syncTA(key){ document.getElementById('doc-'+key).value=document.getElementById('s-'+key).value; }

function updateCurrency(val){
  const c = val || document.getElementById('s-currency').value || 'PKR';
  ['cur1','cur2','cur3'].forEach(id=>document.getElementById(id).textContent=c);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function uploadLogo(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const img=document.getElementById('logo-display');
    img.src=ev.target.result; img.style.display='block';
    document.getElementById('logo-ph').style.display='none';
    // save logo in localStorage (base64)
    try{ localStorage.setItem('abbrol_logo', ev.target.result); } catch(e){}
  };
  r.readAsDataURL(f);
}
function removeLogo(){
  const img=document.getElementById('logo-display');
  img.src=''; img.style.display='none';
  document.getElementById('logo-ph').style.display='flex';
  document.getElementById('logo-input').value='';
  try{ localStorage.removeItem('abbrol_logo'); } catch(e){}
}
function loadLogo(){
  try{
    const src=localStorage.getItem('abbrol_logo');
    if(src){
      const img=document.getElementById('logo-display');
      img.src=src; img.style.display='block';
      document.getElementById('logo-ph').style.display='none';
    }
  } catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLUMN MANAGER â€” build drag list
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildColManager(){
  const list = document.getElementById('col-list');
  list.innerHTML='';
  COLS.forEach((col,idx)=>{
    const item = document.createElement('div');
    item.className='col-item';
    item.draggable=true;
    item.dataset.key=col.key;
    item.innerHTML=`
      <span class="drag-handle" title="Drag to reorder">â˜°</span>
      <span class="col-item-name">${col.label}</span>
      ${col.fixed ? '<span class="col-vis-badge">always on</span>' : `
      <label class="tog-switch" title="Show/Hide column">
        <input type="checkbox" ${col.visible?'checked':''} onchange="colToggleVis('${col.key}',this.checked)">
        <span class="tog-slider"></span>
      </label>`}
    `;
    // Drag events
    item.addEventListener('dragstart', e=>{ dragSrc=col.key; item.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; });
    item.addEventListener('dragend',   ()=>{ item.classList.remove('dragging'); document.querySelectorAll('.col-item').forEach(i=>i.classList.remove('drag-over')); });
    item.addEventListener('dragover',  e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; item.classList.add('drag-over'); });
    item.addEventListener('dragleave', ()=>item.classList.remove('drag-over'));
    item.addEventListener('drop',      e=>{ e.preventDefault(); item.classList.remove('drag-over'); colReorder(dragSrc, col.key); });
    list.appendChild(item);
  });
}

let dragSrc = null;
function colReorder(fromKey, toKey){
  if(fromKey===toKey) return;
  const fi = COLS.findIndex(c=>c.key===fromKey);
  const ti = COLS.findIndex(c=>c.key===toKey);
  if(fi<0||ti<0) return;
  const [moved] = COLS.splice(fi,1);
  COLS.splice(ti,0,moved);
  buildColManager();
  renderTableHeaders();
  refreshAllRows();
  saveSettings();
}

function colToggleVis(key, checked){
  const col = COLS.find(c=>c.key===key);
  if(col) col.visible=checked;
  renderTableHeaders();
  refreshAllRows();
  saveSettings();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIDTH MANAGER â€” build controls
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildWidthManager(){
  const grid=document.getElementById('width-grid');
  grid.innerHTML='';
  COLS.forEach(col=>{
    const div=document.createElement('div'); div.className='wf';
    div.innerHTML=`<label>${col.label}</label><input value="${col.width}" placeholder="auto" oninput="colSetWidth('${col.key}',this.value)">`;
    grid.appendChild(div);
  });
}

function colSetWidth(key,val){
  const col=COLS.find(c=>c.key===key);
  if(col){ col.width=val.trim()||'auto'; renderTableHeaders(); refreshAllRows(); saveSettings(); }
}

function getWidthStyle(col){
  const v=col.width;
  if(!v||v==='auto') return '';
  return isNaN(v)?v:v+'px';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER TABLE HEADERS based on COLS order/visibility
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTableHeaders(){
  const mainRow = document.getElementById('th-main-row');
  const subRow  = document.getElementById('th-sub-row');

  // Keep first # and last delete th
  // We'll rebuild the middle ths dynamically
  // Clear all except first and last children
  while(mainRow.children.length > 1) mainRow.removeChild(mainRow.lastChild);
  while(subRow.children.length  > 1) subRow.removeChild(subRow.lastChild);

  // Remove old last # th (we rebuild everything except the very first #)
  // Actually we rebuild EVERYTHING
  mainRow.innerHTML='';
  subRow.innerHTML='';

  // # column (always first)
  const thHash=document.createElement('th'); thHash.style.width='28px'; thHash.textContent='#'; mainRow.appendChild(thHash);
  const subHash=document.createElement('th'); subRow.appendChild(subHash);

  // Count visible size cols for span
  const sizeKeys=['dia','len','bore'];
  const visibleSizeCols = COLS.filter(c=>sizeKeys.includes(c.key)&&c.visible);

  let sizeGroupAdded=false;

  COLS.forEach(col=>{
    if(!col.visible) return;
    const ws=getWidthStyle(col);

    if(sizeKeys.includes(col.key)){
      // First visible size col: add the group header spanning all visible sizes
      if(!sizeGroupAdded && visibleSizeCols.length>0){
        const grp=document.createElement('th');
        grp.className='ctr'; grp.colSpan=visibleSizeCols.length;
        grp.innerHTML='Size <span style="font-size:.54rem;opacity:.4;font-weight:400">(in/mm per field)</span>';
        mainRow.appendChild(grp);
        sizeGroupAdded=true;
      }
      // Sub-header cell
      const sub=document.createElement('th');
      sub.className='ctr'; sub.textContent=col.label;
      if(ws) sub.style.width=ws;
      subRow.appendChild(sub);
    } else {
      const th=document.createElement('th');
      th.textContent=col.label;
      if(col.key==='amount'||col.key==='weight'||col.key==='qty'||col.key==='rate') th.className='rgt';
      if(ws) th.style.width=ws;
      mainRow.appendChild(th);
      // placeholder in sub-row
      const subPh=document.createElement('th'); subRow.appendChild(subPh);
    }
  });

  // Delete column
  const thDel=document.createElement('th'); thDel.style.width='22px'; mainRow.appendChild(thDel);
  const subDel=document.createElement('th'); subRow.appendChild(subDel);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROW BUILDING & MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let rc=0;

function makeSizeCell(){
  const wrap=document.createElement('div'); wrap.className='size-td';
  const inp=document.createElement('input'); inp.type='text'; inp.placeholder='â€”';
  let unit='in';
  const lbl=document.createElement('span'); lbl.className='unit-label'; lbl.textContent='in';
  const tog=document.createElement('div'); tog.className='unit-toggle';
  const bIn=document.createElement('button'); bIn.textContent='in'; bIn.type='button'; bIn.className='active';
  const bMm=document.createElement('button'); bMm.textContent='mm'; bMm.type='button';
  function setUnit(u){ unit=u; lbl.textContent=u; bIn.classList.toggle('active',u==='in'); bMm.classList.toggle('active',u==='mm'); }
  bIn.onclick=()=>setUnit('in'); bMm.onclick=()=>setUnit('mm');
  tog.appendChild(bIn); tog.appendChild(bMm);
  wrap.appendChild(inp); wrap.appendChild(tog); wrap.appendChild(lbl);
  return wrap;
}

function buildRowCells(n){
  // Returns an object: key â†’ <td>
  const cells={};
  const sizeKeys=['dia','len','bore'];

  // serial
  const tdN=document.createElement('td');
  tdN.style.cssText='color:#aaa;text-align:center;font-size:.7rem;width:28px'; tdN.textContent=n;
  cells['#']=tdN;

  // desc
  const tdD=document.createElement('td'); tdD.dataset.col='desc';
  const inpD=document.createElement('input'); inpD.type='text'; inpD.placeholder='e.g. Centrifugal Roll â€“ SG Iron'; inpD.style.width='100%'; tdD.appendChild(inpD);
  cells['desc']=tdD;

  // size cells
  sizeKeys.forEach(k=>{
    const td=document.createElement('td'); td.dataset.col=k; td.appendChild(makeSizeCell()); cells[k]=td;
  });

  // weight
  const tdW=document.createElement('td'); tdW.dataset.col='weight';
  const inpW=document.createElement('input'); inpW.type='number'; inpW.className='weight'; inpW.value='0'; inpW.min='0'; inpW.step='0.001'; inpW.oninput=calcTotals; inpW.style.width='100%'; tdW.appendChild(inpW);
  cells['weight']=tdW;

  // qty
  const tdQ=document.createElement('td'); tdQ.dataset.col='qty';
  const inpQ=document.createElement('input'); inpQ.type='number'; inpQ.className='qty'; inpQ.value='1'; inpQ.min='0'; inpQ.oninput=calcTotals; inpQ.style.width='100%'; tdQ.appendChild(inpQ);
  cells['qty']=tdQ;

  // unit
  const tdU=document.createElement('td'); tdU.dataset.col='unit';
  const sel=document.createElement('select'); sel.style.cssText='width:100%;border:none;background:transparent;font-family:Barlow,sans-serif;font-size:.76rem;color:var(--iron);outline:none';
  ['Pcs','Kg','MT','Set','Lot'].forEach(u=>{const o=document.createElement('option');o.textContent=u;sel.appendChild(o);}); tdU.appendChild(sel);
  cells['unit']=tdU;

  // rate
  const tdR=document.createElement('td'); tdR.dataset.col='rate';
  const inpR=document.createElement('input'); inpR.type='number'; inpR.className='rate'; inpR.value='0'; inpR.min='0'; inpR.step='0.01'; inpR.oninput=calcTotals; inpR.style.width='100%'; tdR.appendChild(inpR);
  cells['rate']=tdR;

  // amount
  const tdA=document.createElement('td'); tdA.dataset.col='amount'; tdA.className='tc'; tdA.textContent='0.00';
  cells['amount']=tdA;

  // delete
  const tdX=document.createElement('td');
  const btnX=document.createElement('button'); btnX.className='del-btn'; btnX.textContent='âœ•'; btnX.onclick=()=>delRow(n); tdX.appendChild(btnX);
  cells['delete']=tdX;

  return cells;
}

function renderRow(tr, n){
  // Rebuild TDs in COLS order, respecting visibility
  const cells = tr._cells || buildRowCells(n);
  tr._cells = cells;
  // Clear row
  while(tr.firstChild) tr.removeChild(tr.firstChild);
  // Always add #
  tr.appendChild(cells['#']);
  // Add in COLS order
  COLS.forEach(col=>{
    const td=cells[col.key];
    if(!td) return;
    td.style.display = col.visible?'':'none';
    const ws=getWidthStyle(col); if(ws) td.style.width=ws; else td.style.width='';
    tr.appendChild(td);
  });
  // Always add delete last
  tr.appendChild(cells['delete']);
}

function addRow(){
  rc++;
  const n=rc;
  const tr=document.createElement('tr'); tr.id='r'+n;
  tr._cells=buildRowCells(n);
  renderRow(tr,n);
  document.getElementById('items-body').appendChild(tr);
  calcTotals();
}

function delRow(n){ const el=document.getElementById('r'+n); if(el) el.remove(); calcTotals(); }

function refreshAllRows(){
  // Re-render each row in the new column order
  document.querySelectorAll('#items-body tr').forEach(tr=>{
    if(tr._cells){
      const n=parseInt(tr.id.replace('r',''));
      renderRow(tr,n);
    }
  });
  calcTotals();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(n){ return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function calcTotals(){
  let sub=0;
  document.querySelectorAll('#items-body tr').forEach(tr=>{
    const w=parseFloat(tr.querySelector('.weight')?.value||0);
    const q=parseFloat(tr.querySelector('.qty')?.value||0);
    const r=parseFloat(tr.querySelector('.rate')?.value||0);
    const amt=w*q*r;
    const tc=tr.querySelector('.tc'); if(tc) tc.textContent=fmt(amt);
    sub+=amt;
  });
  const disc=parseFloat(document.getElementById('discount').value||0);
  const tax =parseFloat(document.getElementById('tax').value||0);
  const aD=sub*(1-disc/100); const aT=aD*(1+tax/100);
  document.getElementById('subtotal').textContent=fmt(sub);
  document.getElementById('after-tax').textContent=fmt(aT);
  document.getElementById('grand-total').textContent=fmt(aT);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET FORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function resetForm(){
  if(!confirm('Clear all items and customer info? (Settings and column config are kept)')) return;
  document.getElementById('items-body').innerHTML='';
  rc=0; document.getElementById('customer-name').value='';
  document.getElementById('quote-ref').value='AST-2026-001';
  addRow(); addRow(); addRow();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const today=new Date();
const fmtD=d=>d.toISOString().split('T')[0];
document.getElementById('meta-date').value=fmtD(today);
const vd=new Date(today); vd.setDate(vd.getDate()+30);
document.getElementById('meta-valid').value=fmtD(vd);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT â€” load saved settings, build UI, add rows
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function init(){
  const s = loadSettings();
  COLS = s.cols; // use saved order/visibility

  applySettingsToInputs(s);
  applySettingsToDoc(s);
  loadLogo();

  // Panel open state
  if(!s.panelOpen){
    document.getElementById('sbody').classList.add('hide');
    document.getElementById('sarr').textContent='â–¼';
    document.getElementById('sarr').classList.add('closed');
  }

  // Build col manager & widths
  buildColManager();
  buildWidthManager();

  // Render headers then initial rows
  renderTableHeaders();
  addRow(); addRow(); addRow();
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF DOWNLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function downloadPDF(){
  const panel=document.getElementById('settings-panel');
  const addBtn=document.querySelector('.add-btn');
  const delBtns=document.querySelectorAll('.del-btn');
  const togs=document.querySelectorAll('.unit-toggle');
  const lbls=document.querySelectorAll('.unit-label');

  panel.style.display='none'; addBtn.style.display='none';
  delBtns.forEach(b=>b.style.display='none');
  togs.forEach(t=>t.style.display='none');
  lbls.forEach(l=>l.style.display='inline');

  try{
    const el=document.getElementById('quote-doc');
    const canvas=await html2canvas(el,{scale:2,useCORS:true,backgroundColor:'#f5f2ee'});
    const img=canvas.toDataURL('image/png');
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const pw=pdf.internal.pageSize.getWidth(), ph=pdf.internal.pageSize.getHeight();
    const ih=canvas.height*pw/canvas.width;
    if(ih<=ph){ pdf.addImage(img,'PNG',0,0,pw,ih); }
    else { let y=0; while(y<ih){ pdf.addImage(img,'PNG',0,-y,pw,ih); y+=ph; if(y<ih) pdf.addPage(); } }
    const co=(document.getElementById('s-company').value||'Quote').replace(/\s+/g,'_');
    const ref=document.getElementById('quote-ref').value||'QT';
    pdf.save(`${co}_${ref}.pdf`);
  } finally {
    panel.style.display=''; addBtn.style.display='';
    delBtns.forEach(b=>b.style.display='');
    togs.forEach(t=>t.style.display='');
    lbls.forEach(l=>l.style.display='none');
  }
}
</script>
</body>
</html>
